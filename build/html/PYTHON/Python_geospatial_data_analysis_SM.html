

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Python geospatial data analysis &mdash; Spatial Ecology&#39;s code documentation 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css?v=572af1d6" />
      <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="RasterIO for dummies: a brief intro to a pythonic raster library" href="RasterIO_Intro.html" />
    <link rel="prev" title="Python data analysis" href="Python_data_analysis_SM.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Spatial Ecology's code documentation
              <img src="../_static/SE_compact.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">COURSE TRAINERS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../COURSETRAINERS/trainers.html">Spatial Ecology course trainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">COURSES AROUND THE WORLD</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_wcsu_02-04_2021.html">Western Connecticut State University 2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_stock_uni_04-05_2021.html">Stockholm University 2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_ml_04-05_2022.html">GeoComp &amp; ML 2022 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_modelling_10-11_2022.html">GeoComp &amp; Modelling 2022 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_ml_04-05_2023.html">GeoComp &amp; ML 2023 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_ml_04-05_2024.html">GeoComp &amp; ML 2024 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_GEO-OPEN-HACK-2024_06_2024.html">GEO-OPEN-HACK-2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_11-12_2024.html">GeoComp 2024 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_geoanlysis_04_2025.html">Geo Comp/Analysis 2025 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_ml_09-11_2025.html">GeoComp &amp; ML 2025 course</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GEO DATA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../GEODATA/geomorpho90m/geomorpho90m.html">Geomorpho90m: technical documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">LINUX VIRTUAL MACHINE</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../VIRTUALMACHINE/Setting_Ubuntu24.04_for_Spatial_Ecology_course.html">Prepare Ubuntu 24.04 for Spatial Ecology courses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VIRTUALMACHINE/Setting_Colab_for_Spatial_Ecology_course.html">Prepare Colab for Spatial Ecology courses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VIRTUALMACHINE/Setting_OSGeoLive_for_Spatial_Ecology_course.html">Prepare OSGeoLive for Spatial Ecology courses</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WEB SEMINARS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../WEBSEMINAR/webseminar.html">Raster/Vector Processing using GDAL/OGR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WEBSEMINAR/webseminar.html#image-processing-using-pktools">Image Processing using Pktools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WEBSEMINAR/webseminar.html#introduction-to-grass-gis">Introduction to GRASS GIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WEBSEMINAR/webseminar.html#geocomputation-with-high-performance-computing">GeoComputation with High Performance Computing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">BASH</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../BASH/bashintro_osgeo.html">Linux Operation System as a base for Spatial Ecology Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BASH/bashinter_osgeo.html">Manipulate text files in bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BASH/bashxargs_osgeo.html">Multi-core bash</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AWK</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../AWK/awk.html">AWK Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GDAL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../GDAL/gdal_osgeo.html">Use GDAL/OGR for raster/vector operations - osgeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GDAL/gdal_colab.html">Use GDAL/OGR for raster/vector operations - colab</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PKTOOLS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pktools_osgeo.html">Use PKTOOLS for raster/vector operations - osgeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pktools_colab.html">Use PKTOOLS for raster/vector operations - colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pyjeo_introduction1.html">Introduction to pyjeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pyjeo_introduction2.html">pyjeo: an open source image processing library in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pyjeo_pktools.html">Performing raster and vector operations in Python using pyjeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pyjeo_upscaling_surf.html">Scaling-up: batch processing on the cluster with pyjeo</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">R</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../R/R_Intro.html">R Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PYTHON</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="PythonEnvs.html">Python environments or how to survive to your journey in the geodata space</a></li>
<li class="toctree-l1"><a class="reference internal" href="Python_Intro.html">Introduction to Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="Geo_Python.html">Python &amp; GeoComputation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Python_data_analysis_SM.html">Python data analysis</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Python geospatial data analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Lesson-Overview">Lesson Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Objectives">Objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Table-of-Contents">Table of Contents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Jupyterlab-setup-and-libraries-retrieving-[Just-for-UBUNTU-24.04]">Jupyterlab setup and libraries retrieving <strong>[Just for UBUNTU 24.04]</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#Open-the-notebook-lesson">Open the notebook lesson</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Library-dependencies-fixing-[Just-for-OSGEOLIVE16]">Library dependencies fixing <strong>[Just for OSGEOLIVE16]</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#1---Matplotlib-and-Seaborn-for-Scientific-Plots"><strong>1 - Matplotlib and Seaborn for Scientific Plots</strong></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Introduction-to-Matplotlib">Introduction to Matplotlib</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Seaborn:-Enhanced-Data-Visualization"><strong>Seaborn: Enhanced Data Visualization</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#2---Rasterio-for-Raster-Processing-and-Visualization"><strong>2 - Rasterio for Raster Processing and Visualization</strong></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Reading-and-Inspecting-Rasters">Reading and Inspecting Rasters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Raster-Manipulation-and-Filtering">Raster Manipulation and Filtering</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Composite-Raster-Processing">Composite Raster Processing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#3---Geopandas-for-Vector-Processing-and-Visualization"><strong>3 - Geopandas for Vector Processing and Visualization</strong></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Introduction-to-Vector-Files-and-Their-Types">Introduction to Vector Files and Their Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Importing-Vector-Files-with-Geopandas">Importing Vector Files with Geopandas</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#4---Exercise"><strong>4 - Exercise</strong></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Spatial-Data-Visualization-and-Analysis">Spatial Data Visualization and Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Input"><strong>Input</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#Operations:"><strong>Operations:</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#Output"><strong>Output</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="RasterIO_Intro.html">RasterIO for dummies: a brief intro to a <em>pythonic</em> raster library</a></li>
<li class="toctree-l1"><a class="reference internal" href="RasterIO_Intro.html#2.-Preparing-the-dataset-for-next-ML-exercises-via-rasterio">2. Preparing the dataset for next ML exercises via rasterio</a></li>
<li class="toctree-l1"><a class="reference internal" href="RasterIO_Intro.html#3.-Beyond-the-basics">3. Beyond the basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="OGCSQL.html">Generalities about OGC Geospatial extensions for SQL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GRASS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_intro.html">GRASS Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_newproject.html">Start a new GRASS project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_hydro.html">Using GRASS for stream-network extraction and basins delineation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_hydro_osboxes.html">Using GRASS for stream-network extraction and basins delineation - osboxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_hydro_colab.html">Using GRASS for stream-network extraction and basins delineation in Colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/SDM1_MWood_gecomp4GRASS.html">SDM1 : Montane woodcreper - Gecomputation for the Random Forest model using GRASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/SDM1_MWood_GRASSmodel.html">SDM1 : Montane woodcreper - Random Forest Model using GRASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HIGH PERFORMANCE COMPUTING</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../HPC/hpc_setting.html">Geocomputation at High Performance Computing Cluster (HPC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HPC/hpc_setting_grass.html">Use of GRASS in HPC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ASSIGNMENTS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ASSIGNMENTS/assignment_fall2022_solutions.html">Assignments Fall 2022</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CASE STUDY</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/SDM1_MWood_gecomp.html">SDM1 : Montane woodcreper - Gecomputation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/SDM1_MWood_Rmodel.html">SDM1 : Montane woodcreper - Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/SDM1_MWood_gecomp4GRASS.html">SDM1 : Montane woodcreper - Gecomputation for the Random Forest model using GRASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/SDM1_MWood_GRASSmodel.html">SDM1 : Montane woodcreper - Random Forest Model using GRASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/SDM2_Vath_Rmodel.html">SDM2 : Varied Thrush - Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/manipulate_GSIM.html">Manipulate GSIM files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Data_type_GTiff.html">Data type in GTiff</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/temporal_interpolation.html">Temporal interpolation of landsat images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/DTW.html">Dynamic Time Warping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/pred_NP.html">Estimating nitrogen and phosphorus concentrations in streams and rivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/NN-day1.html">Estimating nitrogen concentrations in streams and rivers using NN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/NN-day2.html">Autoencoder (AE), Variational Autoencoder (VAE) and Generative Adversarial Network (GAN)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/NN-day3.html">LSTM Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_01DataExplore.html">Estimation of tree height using GEDI dataset - Data explore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_02Predictors_extraction.html">Estimation of tree height using GEDI dataset - Predictors extraction at point location</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_03RF_pred_SM.html">Estimation of tree height using GEDI dataset - Random Forest prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_04SVM_pred_2022.html">Estimation of tree height using GEDI dataset - Support Vector Machine for Regression (SVR) - 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_04SVM_pred_2023.html">Estimation of tree height using GEDI dataset - Support Vector Machine for Regression (SVR) - 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_04SVM_pred_2024.html">Estimation of tree height using GEDI dataset - Support Vector Machine for Regression (SVR) - 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_04SVM_pred_2024.html#Exercise:-explore-the-other-parameters-offered-by-the-SVM-library-and-try-to-make-the-model-better.-Some-suggestions:">Exercise: explore the other parameters offered by the SVM library and try to make the model better. Some suggestions:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_05Perceptron_pred_2022.html">Estimation of tree height using GEDI dataset - Perceptron 1 - 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_05Perceptron_intro_2023.html">Estimation of tree height using GEDI dataset - Perceptron 1 - 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_05Perceptron_intro_2024.html">Estimation of tree height using GEDI dataset - Perceptron - 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_06Perceptron_pred_2023.html">Estimation of tree height using GEDI dataset - Perceptron tree prediction - 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_06Perceptron_complete_2024.html">Estimation of tree height using GEDI dataset - Perceptron complete - 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_05Perceptron_pred_clean_2022.html">Estimation of tree height using GEDI dataset - Clean Data - Perceptron 2 - 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_06NeuralNets_pred.html">Estimation of tree height using GEDI dataset - Neural Network 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Tree_Height_07FeedForward_Networks_2024.html">Estimation of tree height using GEDI dataset - Neural Network 1 - 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/NNs_pt3_SHAP.html">Neural Nets (pt.3), Interpretability and Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/CNN_satelite_2022.html">Using Multi-layer Perceptron and Convolutional Neural Networks for Satellite image classification - 2022.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/CNN_satelite_2023.html">Using Multi-layer Perceptron and Convolutional Neural Networks for Satellite image classification - 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/CNN_satelite_2023.html#Using-CNNs-for-a-image-dataset">Using CNNs for a image dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/foundation_model_IIASA2024.html">Prithvi 100M model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/foundation_model_IIASA2024.html#Proposed-exercises">Proposed exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/NN_Unsupervised_2024.html">Autoencoder (AE), Variational Autoencoder (VAE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/NN_Unsupervised_2024.html#Implementing-an-Autoencoder">Implementing an Autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/NN_Unsupervised_2024.html#Autoencoding-MNIST">Autoencoding MNIST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/NN_Unsupervised_2024.html#Section-2">Section 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/NN_Unsupervised_2024.html#Section-3---Generative-Models">Section 3 - Generative Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/LSTMs_tutorial.html">Using LSTM for time-series predictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/CNN_satelite_with_GPT_code_2023.html">Using GPT to implement a Convolutional Neural Networks for Satellite image classification.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/Classification_pyjeo_sklearn_2023.html">Classification in Python using pyjeo and sklearn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CASESTUDY/GEEviaPython_2023.html">Google Earth Engine use via Python, containers and other mythical beasts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Students Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../STUDENTSPROJECTS/index.html">1. 2021 SWEDEN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../STUDENTSPROJECTS/index.html#matera">2. 2022 MATERA</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">OUTDOOR</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../OUTDOOR/outdoor_orientering.html">Do not get lost in the wilderness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OUTDOOR/outdoor_info.html">Shelter locations close to Gioia del Colle (BA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OUTDOOR/bike_accomodation.html">Accomodation in Gioia del Colle (BA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OUTDOOR/puglia_discover.html">Discover Puglia by bike!</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TALKS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../TALKS/intelligent_modelling.html">Intelligent modelling in time and space: combine GeoComputation and Machine Learning for  environmental application.</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ADMIN</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ADMIN/00_pktools_gdrive_install.html">Install pktools on the gdrive and be able to use from any Colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ADMIN/video.html">Video tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ADMIN/Compiling_OTB.html">Compiling OTB from source</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Spatial Ecology's code documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">&lt;no title&gt;</a></li>
      <li class="breadcrumb-item active">Python geospatial data analysis</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/PYTHON/Python_geospatial_data_analysis_SM.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <hr class="docutils" />
<section id="Python-geospatial-data-analysis">
<h1>Python geospatial data analysis<a class="headerlink" href="#Python-geospatial-data-analysis" title="Link to this heading"></a></h1>
<p>Saverio Mancino</p>
<hr class="docutils" />
<section id="Lesson-Overview">
<h2>Lesson Overview<a class="headerlink" href="#Lesson-Overview" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">This lesson is designed to provide a comprehensive exploration of scientific data visualization and geospatial data processing using Python.</div>
<div class="line">In this lesson you will learn how to:</div>
</div>
<ul class="simple">
<li><p>Create and customize scientific plots using Matplotlib and Seaborn;</p></li>
<li><p>Process, analyze, and visualize raster data with Rasterio;</p></li>
<li><p>Manage and visualize vector data using Geopandas.</p></li>
</ul>
</section>
<section id="Objectives">
<h2>Objectives<a class="headerlink" href="#Objectives" title="Link to this heading"></a></h2>
<p>By the end of this lesson, you should be able to:</p>
<ul class="simple">
<li><p>Build and customize scientific plots using Matplotlib and Seaborn;</p></li>
<li><p>Process and visualize raster datasets using Rasterio;</p></li>
<li><p>Handle vector data and perform spatial analysis with Geopandas;</p></li>
<li><p>Apply advanced visualization and geospatial processing techniques;</p></li>
<li><p>Complete practical exercises to reinforce your learning</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="Table-of-Contents">
<h2>Table of Contents<a class="headerlink" href="#Table-of-Contents" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Matplotlib and Seaborn for Scientific Plots</p></li>
<li><p>Rasterio for Raster Processing and Visualization</p></li>
<li><p>Geopandas for Vector Processing and Visualization</p></li>
<li><p>Exercises</p></li>
</ol>
<hr class="docutils" />
</section>
<section id="Jupyterlab-setup-and-libraries-retrieving-[Just-for-UBUNTU-24.04]">
<h2>Jupyterlab setup and libraries retrieving <strong>[Just for UBUNTU 24.04]</strong><a class="headerlink" href="#Jupyterlab-setup-and-libraries-retrieving-[Just-for-UBUNTU-24.04]" title="Link to this heading"></a></h2>
<p>To run this lesson properly on osboxes.org you need to have a clean install of jupyterlab using the command line. If you didn’t do it for the previous lesson (Python data analysis), do it for this one, directly on the terminal:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pipx uninstall jupyterlab
pipx install --system-site-packages jupyterlab
</pre></div>
</div>
<p>and just after that, you can procede to install python libraries, using the apt install always in the terminal:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo apt install python3-numpy python3-pandas python3-sklearn python3-matplotlib python3-rasterio python3-geopandas python3-seaborn python3-skimage
</pre></div>
</div>
</section>
<section id="Open-the-notebook-lesson">
<h2>Open the notebook lesson<a class="headerlink" href="#Open-the-notebook-lesson" title="Link to this heading"></a></h2>
<p>Open the lesson using the CL</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd /media/sf_LVM_shared/my_SE_data/exercise
jupyter-lab Python_geospatial_data_analysis_SM.ipynb
</pre></div>
</div>
</section>
<section id="Library-dependencies-fixing-[Just-for-OSGEOLIVE16]">
<h2>Library dependencies fixing <strong>[Just for OSGEOLIVE16]</strong><a class="headerlink" href="#Library-dependencies-fixing-[Just-for-OSGEOLIVE16]" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">Let’s check all dependency compatibilities between <code class="docutils literal notranslate"><span class="pre">numpy</span></code> <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> <code class="docutils literal notranslate"><span class="pre">seaborn</span></code> <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> <code class="docutils literal notranslate"><span class="pre">fiona</span></code> <code class="docutils literal notranslate"><span class="pre">scipy</span></code> <code class="docutils literal notranslate"><span class="pre">shapely</span></code> and <code class="docutils literal notranslate"><span class="pre">pyproj</span></code>.</div>
<div class="line">We need to make sure to use the intercompatible version of each library.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>show<span class="w"> </span>numpy<span class="w"> </span>pandas<span class="w"> </span>matplotlib<span class="w"> </span>seaborn<span class="w"> </span>rasterio<span class="w"> </span>fiona<span class="w"> </span>shapely<span class="w"> </span>pyproj<span class="w"> </span>scipy<span class="w"> </span>scikit-image<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Version:
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Version: 1.26.4
Version: 2.1.4+dfsg
Version: 3.6.3
Version: 0.13.2
Version: 1.3.9
Version: 1.9.5
Version: 2.0.3
Version: 3.6.1
Version: 1.11.4
Version: 0.22.0
</pre></div></div>
</div>
<p>Run this command in the terminal, to remove the version of <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> installed via the operating system’s package manager (APT) instead of with PIP.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo apt remove python3-matplotlib
</pre></div>
</div>
<p>Them procede to reinstall from scratch all libraries:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>!pip uninstall -y numpy pandas matplotlib seaborn rasterio fiona shapely pyproj scipy
</pre></div>
</div>
<p>and then installing the right version to avoid libraries dependencies conflicts:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>!pip install --user numpy==1.26.4
!pip install --user shapely==1.8.5
!pip install --user scipy==1.15.0
!pip install --user pandas matplotlib seaborn rasterio fiona pyproj
!pip install --upgrade --force-reinstall pandas matplotlib seaborn rasterio fiona pyproj
</pre></div>
</div>
<p>In the end you can check all libraries versions</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>show<span class="w"> </span>numpy<span class="w"> </span>pandas<span class="w"> </span>matplotlib<span class="w"> </span>seaborn<span class="w"> </span>rasterio<span class="w"> </span>fiona<span class="w"> </span>shapely<span class="w"> </span>pyproj<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>Version:
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Version: 1.26.4
Version: 2.1.4+dfsg
Version: 3.6.3
Version: 0.13.2
Version: 1.3.9
Version: 1.9.5
Version: 2.0.3
Version: 3.6.1
</pre></div></div>
</div>
</section>
<section id="1---Matplotlib-and-Seaborn-for-Scientific-Plots">
<h2><strong>1 - Matplotlib and Seaborn for Scientific Plots</strong><a class="headerlink" href="#1---Matplotlib-and-Seaborn-for-Scientific-Plots" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">Data visualization is a crucial aspect of scientific computing, allowing researchers to explore, analyze, and communicate insights from data.</div>
<div class="line">Python provides powerful libraries for visualization, with <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> and <code class="docutils literal notranslate"><span class="pre">seaborn</span></code> being two of the most widely used.</div>
</div>
<ul class="simple">
<li><p><strong>Matplotlib</strong>: A low-level library that provides detailed control over plot elements.</p></li>
<li><p><strong>Seaborn</strong>: Built on top of Matplotlib, Seaborn simplifies complex visualizations and adds aesthetically pleasing statistical plots.</p></li>
</ul>
<section id="Introduction-to-Matplotlib">
<h3>Introduction to Matplotlib<a class="headerlink" href="#Introduction-to-Matplotlib" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> is a comprehensive library for creating static, animated, and interactive visualizations in Python.</div>
<div class="line">It provides a MATLAB-like interface and is widely used for generating plots such as line graphs, scatter plots, bar charts, and more.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># Generate some data</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
<span class="n">x3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>

<span class="c1"># Create a basic line plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;sin(x)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;cos(x)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;tan(x)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X Axis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y Axis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Basic Line Plot of sin(x)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_11_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_11_0.png" />
</div>
</div>
<div class="line-block">
<div class="line">For any kind of plot, besides visualization you can also save the result to disk.</div>
<div class="line">You just need to replace: &gt;plt.show()</div>
</div>
<p>with</p>
<blockquote>
<div><div class="line-block">
<div class="line">plt.savefig(‘plot_name.png’, dpi=300) # Saves the plot as a PNG with 300 DPI resolution</div>
<div class="line">plt.close()</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">Now let’s try plotting something based on the dataset we downloaded and used in the previous lesson.</div>
<div class="line">We can try plotting time/temperature diagram.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Read data</span>
<span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;files/Dati_Meteo_Giornalieri_Stazione _Matera.csv&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>DATA</th>
      <th>TM</th>
      <th>UM</th>
      <th>VVM</th>
      <th>PRE</th>
      <th>RSM</th>
      <th>PATM</th>
      <th>QA PS PM</th>
      <th>QA PG PM</th>
      <th>ORA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>03/12/2021</td>
      <td>7,420</td>
      <td>95,300</td>
      <td>2,750</td>
      <td>0,250</td>
      <td>24,6</td>
      <td>951</td>
      <td>0,500</td>
      <td>0,150</td>
      <td>12:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>04/12/2021</td>
      <td>9,490</td>
      <td>72,600</td>
      <td>3,590</td>
      <td>0,000</td>
      <td>35,9</td>
      <td>957</td>
      <td>0,530</td>
      <td>0,000</td>
      <td>12:00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>05/12/2021</td>
      <td>11,900</td>
      <td>79,900</td>
      <td>3,970</td>
      <td>0,000</td>
      <td>38,4</td>
      <td>952</td>
      <td>0,040</td>
      <td>0,010</td>
      <td>12:00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>06/12/2021</td>
      <td>7,400</td>
      <td>85,800</td>
      <td>2,120</td>
      <td>0,000</td>
      <td>185,0</td>
      <td>947</td>
      <td>0,000</td>
      <td>0,000</td>
      <td>12:00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>07/12/2021</td>
      <td>6,480</td>
      <td>72,900</td>
      <td>4,980</td>
      <td>0,000</td>
      <td>320,0</td>
      <td>952</td>
      <td>0,140</td>
      <td>0,100</td>
      <td>12:00</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>200</th>
      <td>05/08/2022</td>
      <td>33,500</td>
      <td>21,200</td>
      <td>1,670</td>
      <td>0,000</td>
      <td>794,0</td>
      <td>960</td>
      <td>1,020</td>
      <td>0,900</td>
      <td>12:00</td>
    </tr>
    <tr>
      <th>201</th>
      <td>06/08/2022</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>12:00</td>
    </tr>
    <tr>
      <th>202</th>
      <td>07/08/2022</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>12:00</td>
    </tr>
    <tr>
      <th>203</th>
      <td>08/08/2022</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>ND</td>
      <td>12:00</td>
    </tr>
    <tr>
      <th>204</th>
      <td>10/08/2022</td>
      <td>27,100</td>
      <td>53,500</td>
      <td>4,400</td>
      <td>0,000</td>
      <td>533,0</td>
      <td>961,0</td>
      <td>1,370</td>
      <td>1,500</td>
      <td>12:00</td>
    </tr>
  </tbody>
</table>
<p>205 rows × 10 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Data preparation</span>
<span class="c1"># Convert date column in dd/mm/yyyy format</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span><span class="p">)</span>

<span class="c1"># Convert average temperature &#39;TM&#39;</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;,&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="p">},</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Force the replace of digital separator commas with dots</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>  <span class="c1"># Convert to numeric, invalid parsing will be set to NaN</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="c1"># set the graph size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;DATA&#39;</span><span class="p">],</span><span class="c1"># x axis</span>
         <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">],</span> <span class="c1"># y axis</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="c1"># line color</span>
         <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="c1"># point marker</span>
         <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="c1"># line style</span>
         <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="c1"># line size</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span> <span class="c1"># visibility</span>
         <span class="p">)</span>

<span class="c1"># Labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Date\n (YYYY\MM)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Temperature</span><span class="se">\n</span><span class="s2"> (°C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Location: Matera (IT)</span><span class="se">\n</span><span class="s2"> Graph: Daily Temperature (12:00 AM GMT+1)</span><span class="se">\n</span><span class="s2"> Time range: 12/2021 - 08/2022&quot;</span><span class="p">)</span>

<span class="c1"># Grid improvements</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_15_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_15_0.png" />
</div>
</div>
<div class="line-block">
<div class="line">We can also represent data with other types of graphs.</div>
<div class="line">Let’s represent Matera Temperature distibution with a histogram.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Histogram settings</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span> <span class="c1"># set the graph size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">],</span> <span class="c1"># data</span>
         <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1"># number of bins</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="c1"># bar color</span>
         <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="c1"># bar edges color</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span> <span class="c1"># visibility</span>
         <span class="p">)</span>
<span class="c1"># Labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature</span><span class="se">\n</span><span class="s2"> (°C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Location: Matera (IT)\n Graph: Temperature Distribution\n Time range: 12/2021 - 08/2022&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_17_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_17_0.png" />
</div>
</div>
<p>And a scatter plot of Matera Temperature vs Humidity.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Scatter Plot - Temperature vs Humidity</span>
<span class="c1">#Scatter plots show relationships between two variables.</span>
<span class="c1"># Convert average temperature &#39;TM&#39;</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;,&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="p">},</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Force the replace of digital separator commas with dots</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>  <span class="c1"># Convert to numeric, invalid parsing will be set to NaN</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">14</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">],</span> <span class="c1"># x axis</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">],</span> <span class="c1"># y axis</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="c1"># transparency</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span> <span class="c1"># dot color</span>
            <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature</span><span class="se">\n</span><span class="s2"> (°C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Humidity</span><span class="se">\n</span><span class="s2"> (%)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Location: Matera (IT)</span><span class="se">\n</span><span class="s2"> Graph: Temperature vs Humidity</span><span class="se">\n</span><span class="s2"> Time range: 12/2021 - 08/2022&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_19_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_19_0.png" />
</div>
</div>
</section>
</section>
<section id="Seaborn:-Enhanced-Data-Visualization">
<h2><strong>Seaborn: Enhanced Data Visualization</strong><a class="headerlink" href="#Seaborn:-Enhanced-Data-Visualization" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Seaborn</span></code> is based on <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, but provides more fancy and informative visualizations.</div>
<div class="line">We can represent a similar histogram of Matera Temperature distibution but enhanced with a trend curve obtained with a Kernel Density Estimation.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">],</span> <span class="c1">#data</span>
             <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="c1"># bins</span>
             <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># Kernel Density Estimation</span>
             <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="c1"># bar edges color</span>
             <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span> <span class="c1"># bar color</span>
             <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Location: Matera (IT)</span><span class="se">\n</span><span class="s2"> Graph: Temperature Distribution with KDE trend (Seaborn)</span><span class="se">\n</span><span class="s2"> Time range: 12/2021 - 08/2022&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature</span><span class="se">\n</span><span class="s2"> (°C)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_21_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_21_0.png" />
</div>
</div>
<div class="line-block">
<div class="line">We can plot also other particular grapgh.</div>
<div class="line">For instance boxplots are useful for summarize the distribution of a variable and highlight outliers.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Seaborn boxplots</span>
<span class="c1"># Boxplots can summarize the distribution of a variable and highlight outliers</span>

<span class="c1"># Create a two side boxplot figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Temperature boxplot</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;TM&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Temperature</span><span class="se">\n</span><span class="s2"> (°C)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Boxplot of Temperature (Seaborn)&quot;</span><span class="p">)</span>

<span class="c1"># Umidity Boxplot</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Humidity</span><span class="se">\n</span><span class="s2"> (%)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Boxplot of Humidity (Seaborn)&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_23_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_23_0.png" />
</div>
</div>
<div class="line-block">
<div class="line">Here is an example of a Climate Heatmap done again with <code class="docutils literal notranslate"><span class="pre">Seaborn</span></code> to show the variation of monthly average temperatures in different cities.</div>
<div class="line">For this example, we use some randomly generated temperature data for five Italian cities, to create a colored Heatmap with the average monthly temperatures.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate random climate data (average monthly temperatures in different cities)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;City&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Roma&#39;</span><span class="p">,</span> <span class="s1">&#39;Milano&#39;</span><span class="p">,</span> <span class="s1">&#39;Napoli&#39;</span><span class="p">,</span> <span class="s1">&#39;Torino&#39;</span><span class="p">,</span> <span class="s1">&#39;Palermo&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Jan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="c1"># random T°C between 0 and 10, for 5 times as the number of the columns</span>
    <span class="s1">&#39;Feb&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;Mar&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;Apr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;May&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;Jun&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;Jul&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;Aug&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;Sep&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;Oct&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;Nov&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;Dec&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># DataFrame creation</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Heatmap Creation</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">)</span> <span class="c1"># fmt=&quot;d&quot; sets the format as integer with no decimals</span>

<span class="c1"># Title and labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Average Monthly Temperatures (°C) in Different Italian Cities.&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cities&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Months&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_25_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_25_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;penguins&quot;</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">JointGrid</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;body_mass_g&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;bill_depth_mm&quot;</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span>
             <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="p">((</span><span class="mi">2200</span><span class="p">,</span> <span class="mi">6800</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">)),</span>
             <span class="n">thresh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rocket&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">plot_marginals</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#03051A&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;seaborn.axisgrid.JointGrid at 0x7ccde99cf3e0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_26_1.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_26_1.png" />
</div>
</div>
</section>
<section id="2---Rasterio-for-Raster-Processing-and-Visualization">
<h2><strong>2 - Rasterio for Raster Processing and Visualization</strong><a class="headerlink" href="#2---Rasterio-for-Raster-Processing-and-Visualization" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">Now we’ll explore <code class="docutils literal notranslate"><span class="pre">Rasterio</span></code>, a powerful Python library designed for efficient reading, writing, and processing of geospatial raster data.</div>
<div class="line">We will focus on raster processing, spatial filtering, and visualization techniques.</div>
</div>
<p><img alt="Numpy" src="https://user-images.githubusercontent.com/53001455/226302342-f88b4bb8-7a4b-4888-abba-b330bd98e26f.png" /></p>
<section id="Introduction">
<h3>Introduction<a class="headerlink" href="#Introduction" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">Rasterio simplifies handling various raster formats (e.g., GeoTIFF, jp2, VRT etc) by providing a user-friendly interface to interact with geospatial data.</div>
<div class="line">Its integration with other libraries (such as NumPy, SciPy, and Matplotlib) makes it a versatile tool in the field of remote sensing and geocomputation.</div>
<div class="line">In this lesson, we will:</div>
</div>
<ul class="simple">
<li><p>Learn how to read and inspect raster metadata.</p></li>
<li><p>Explore manipulation techniques, including band extraction, spatial filtering (moving average, Sobel), and masking.</p></li>
<li><p>Implement advanced visualization methods to generate false-color composites and perform side-by-side comparisons of original and filtered data.</p></li>
</ul>
</section>
<section id="Reading-and-Inspecting-Rasters">
<h3>Reading and Inspecting Rasters<a class="headerlink" href="#Reading-and-Inspecting-Rasters" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">Raster data formats like GeoTIFF and VRT are staples in geospatial analysis. A GeoTIFF contains embedded georeferencing information, while a VRT (Virtual Raster) allows for flexible mosaicking and on-the-fly processing.</div>
<div class="line">Rasterio provides efficient access to these formats, letting you inspect metadata (dimensions, coordinate reference system, number of bands) and load raster data into NumPy arrays.</div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> or some of its features connected to <code class="docutils literal notranslate"><span class="pre">gdal</span></code> doesn’t work, do again the installations with <code class="docutils literal notranslate"><span class="pre">pip</span></code> command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>!pip show rasterio
!apt show gdal-bin libgdal-dev
!pip install rasterio
!sudo apt update
!sudo apt install gdal-bin libgdal-dev
</pre></div>
</div>
<div class="line-block">
<div class="line">If <code class="docutils literal notranslate"><span class="pre">Rasterio</span></code> is on, let’s try to open a Sentinel-2 multispectral raster image, loading it and printing Raster Metadata and visualize all 3 RGB bands.</div>
<div class="line">In this case we will open all 3 RGB band .jp2 images, starting from Red.</div>
</div>
<div class="line-block">
<div class="line">Red Band (band 04) is useful for identifying vegetation types, soils and urban (city and town) areas because it is strongly reflected by dead foliage.</div>
<div class="line">It has limited water penetration and doesn’t reflect well from live foliage with chlorophyll.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">show</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Load the Sentinel2 jp2 image files</span>
<span class="c1"># IMPORTANT!: If kernel crash during the full res plotting, change the raster to be plotted</span>
<span class="c1"># switching from the 10m resolution version &#39;*_10.jp2&#39; to the downscaled 100m version &#39;*_100.jp2&#39;</span>
<span class="c1"># avoid in this way any memory-related problems.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="n">S2root</span> <span class="o">=</span> <span class="s1">&#39;files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/&#39;</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="n">Band_04_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B04_10m.jp2&quot;</span> <span class="c1"># red 10m</span>
<span class="o">!</span>gdalwarp<span class="w"> </span>-tr<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span>-r<span class="w"> </span>bilinear<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_B04_10m.jp2<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_B04_100m.jp2
<span class="n">Band_04_file_100</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B04_100m.jp2&quot;</span> <span class="c1"># red 100m (for low memory plotting)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="n">Band_03_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B03_10m.jp2&quot;</span> <span class="c1"># green 10m</span>
<span class="o">!</span>gdalwarp<span class="w"> </span>-tr<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span>-r<span class="w"> </span>bilinear<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_B03_10m.jp2<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_B03_100m.jp2
<span class="n">Band_03_file_100</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B03_100m.jp2&quot;</span> <span class="c1"># green 100m (for low memory plotting)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="n">Band_02_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B02_10m.jp2&quot;</span> <span class="c1"># blue</span>
<span class="o">!</span>gdalwarp<span class="w"> </span>-tr<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span>-r<span class="w"> </span>bilinear<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_B02_10m.jp2<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_B02_100m.jp2
<span class="n">Band_02_file_100</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B02_100m.jp2&quot;</span> <span class="c1"># blue 100m (for low memory plotting)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="n">Band_08_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B08_10m.jp2&quot;</span> <span class="c1"># NIR</span>
<span class="o">!</span>gdalwarp<span class="w"> </span>-tr<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span>-r<span class="w"> </span>bilinear<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_B08_10m.jp2<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_B08_100m.jp2
<span class="n">Band_08_file_100</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B08_100m.jp2&quot;</span> <span class="c1"># NIR 100m (for low memory plotting)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="n">RGB_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_TCI_10m.jp2&quot;</span>
<span class="o">!</span>gdalwarp<span class="w"> </span>-tr<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span>-r<span class="w"> </span>bilinear<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_TCI_10m.jp2<span class="w"> </span>files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/T34TBK_20250309T094039_TCI_100m.jp2
<span class="n">RGB_file_100</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_TCI_100m.jp2&quot;</span> <span class="c1"># RGB 100m (for low memory plotting)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\</span>
<span class="s2">RED BAND SPECS:</span><span class="se">\n\</span>
<span class="s2">band: B04 - red</span><span class="se">\n\</span>
<span class="s2">Resolution = 10m/px</span><span class="se">\n\</span>
<span class="s2">Central Wavelength = 665nm</span><span class="se">\n\</span>
<span class="s2">Bandwidth = 30nm </span><span class="se">\n\</span>
<span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Open the raster file and inspect its metadata</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Band_04_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># Display metadata information</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadata:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>

    <span class="c1"># Display number of bands and raster dimensions</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of bands:&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dimensions:&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

    <span class="c1"># Read and display the first band (for visualization)</span>
    <span class="n">band1</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Locality: Lecce (IT)  |  Date: 2025-03-09  |  Platform: Sentinel-2  |  Band: 04&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">band1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixel Values&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

RED BAND SPECS:
band: B04 - red
Resolution = 10m/px
Central Wavelength = 665nm
Bandwidth = 30nm

Metadata:
{&#39;driver&#39;: &#39;JP2OpenJPEG&#39;, &#39;dtype&#39;: &#39;uint16&#39;, &#39;nodata&#39;: None, &#39;width&#39;: 10980, &#39;height&#39;: 10980, &#39;count&#39;: 1, &#39;crs&#39;: CRS.from_epsg(32634), &#39;transform&#39;: Affine(10.0, 0.0, 199980.0,
       0.0, -10.0, 4500000.0)}
Number of bands: 1
Dimensions: 10980 x 10980
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_30_1.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_30_1.png" />
</div>
</div>
<p>Green band (band 03) gives an excellent contrast between clear and turbid (muddy) water, and penetrates clear water fairly well. It helps in highlighting oil on water surfaces, and vegetation. It reflects green light stronger than any other visible color. Man-made features are still visible.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[92]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\</span>
<span class="s2">GREEN BAND SPECS:</span><span class="se">\n\</span>
<span class="s2">band: B03 - green</span><span class="se">\n\</span>
<span class="s2">Resolution = 10m/px</span><span class="se">\n\</span>
<span class="s2">Central Wavelength = 600nm</span><span class="se">\n\</span>
<span class="s2">Bandwidth = 36nm </span><span class="se">\n\</span>
<span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Open the raster file and inspect its metadata</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Band_03_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># Display metadata information</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadata:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>

    <span class="c1"># Display number of bands and raster dimensions</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of bands:&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dimensions:&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

    <span class="c1"># Read and display the first band (for visualization)</span>
    <span class="n">band1</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Locality: Lecce (IT)  |  Date: 2025-03-09  |  Platform: Sentinel-2  |  Band: 03&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">band1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixel Values&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

GREEN BAND SPECS:
band: B03 - green
Resolution = 10m/px
Central Wavelength = 600nm
Bandwidth = 36nm

Metadata:
{&#39;driver&#39;: &#39;JP2OpenJPEG&#39;, &#39;dtype&#39;: &#39;uint16&#39;, &#39;nodata&#39;: None, &#39;width&#39;: 10980, &#39;height&#39;: 10980, &#39;count&#39;: 1, &#39;crs&#39;: CRS.from_epsg(32634), &#39;transform&#39;: Affine(10.0, 0.0, 199980.0,
       0.0, -10.0, 4500000.0)}
Number of bands: 1
Dimensions: 10980 x 10980
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_32_1.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_32_1.png" />
</div>
</div>
<p>Blue Band (band 02) is useful for soil and vegetation discrimination, forest type mapping and identifying man-made features. It is scattered by the atmosphere, it illuminates material in shadows better than longer wavelengths, and it penetrates clear water better than other colors. It is absorbed by chlorophyll, which results in darker plants.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\</span>
<span class="s2">BLUE BAND SPECS:</span><span class="se">\n\</span>
<span class="s2">band: B02 - blue</span><span class="se">\n\</span>
<span class="s2">Resolution = 10m/px</span><span class="se">\n\</span>
<span class="s2">Central Wavelength = 492nm</span><span class="se">\n\</span>
<span class="s2">Bandwidth = 66nm </span><span class="se">\n\</span>
<span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Open the raster file and inspect its metadata</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Band_02_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># Display metadata information</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadata:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>

    <span class="c1"># Display number of bands and raster dimensions</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of bands:&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dimensions:&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

    <span class="c1"># Read and display the first band (for visualization)</span>
    <span class="n">band1</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Locality: Lecce (IT)  |  Date: 2025-03-09  |  Platform: Sentinel-2  |  Band: 02&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">band1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixel Values&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

BLUE BAND SPECS:
band: B02 - blue
Resolution = 10m/px
Central Wavelength = 492nm
Bandwidth = 66nm

Metadata:
{&#39;driver&#39;: &#39;JP2OpenJPEG&#39;, &#39;dtype&#39;: &#39;uint16&#39;, &#39;nodata&#39;: None, &#39;width&#39;: 10980, &#39;height&#39;: 10980, &#39;count&#39;: 1, &#39;crs&#39;: CRS.from_epsg(32634), &#39;transform&#39;: Affine(10.0, 0.0, 199980.0,
       0.0, -10.0, 4500000.0)}
Number of bands: 1
Dimensions: 10980 x 10980
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_34_1.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_34_1.png" />
</div>
</div>
<p>In the same way we can display the RGB multiband image</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\</span>
<span class="s2">RGB IMAGE SPECS:</span><span class="se">\n\</span>
<span class="s2">Resolution = 10m/px</span><span class="se">\n\</span>
<span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Open the raster file and inspect its metadata</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">RGB_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Display metadata information</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadata:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>

    <span class="c1"># Display number of bands and raster dimensions</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of bands:&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dimensions:&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

    <span class="c1"># Display the RGB image</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Locality: Lecce (IT)  |  Date: 2025-03-09  |  Platform: Sentinel-2  |  Band: RGB&quot;</span><span class="p">)</span>

    <span class="c1"># Converts array to (height, width, band) for imshow()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">rgb_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

RGB IMAGE SPECS:
Resolution = 10m/px

Metadata:
{&#39;driver&#39;: &#39;JP2OpenJPEG&#39;, &#39;dtype&#39;: &#39;uint8&#39;, &#39;nodata&#39;: None, &#39;width&#39;: 10980, &#39;height&#39;: 10980, &#39;count&#39;: 3, &#39;crs&#39;: CRS.from_epsg(32634), &#39;transform&#39;: Affine(10.0, 0.0, 199980.0,
       0.0, -10.0, 4500000.0)}
Number of bands: 3
Dimensions: 10980 x 10980
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_36_1.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_36_1.png" />
</div>
</div>
<div class="line-block">
<div class="line">Often in satellite geospatial analyses, the study focus on one or more specific areas.</div>
<div class="line">Therefore, it is necessary to know how to crop the image to the right portion needed for the case study, to avoid both overcomputing operations (often costly in terms of time, memory and energy) and loss of detail.</div>
<div class="line">For instance, in this case we focus on the coastal area of the “Le Cesine” Nature Reserve, so we will use a common <strong>crop polygon</strong> shapefile for the <strong>crop</strong> operation.</div>
<div class="line">For this example instead of using a pre-existing shape we created it using <a class="reference external" href="https://www.keene.edu/campus/maps/tool/">Map Polygon-Polyline tool</a>, a crude but simple, practical and fast web tool. Therefore we will see in advance the <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> tool in action along with the use of <code class="docutils literal notranslate"><span class="pre">geometry_mask</span></code> from <code class="docutils literal notranslate"><span class="pre">rasterio</span></code>.</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>

<span class="c1"># Definition of the area of &quot;Riserva Naturale Le Cesine&quot;</span>
<span class="c1"># CRS: EPSG:4326</span>
<span class="c1"># just 4 vertexes (lat/long) listed clockwise starting from the lower left, to create a simple rectangular-ish bounding box</span>

<span class="n">bounding_box</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mf">18.3238220</span><span class="p">,</span> <span class="mf">40.3897044</span><span class="p">),</span> <span class="c1"># LL</span>
    <span class="p">(</span><span class="mf">18.2901764</span><span class="p">,</span> <span class="mf">40.3677353</span><span class="p">),</span> <span class="c1"># LR</span>
    <span class="p">(</span><span class="mf">18.3571243</span><span class="p">,</span> <span class="mf">40.3208965</span><span class="p">),</span> <span class="c1"># UL</span>
    <span class="p">(</span><span class="mf">18.3900833</span><span class="p">,</span> <span class="mf">40.3460208</span><span class="p">),</span> <span class="c1"># UR</span>
    <span class="p">(</span><span class="mf">18.3238220</span><span class="p">,</span> <span class="mf">40.3897044</span><span class="p">),</span> <span class="c1"># polygon closing</span>
    <span class="p">]</span>
<span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">bounding_box</span><span class="p">)</span>

<span class="c1"># The polygon needs to be setted as EPSG:4326 → Geographic coordinates (lat/long in decimal degrees).</span>
<span class="c1"># then converted in EPSG:32634 → Projected coordinates (meters, necessary to align and match with Sentinel2 CRS).</span>

<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">({</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">polygon</span><span class="p">]},</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:32634&#39;</span><span class="p">)</span>

<span class="c1"># Save the polygon as shapefile</span>
<span class="n">bbox_path</span> <span class="o">=</span> <span class="s1">&#39;files/Polygon_Natural_Reserve_Le_Cesine/Le_Cesine_BBox.shp&#39;</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">bbox_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can procede to cropping operation</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.mask</span><span class="w"> </span><span class="kn">import</span> <span class="n">mask</span>

<span class="c1"># Load the bounding box</span>
<span class="n">bbox_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">bbox_path</span><span class="p">)</span>

<span class="c1"># Double check images have the same CRS</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">RGB_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">bbox_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
        <span class="n">bbox_gdf</span> <span class="o">=</span> <span class="n">bbox_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Extract bounding box geometry</span>
    <span class="n">bbox_geom</span> <span class="o">=</span> <span class="p">[</span><span class="n">bbox_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">unary_union</span><span class="p">]</span> <span class="c1">#return the union of multple geometries if any</span>

    <span class="c1"># Apply the crop using the mask</span>
    <span class="n">cropped_image</span><span class="p">,</span> <span class="n">cropped_transform</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">bbox_geom</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># if you want a white backgound in the print set the nodata=255 or =0 for a black one,</span>
    <span class="c1"># but be sure on the nodatavalue youre using, before proceding further</span>

    <span class="c1"># Update the metadata for the cropped image</span>
    <span class="n">cropped_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cropped_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">cropped_transform</span>
    <span class="p">})</span>

<span class="c1"># Save the cropped image</span>
<span class="n">cropped_path</span> <span class="o">=</span> <span class="s1">&#39;files/Lecce_RGB_cropped.tif&#39;</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cropped_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">cropped_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">)</span>

<span class="c1"># Visualize a small preview of the cropped image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cropped area&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="c1">#plt.axis(&quot;off&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_40_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_40_0.png" />
</div>
</div>
<p>We can also visualize some more refinements to have a more fancy-scientific layout in QGIS style</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">FancyArrow</span>

<span class="c1"># Extract spatial information</span>
<span class="n">left</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">cropped_transform</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">right</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">cropped_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cropped_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Display the cropped image with map features</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Study Area: Riserva Naturale Le Cesine&quot;</span><span class="p">)</span>

<span class="c1"># Show image coordinates and white background for NoData</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">cropped_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">))</span>

<span class="c1"># Add coordinate axes</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Easting (m)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Northing (m)&quot;</span><span class="p">)</span>

<span class="c1"># Add a north arrow</span>
<span class="n">arrow</span> <span class="o">=</span> <span class="n">FancyArrow</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                   <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">arrow</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.944</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

<span class="c1"># Add a scale bar</span>
<span class="n">scalebar_length</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># meters</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">right</span> <span class="o">-</span> <span class="mi">1300</span><span class="p">,</span> <span class="n">right</span> <span class="o">-</span> <span class="mi">300</span><span class="p">],</span> <span class="p">[</span><span class="n">bottom</span> <span class="o">+</span> <span class="mi">500</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">+</span> <span class="mi">500</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">right</span> <span class="o">-</span> <span class="mi">1200</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">+</span> <span class="mi">750</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scalebar_length</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>  <span class="c1"># Add grid for better readability</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_42_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_42_0.png" />
</div>
</div>
<div class="line-block">
<div class="line">We can also explore the cropped image using <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> and <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, by plotting the distribution of the pixel values for each band.</div>
<div class="line">This becomes useful when we have to indagate pixel diversity to find some clustering or some outlier values.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">show_hist</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;files/Lecce_RGB_cropped.tif&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="c1"># Empty brackets for reading all bands</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># for a better representation all nodata values (&#39;0&#39; in this case) needs to be masked-out</span>
    <span class="c1"># to not have our graph downskewed for the nodata overpresence</span>
    <span class="n">data_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Show plot</span>
    <span class="n">band_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Red Band&#39;</span><span class="p">,</span> <span class="s1">&#39;Green Band&#39;</span><span class="p">,</span> <span class="s1">&#39;Blue Band&#39;</span><span class="p">]</span>
    <span class="n">show_hist</span><span class="p">(</span><span class="n">data_masked</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">band_labels</span><span class="p">,</span>
              <span class="n">title</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\</span>
<span class="s2">              Pixel Distribution Histogram:</span><span class="se">\n\</span>
<span class="s2">              Lecce_RGB_cropped&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_44_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_44_0.png" />
</div>
</div>
</section>
<section id="Raster-Manipulation-and-Filtering">
<h3>Raster Manipulation and Filtering<a class="headerlink" href="#Raster-Manipulation-and-Filtering" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">Spatial filtering is crucial for enhancing feature detection, noise suppression, edge detection and many others more noise in raster imges.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Rasterio</span></code> allows you to extract individual bands from multi-band images, process these bands with tools and libraries such as <code class="docutils literal notranslate"><span class="pre">SciPy</span></code>, and save the modified outputs back to a new raster file. In this example we will extract bands to apply a Sobel Filter to our cropper study area.</div>
<div class="line">For instance, we can try applying a <strong>Sobel filter</strong>, to highlight coastline then visually compare it with the original cropped RGB image and save the processed result.</div>
<div class="line">Specifically, the <strong>Sobel operator</strong> is an algorithm used to process digital images, particularly to perform contour recognition.</div>
<div class="line">Technically speaking, it is a differential operator, which calculates an approximate value of the gradient of a function representing the brightness of the image.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">skimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">filters</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">rgb_path</span> <span class="o">=</span> <span class="s1">&#39;files/Lecce_RGB_cropped.tif&#39;</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgb_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>  <span class="c1"># Read all R, G, B</span>
    <span class="c1"># Read all values but masks out all &#39;255&#39; NoData values to avoid misfiltering</span>
    <span class="n">nodata_value</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span> <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">img_data</span> <span class="o">!=</span> <span class="n">nodata_value</span>
    <span class="c1"># Create a copy of original values to apply Sobel only on valid pixels</span>
    <span class="n">sobel_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>

    <span class="c1"># Loop on all RGB bands and apply Sobel filtering on valid pixels only</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">sobel_filtered</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">img_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

    <span class="c1"># Converts the pixel value to uint8 in order to save as a properly viewable image</span>
    <span class="c1"># and Restores the original NoData values to the corresponding pixels</span>
    <span class="n">sobel_filtered</span> <span class="o">=</span> <span class="n">sobel_filtered</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">sobel_filtered</span><span class="p">[</span><span class="o">~</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodata_value</span>

    <span class="c1"># Saving the filtered image</span>
    <span class="n">sobel_path</span> <span class="o">=</span> <span class="n">rgb_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;_sobel.tif&#39;</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>     <span class="c1"># image width</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>   <span class="c1"># image height</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sobel_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span>
                       <span class="n">crs</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="n">nodata_value</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sobel_filtered</span><span class="p">)</span>

<span class="c1"># Display of the original compared with the filtered one</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

<span class="c1"># Original image</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgb_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">original_img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original RGB&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="c1"># Filtered image</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sobel_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">sobel_img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sobel_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RGB Sobel filtered&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_46_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_46_0.png" />
</div>
</div>
<div class="line-block">
<div class="line">There other useful filtering and methods for processing an image.</div>
<div class="line">For example, again using <code class="docutils literal notranslate"><span class="pre">SciPy</span></code> we find the Otsu method, a binary thresholding algorithm.</div>
<div class="line">The Otsu method is an automatic histogram thresholding method in digital images. The algorithm assumes that there are only two classes in the image to be thresholded, and then calculates the optimal threshold for separating these two classes by minimizing the intra-class variance.</div>
<div class="line">Let’s see how to apply it, and compare it to the original.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">skimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">filters</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgb_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># Array shape: (3, height, width)</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Mask out all NoData values (values = 0)</span>
<span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">rgb_image</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Convert the RGB image to grayscale (mean of valid pixels)</span>
<span class="n">gray_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rgb_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Apply the mask to exclude NoData values</span>
<span class="n">valid_gray_image</span> <span class="o">=</span> <span class="n">gray_image</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

<span class="c1"># Compute Otsu&#39;s threshold excluding NoData</span>
<span class="n">otsu_threshold</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">threshold_otsu</span><span class="p">(</span><span class="n">valid_gray_image</span><span class="p">)</span>

<span class="c1"># Apply the threshold to create a binary mask</span>
<span class="n">binary_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">gray_image</span> <span class="o">&gt;</span> <span class="n">otsu_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>

<span class="c1"># Preserve NoData regions (set them to 0 in the output mask)</span>
<span class="n">binary_mask</span><span class="p">[</span><span class="o">~</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Update metadata for the binary image</span>
<span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;uint8&#39;</span><span class="p">,</span>
    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">})</span>

<span class="c1"># Save the binary mask with Otsu&#39;s threshold</span>
<span class="n">otsu_output_path</span> <span class="o">=</span> <span class="s1">&#39;files/Lecce_RGB_cropped_otsu.tif&#39;</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">otsu_output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">binary_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Display of the original compared with the filtered one</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

<span class="c1"># Original image</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgb_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">original_img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original RGB&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="c1"># Filtered image</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">otsu_output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">otsu_img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">otsu_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RGB Otsu filtered&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_48_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_48_0.png" />
</div>
</div>
</section>
<section id="Composite-Raster-Processing">
<h3>Composite Raster Processing<a class="headerlink" href="#Composite-Raster-Processing" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">In addition to viewing, editing, and filtering rasters, rasterio allows you to create composites by processing.</div>
<div class="line">Now we will see a complete workflow for creating a composite raster using <code class="docutils literal notranslate"><span class="pre">Rasterio</span></code>, with a focus on calculating the <strong>Normalized Difference Vegetation Index (NDVI)</strong>.</div>
<div class="line">NDVI is one of the many widely used indexes in remote sensing that helps quantify some physical properties, in this case it express the vegetation health by comparing the near-infrared (NIR) and red spectral bands.</div>
</div>
<div class="line-block">
<div class="line">We will open the two .jp2 Red (04) and NIR (08) spectral band files and compute the NDVI for the entire raster area.</div>
<div class="line">The NDVI is calculated with the formula:</div>
</div>
<div class="math notranslate nohighlight">
\[\text{NDVI} = \frac{\text{NIR} - \text{Red}}{\text{NIR} + \text{Red}}\]</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Define the Sentinel-2 data root folder and file paths for the red and NIR bands.</span>
<span class="n">S2root</span> <span class="o">=</span> <span class="s1">&#39;files/S2B_MSIL2A_20250309T094039_N0511_R036_T34TBK_20250309T120119.SAFE/GRANULE/L2A_T34TBK_A041818_20250309T094257/IMG_DATA/R10m/&#39;</span>
<span class="n">Band_04_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B04_10m.jp2&quot;</span>
<span class="n">Band_08_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S2root</span><span class="si">}</span><span class="s2">T34TBK_20250309T094039_B08_10m.jp2&quot;</span>

<span class="c1"># Open the red band file (Band 04) and read its data.</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Band_04_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">red_src</span><span class="p">:</span>
    <span class="n">red</span> <span class="o">=</span> <span class="n">red_src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="c1"># Save metadata for later use (for saving the final NDVI image).</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">red_src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Open the NIR band file (Band 08) and read its data.</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Band_08_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">nir_src</span><span class="p">:</span>
    <span class="n">nir</span> <span class="o">=</span> <span class="n">nir_src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

<span class="c1"># Calculate NDVI using the formula: (NIR - Red) / (NIR + Red)</span>
<span class="c1"># np.errstate is used to ignore division warnings (e.g., division by zero).</span>
<span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
    <span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">red</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">red</span><span class="p">)</span>
    <span class="n">ndvi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Replace NaN values with 0.0</span>

<span class="c1"># Print basic information about the NDVI array.</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NDVI calculation complete</span><span class="se">\n</span><span class="s2">shape: </span><span class="si">{</span><span class="n">ndvi</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">resolution: 10m/px</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Update the metadata for the NDVI file.</span>
<span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>  <span class="c1"># GeoTIFF format.</span>
    <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="c1"># Data type.</span>
    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span>          <span class="c1"># Single band.</span>
<span class="p">})</span>

<span class="c1"># Write the NDVI array to a new GeoTIFF file.</span>
<span class="n">ndvi_file</span> <span class="o">=</span> <span class="s2">&quot;files/Lecce_NDVI.tif&quot;</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ndvi_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># ---------------------------- Downscale for memory problem-----------------------------</span>
<span class="o">!</span>gdalwarp<span class="w"> </span>-tr<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">100</span><span class="w"> </span>-r<span class="w"> </span>bilinear<span class="w"> </span>files/Lecce_NDVI.tif<span class="w"> </span>files/Lecce_NDVI_resized.tif
<span class="n">ndvi_file_resized</span><span class="o">=</span> <span class="s2">&quot;files/Lecce_NDVI_resized.tif&quot;</span> <span class="c1"># green 100m (for low memory plotting)</span>
<span class="c1"># --------------------------------------------------------------------------------------</span>

<span class="c1"># Now, open the newly created NDVI GeoTIFF file and visualize it.</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ndvi_file_resized</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">band1</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Locality: Lecce (IT)  |  Date: 2025-03-09  |  Platform: Sentinel-2  |  Product: NDVI&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">band1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;NDVI Values&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

NDVI calculation complete
shape: (10980, 10980)
resolution: 10m/px

Creating output file that is 1098P x 1098L.
Processing files/Lecce_NDVI.tif [1/1] : 0...10...20...30...40...50...60...70...80...90...100 - done.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_50_1.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_50_1.png" />
</div>
</div>
<div class="line-block">
<div class="line">Another common and important practice in geospatial analysis is the image scaling process, which consists on adjusting the spatial resolution of raster data.</div>
<div class="line">We can do it with <code class="docutils literal notranslate"><span class="pre">Rasterio</span></code> running <code class="docutils literal notranslate"><span class="pre">GDAL</span></code> in the backbone.</div>
<div class="line">This involves <strong>upscaling</strong> (increasing image size) or <strong>downscaling</strong> (reducing image size).</div>
<div class="line">Resizing is indeed is a crucial step in many workflows involving raster data, such as satellite imagery, digital elevation models (DEMs) and other geospatial datasets.</div>
<div class="line">Especially working in cloud, for example in-flight downsizing allows us to download very light-weighted low-resolution previews to essay whether the whole processing is correct.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.enums</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resampling</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1">### Files paths</span>
<span class="n">input_path</span> <span class="o">=</span> <span class="s2">&quot;files/Lecce_NDVI.tif&quot;</span>
<span class="n">output_tif</span> <span class="o">=</span> <span class="s2">&quot;files/Lecce_NDVI_resized.tif&quot;</span>

<span class="c1">### View the comparison between the original raster and the resized raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">original</span><span class="p">,</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_tif</span><span class="p">)</span> <span class="k">as</span> <span class="n">resized</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original 10m resolution NDVI&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resized</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resized 100m resolution NDVI&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_52_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_52_0.png" />
</div>
</div>
</section>
</section>
<section id="3---Geopandas-for-Vector-Processing-and-Visualization">
<h2><strong>3 - Geopandas for Vector Processing and Visualization</strong><a class="headerlink" href="#3---Geopandas-for-Vector-Processing-and-Visualization" title="Link to this heading"></a></h2>
<section id="Introduction-to-Vector-Files-and-Their-Types">
<h3>Introduction to Vector Files and Their Types<a class="headerlink" href="#Introduction-to-Vector-Files-and-Their-Types" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">Vector files are a common type of spatial data format used to represent geographic features such as points, lines, and polygons.</div>
<div class="line">They are different from raster files, which store data in a grid-like format. Vector data is essential for representing discrete objects in a map and is widely used for tasks like geospatial analysis and visualization.</div>
</div>
<p>The main types of vector files include:</p>
<ul class="simple">
<li><p>Point: Represents a specific location, e.g., a city or a landmark.</p></li>
<li><p>Line: Represents linear features, e.g., roads or rivers.</p></li>
<li><p>Polygon: Represents area-based features, e.g., countries, lakes, or forest boundaries.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> is a powerful Python library for working with vector data, allowing you to import, process, and visualize vector files.</p>
<p><img alt="Geopandas" src="https://geopandas.org/en/stable/_images/geopandas_logo.png" /></p>
</section>
<section id="Importing-Vector-Files-with-Geopandas">
<h3>Importing Vector Files with Geopandas<a class="headerlink" href="#Importing-Vector-Files-with-Geopandas" title="Link to this heading"></a></h3>
<div class="line-block">
<div class="line">To begin working with vector files, we need to import them into a <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> DataFrame.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> supports various file formats like Shapefiles, GeoJSON, and others.</div>
<div class="line">After reading the shapefile usually its a good practice to examine it by viewing the first few rows of its attribute table.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>

<span class="c1"># Load a shapefile into a GeoDataFrame</span>
<span class="n">shp</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;files/confini_comunali_Puglia/ConfiniComunali.shp&#39;</span><span class="p">)</span>

<span class="c1"># Display the first few rows</span>
<span class="n">shp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PERIMETER</th>
      <th>COD_ISTAT</th>
      <th>NOME_COM</th>
      <th>ISTAT</th>
      <th>COD_REG</th>
      <th>COD_PRO</th>
      <th>COD_COM</th>
      <th>SHAPE_AREA</th>
      <th>SHAPE_LEN</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>23908.747701</td>
      <td>16073016</td>
      <td>MONTEIASI</td>
      <td>73016.0</td>
      <td>16</td>
      <td>73</td>
      <td>16</td>
      <td>8.789343e+06</td>
      <td>23750.192588</td>
      <td>POLYGON ((704146.013 4485200.686, 704171.913 4...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>87974.479155</td>
      <td>16073007</td>
      <td>GINOSA</td>
      <td>73007.0</td>
      <td>16</td>
      <td>73</td>
      <td>7</td>
      <td>1.873289e+08</td>
      <td>87892.679141</td>
      <td>POLYGON ((654554.589 4493047.058, 654590.973 4...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>42299.972315</td>
      <td>16073021</td>
      <td>PALAGIANO</td>
      <td>73021.0</td>
      <td>16</td>
      <td>73</td>
      <td>21</td>
      <td>6.920569e+07</td>
      <td>42447.474770</td>
      <td>POLYGON ((675119.459 4496762.919, 675103.418 4...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>77341.902455</td>
      <td>16073008</td>
      <td>GROTTAGLIE</td>
      <td>73008.0</td>
      <td>16</td>
      <td>73</td>
      <td>8</td>
      <td>1.014344e+08</td>
      <td>81673.089331</td>
      <td>MULTIPOLYGON (((700938.416 4497517.409, 700946...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>83436.627048</td>
      <td>16074008</td>
      <td>FRANCAVILLA FONTANA</td>
      <td>74008.0</td>
      <td>16</td>
      <td>74</td>
      <td>8</td>
      <td>1.751759e+08</td>
      <td>83389.436977</td>
      <td>POLYGON ((725580.382 4494508.483, 725580.190 4...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Often when working with shapefiles that we are not familiar with, it is important to delve into their details (Number of records, data type by column, CRS, coordinates extension etc.).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[90]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shows structure, attributes and basic informations</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--------------------------------------</span><span class="se">\n\</span>
<span class="s2">INFOS:&quot;</span><span class="p">)</span>
<span class="n">shp</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">total_bounds</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--------------------------------------</span><span class="se">\n\</span>
<span class="s2">CRS:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">shp</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="se">\n\</span>
<span class="s2">--------------------------------------</span><span class="se">\n\</span>
<span class="s2">Coordinate extension: </span><span class="se">\n\</span>
<span class="s2">Min X: </span><span class="si">{</span><span class="n">minx</span><span class="si">}</span><span class="se">\n\</span>
<span class="s2">Min Y: </span><span class="si">{</span><span class="n">miny</span><span class="si">}</span><span class="se">\n\</span>
<span class="s2">Max X: </span><span class="si">{</span><span class="n">maxx</span><span class="si">}</span><span class="se">\n\</span>
<span class="s2">Max Y: </span><span class="si">{</span><span class="n">maxy</span><span class="si">}</span><span class="se">\n\</span>
<span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Show [minX, minY, maxX, maxY]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--------------------------------------
INFOS:
&lt;class &#39;geopandas.geodataframe.GeoDataFrame&#39;&gt;
RangeIndex: 258 entries, 0 to 257
Data columns (total 10 columns):
 #   Column      Non-Null Count  Dtype
---  ------      --------------  -----
 0   PERIMETER   258 non-null    float64
 1   COD_ISTAT   258 non-null    int64
 2   NOME_COM    258 non-null    object
 3   ISTAT       258 non-null    float64
 4   COD_REG     258 non-null    int64
 5   COD_PRO     258 non-null    int64
 6   COD_COM     258 non-null    int64
 7   SHAPE_AREA  258 non-null    float64
 8   SHAPE_LEN   258 non-null    float64
 9   geometry    258 non-null    geometry
dtypes: float64(4), geometry(1), int64(4), object(1)
memory usage: 20.3+ KB
--------------------------------------
CRS:
 PROJCS[&#34;WGS 84 / UTM zone 34N&#34;,GEOGCS[&#34;WGS 84&#34;,DATUM[&#34;WGS_1984&#34;,SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563,AUTHORITY[&#34;EPSG&#34;,&#34;7030&#34;]],AUTHORITY[&#34;EPSG&#34;,&#34;6326&#34;]],PRIMEM[&#34;Greenwich&#34;,0,AUTHORITY[&#34;EPSG&#34;,&#34;8901&#34;]],UNIT[&#34;degree&#34;,0.0174532925199433,AUTHORITY[&#34;EPSG&#34;,&#34;9122&#34;]],AUTHORITY[&#34;EPSG&#34;,&#34;4326&#34;]],PROJECTION[&#34;Transverse_Mercator&#34;],PARAMETER[&#34;latitude_of_origin&#34;,0],PARAMETER[&#34;central_meridian&#34;,21],PARAMETER[&#34;scale_factor&#34;,0.9996],PARAMETER[&#34;false_easting&#34;,500000],PARAMETER[&#34;false_northing&#34;,0],UNIT[&#34;metre&#34;,1,AUTHORITY[&#34;EPSG&#34;,&#34;9001&#34;]],AXIS[&#34;Easting&#34;,EAST],AXIS[&#34;Northing&#34;,NORTH],AUTHORITY[&#34;EPSG&#34;,&#34;32634&#34;]]
--------------------------------------
Coordinate extension:
Min X: -6036.7602779534645
Min Y: 4407777.80037381
Max X: 288671.2758198937
Max Y: 4688318.971373621

</pre></div></div>
</div>
<p>Then, we can switch to an actual visualization of the shapefile using <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> and <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> again.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScalarFormatter</span>

<span class="c1"># Plot the shapefile</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>  <span class="c1"># Set figure size</span>
<span class="n">shp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">)</span>

<span class="c1"># Add a title and axis labels</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confini Comunali Puglia | CRS: </span><span class="si">{</span><span class="n">shp</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing (m)&#39;</span><span class="p">)</span>

<span class="c1"># Display the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_58_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_58_0.png" />
</div>
</div>
<div class="line-block">
<div class="line"><strong>Shapefiles</strong> alteration and modification is a common operation, it can be performed in various ways using <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code>, depending on the specific task we need.</div>
<div class="line">In this case, we will focus on adapting a <strong>shapefile</strong> to match the geographical extent of an NDVI <strong>raster</strong> calculated previously.</div>
<div class="line">The objective is to create a new <strong>shapefile</strong> containing only those polygons whose coordinates intersect with the raster’s spatial extent, even if just a single point of intersection exists.</div>
</div>
<div class="line-block">
<div class="line">For this operation, we opt to save the resulting shapefile as <strong>GeoPackage</strong> (.gpkg) format rather than the traditional shapefile format.</div>
<div class="line">Lately GeoPackage are being used more and more than classic shapefile formats (.shp, .shx, .prj, .dbf) for several advantages:</div>
</div>
<ul class="simple">
<li><p>GeoPackage supports more efficient storage and data management, particularly for large datasets, as it allows for the storage of multiple vector and raster datasets within a single file.</p></li>
<li><p>It is better suited for handling complex data types and offers improved performance when dealing with large-scale geospatial data. This makes it a more robust and scalable format compared to shapefiles, especially when working with large and spatially complex datasets.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">box</span>

<span class="c1"># Bash snippet to create the folder that will contain the new shapefiles, if it does not already exist</span>
<span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>files/confini_comunali_Salento

<span class="c1"># File paths</span>
<span class="n">tif_path</span> <span class="o">=</span> <span class="s1">&#39;files/Lecce_NDVI.tif&#39;</span>
<span class="n">output_shapefile_path</span> <span class="o">=</span> <span class="s1">&#39;files/confini_comunali_Salento/intersected_polygons.gpkg&#39;</span>

<span class="c1"># Extract the geographical limits of TIFF file</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tif_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">tif_bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>    <span class="c1"># (minx, miny, maxx, maxy)</span>
    <span class="n">tif_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>          <span class="c1"># TIFF reference system</span>
    <span class="n">shp_crs</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">crs</span>          <span class="c1"># shapefile reference system</span>

<span class="c1"># before proceding test if they have matching CRS</span>
<span class="k">if</span> <span class="n">tif_crs</span> <span class="o">==</span> <span class="n">shp_crs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matching CRS:</span><span class="se">\n</span><span class="si">{</span><span class="n">shp_crs</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Proceding to polygon selection.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Different CRS:</span><span class="se">\n</span><span class="s2">shapefile CRS:</span><span class="se">\n</span><span class="si">{</span><span class="n">shp_crs</span><span class="si">}</span><span class="se">\n</span><span class="s2"> tif CRS:</span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="si">{</span><span class="n">tif_crs</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Make shape CRS match with the TIFF one before proceding</span>
    <span class="n">shp</span> <span class="o">=</span> <span class="n">shp</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">tif_crs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Proceding to polygon selection.&quot;</span><span class="p">)</span>

<span class="c1"># Create a geometry (box) with the limits of TIFF file</span>
<span class="n">tif_box</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">tif_bounds</span><span class="p">)</span>

<span class="c1"># Select just polygons that intersect the TIFF box</span>
<span class="n">shp_filtered</span> <span class="o">=</span> <span class="n">shp</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">tif_box</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intersected polygons: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shp_filtered</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Save the new shapefile with the intersecting polygons as a .gpkg</span>
<span class="n">shp_filtered</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_shapefile_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GPKG&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New shapefile saved as .gpkg in: </span><span class="si">{</span><span class="n">output_shapefile_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Matching CRS:
PROJCS[&#34;WGS 84 / UTM zone 34N&#34;,GEOGCS[&#34;WGS 84&#34;,DATUM[&#34;WGS_1984&#34;,SPHEROID[&#34;WGS 84&#34;,6378137,298.257223563,AUTHORITY[&#34;EPSG&#34;,&#34;7030&#34;]],AUTHORITY[&#34;EPSG&#34;,&#34;6326&#34;]],PRIMEM[&#34;Greenwich&#34;,0,AUTHORITY[&#34;EPSG&#34;,&#34;8901&#34;]],UNIT[&#34;degree&#34;,0.0174532925199433,AUTHORITY[&#34;EPSG&#34;,&#34;9122&#34;]],AUTHORITY[&#34;EPSG&#34;,&#34;4326&#34;]],PROJECTION[&#34;Transverse_Mercator&#34;],PARAMETER[&#34;latitude_of_origin&#34;,0],PARAMETER[&#34;central_meridian&#34;,21],PARAMETER[&#34;scale_factor&#34;,0.9996],PARAMETER[&#34;false_easting&#34;,500000],PARAMETER[&#34;false_northing&#34;,0],UNIT[&#34;metre&#34;,1,AUTHORITY[&#34;EPSG&#34;,&#34;9001&#34;]],AXIS[&#34;Easting&#34;,EAST],AXIS[&#34;Northing&#34;,NORTH],AUTHORITY[&#34;EPSG&#34;,&#34;32634&#34;]]

Proceding to polygon selection.
Intersected polygons: 124
New shapefile saved as .gpkg in: files/confini_comunali_Salento/intersected_polygons.gpkg
</pre></div></div>
</div>
<p>Now, using <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> and <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> again, we can visualize the result of this operation, with a joint plot of both the original shapefile and the intersected shapefile based on the bounding box relative to the reference raster extent (NDVI).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">box</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpatches</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>

<span class="c1"># &#39;shp&#39; - original shapefile (GeoDataFrame)</span>
<span class="c1"># &#39;shp_filtered&#39; - intersected shapefile (GeoDataFrame)</span>
<span class="c1"># &#39;tif_box&#39; - bounding box of the raster (shapely.geometry box)</span>

<span class="c1"># Create a figure and axes for plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>

<span class="c1"># Plot the original shapefile (shp) in blue</span>
<span class="n">shp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
         <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
         <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Plot the intersected shapefile (shp_filtered) in red</span>
<span class="n">shp_filtered</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                  <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;brown&#39;</span><span class="p">,</span>
                  <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Plot the bounding box of the raster</span>
<span class="c1"># tif_box is a shapely.geometry box, so we can plot it directly</span>
<span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">tif_box</span><span class="o">.</span><span class="n">bounds</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">x_min</span><span class="p">],</span>
        <span class="p">[</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="c1"># Set labels and title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confini Comunali Puglia | CRS: </span><span class="si">{</span><span class="n">tif_crs</span><span class="si">}</span><span class="se">\n</span><span class="s2">NDVI Raster Intersection&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing (m)&#39;</span><span class="p">)</span>

<span class="c1"># Create custom legend</span>
<span class="c1"># legend for the original shapefile</span>
<span class="n">original_shapefile_patch</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Shapefile&#39;</span><span class="p">)</span>
<span class="c1"># legend for the intersected shapefile</span>
<span class="n">intersected_shapefile_patch</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                                             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Intersected Shapefile&#39;</span><span class="p">)</span>
<span class="c1"># legend for the tiff bounding box</span>
<span class="n">bounding_box_line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                           <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                           <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Raster Bounding Box&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">original_shapefile_patch</span><span class="p">,</span> <span class="n">intersected_shapefile_patch</span><span class="p">,</span> <span class="n">bounding_box_line</span><span class="p">])</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_62_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_62_0.png" />
</div>
</div>
<div class="line-block">
<div class="line">We now exploit <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> and <code class="docutils literal notranslate"><span class="pre">Rasterio</span></code> together for more advanced processing.</div>
<div class="line">Specifically, we will perform a simple average of the NDVI raster values but calculated for each polygon (for each municipality area in Salento) using <code class="docutils literal notranslate"><span class="pre">shapely.geometry</span></code>. Due to RAM issues (often present in python working environments) to do this we will do two tricks:</div>
</div>
<ul class="simple">
<li><p>use the lighter NDVI_resized.tif already computed previously, whose 100m resolution instead of the native 20m will allow us to compute these areal averages more easily.</p></li>
<li><p>define a smaller pixel chunk size for compute mean without any RAM chocking.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.mask</span><span class="w"> </span><span class="kn">import</span> <span class="n">mask</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.windows</span><span class="w"> </span><span class="kn">import</span> <span class="n">Window</span>

<span class="c1"># Open the raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;files/Lecce_NDVI_resized.tif&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># List to store mean NDVI values for each polygon</span>
    <span class="n">mean_values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Get raster dimensions</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>

    <span class="c1"># Define a smaller pixel chunk size (e.g., 10000x10000)</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">10000</span>

    <span class="c1"># Loop over the municipalities polygons (&#39;shp_filtered&#39;)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">shp_filtered</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapping</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])]</span>

        <span class="c1"># Initialize a variable to hold the masked raster data for the current polygon</span>
        <span class="n">masked_image</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process the raster in chunks</span>
        <span class="k">for</span> <span class="n">start_x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">start_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
                <span class="c1"># Define the window to read</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">start_x</span><span class="p">,</span> <span class="n">start_y</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Read the raster data for the current window (i.e., chunk)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>  <span class="c1"># Read the first band (because NDVI is a single-band raster)</span>

                    <span class="c1"># Mask the raster using the polygon geometry</span>
                    <span class="n">out_image</span><span class="p">,</span> <span class="n">out_transform</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># Now we have the masked data for the polygon and can calculate its mean</span>
                    <span class="c1"># We need to be sure to mask out any no-data values</span>
                    <span class="n">masked_data</span> <span class="o">=</span> <span class="n">out_image</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out_image</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>  <span class="c1"># Mask no-data values</span>

                    <span class="c1"># Append the data to the list</span>
                    <span class="n">masked_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masked_data</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Exception print needed in case of debugging</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while processing window </span><span class="si">{</span><span class="p">(</span><span class="n">start_x</span><span class="p">,</span><span class="w"> </span><span class="n">start_y</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># After processing all chunks, combine the chunks and calculate the mean</span>
        <span class="k">if</span> <span class="n">masked_image</span><span class="p">:</span>  <span class="c1"># Only calculate the mean if the list isn&#39;t empty</span>
            <span class="n">masked_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">masked_image</span><span class="p">)</span>  <span class="c1"># Combine the chunks</span>
            <span class="n">mean_value</span> <span class="o">=</span> <span class="n">masked_image</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># Calculate the mean of the pixel values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean_value</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No valid pixels in the polygon</span>

        <span class="n">mean_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_value</span><span class="p">)</span>

    <span class="c1"># Create an explicit DataFrame copy to avoid overwriting issues</span>
    <span class="n">shp_filtered_copy</span> <span class="o">=</span> <span class="n">shp_filtered</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Add the mean values to the shapefile</span>
    <span class="n">shp_filtered_copy</span><span class="p">[</span><span class="s1">&#39;mean_ndvi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_values</span>

    <span class="c1"># Save the updated shapefile</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="s2">&quot;files/confini_comunali_Salento/mean_NDVI_Salento.gpkg&quot;</span>
    <span class="n">shp_filtered_copy</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GPKG&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NDVI average value computed.</span><span class="se">\n</span><span class="s2"> Results in:&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NDVI average value computed.
 Results in: files/confini_comunali_Salento/mean_NDVI_Salento.gpkg
</pre></div></div>
</div>
<p>We can always use <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> and <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> to plot the result</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Plot the shapefile with &#39;mean_ndvi&#39; as the color parameter</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>

<span class="c1"># Plot using a green color map, scaling colors based on the &#39;mean_ndvi&#39; column</span>
<span class="n">shp_filtered_copy</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;mean_ndvi&#39;</span><span class="p">,</span>
                       <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                       <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">,</span>  <span class="c1"># Using a green color map</span>
                       <span class="n">legend_kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s2">&quot;Mean NDVI by Polygon&quot;</span><span class="p">,</span>
                                    <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">},</span>
                       <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
                       <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Add title and labels</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mean NDVI by Polygon&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing (m)&#39;</span><span class="p">)</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_66_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_66_0.png" />
</div>
</div>
<p>Now, using <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> and <code class="docutils literal notranslate"><span class="pre">pandas</span></code> we can transform a list of EPSG:32634 coordinates (they can be a possible in situ sampling points) into a GeoPackage points shapefile, to be used for further geospatial processing.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># Coordinates in EPSG:32634</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mf">273428.62</span><span class="p">,</span> <span class="mf">4471528.55</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">273333.06</span><span class="p">,</span> <span class="mf">4471504.63</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">273155.69</span><span class="p">,</span> <span class="mf">4471459.57</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">272889.96</span><span class="p">,</span> <span class="mf">4471402.66</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">272627.77</span><span class="p">,</span> <span class="mf">4471357.00</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">272334.69</span><span class="p">,</span> <span class="mf">4471315.93</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">271986.81</span><span class="p">,</span> <span class="mf">4471271.98</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">271693.17</span><span class="p">,</span> <span class="mf">4471242.75</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">271364.28</span><span class="p">,</span> <span class="mf">4471193.71</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">270979.83</span><span class="p">,</span> <span class="mf">4471147.29</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">270558.81</span><span class="p">,</span> <span class="mf">4471098.37</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Create a GeoDataFrame</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">]),</span>
    <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">],</span>
    <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:32634&quot;</span>  <span class="c1"># Coordinate reference system</span>
<span class="p">)</span>

<span class="c1"># Save to GeoPackage</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s2">&quot;files/extraction_points.gpkg&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extraction Points has been saved successfully as .gpkg.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Extraction Points has been saved successfully as .gpkg.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pnt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;files/extraction_points.gpkg&quot;</span><span class="p">)</span>
<span class="n">pnt</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>273428.62</td>
      <td>4471528.55</td>
      <td>POINT (273428.620 4471528.550)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>273333.06</td>
      <td>4471504.63</td>
      <td>POINT (273333.060 4471504.630)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>273155.69</td>
      <td>4471459.57</td>
      <td>POINT (273155.690 4471459.570)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>272889.96</td>
      <td>4471402.66</td>
      <td>POINT (272889.960 4471402.660)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>272627.77</td>
      <td>4471357.00</td>
      <td>POINT (272627.770 4471357.000)</td>
    </tr>
    <tr>
      <th>5</th>
      <td>272334.69</td>
      <td>4471315.93</td>
      <td>POINT (272334.690 4471315.930)</td>
    </tr>
    <tr>
      <th>6</th>
      <td>271986.81</td>
      <td>4471271.98</td>
      <td>POINT (271986.810 4471271.980)</td>
    </tr>
    <tr>
      <th>7</th>
      <td>271693.17</td>
      <td>4471242.75</td>
      <td>POINT (271693.170 4471242.750)</td>
    </tr>
    <tr>
      <th>8</th>
      <td>271364.28</td>
      <td>4471193.71</td>
      <td>POINT (271364.280 4471193.710)</td>
    </tr>
    <tr>
      <th>9</th>
      <td>270979.83</td>
      <td>4471147.29</td>
      <td>POINT (270979.830 4471147.290)</td>
    </tr>
    <tr>
      <th>10</th>
      <td>270558.81</td>
      <td>4471098.37</td>
      <td>POINT (270558.810 4471098.370)</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Now, with <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> and <code class="docutils literal notranslate"><span class="pre">Rasterio</span></code> together we can use the point shapefile to extract information from the 20m resolution NDVI raster and the average NDVI per municipality contained in the extraction_points.gpkg shapefile.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span>

<span class="c1"># Load the extraction points GeoPackage</span>
<span class="n">pnt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;files/extraction_points.gpkg&quot;</span><span class="p">)</span>

<span class="c1"># Load the 20m resolution NDVI raster</span>
<span class="n">ndvi_raster_path</span> <span class="o">=</span> <span class="s2">&quot;files/Lecce_NDVI.tif&quot;</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ndvi_raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># Ensure the points&#39; CRS matches the raster&#39;s CRS</span>
    <span class="n">pnt</span> <span class="o">=</span> <span class="n">pnt</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Function to extract raster value at point</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_ndvi_value</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="c1"># Extract raster value at point location</span>
        <span class="n">point</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
        <span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span>

    <span class="c1"># Apply extraction function to points</span>
    <span class="n">pnt</span><span class="p">[</span><span class="s1">&#39;ndvi_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnt</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">extract_ndvi_value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Load the mean NDVI vector file</span>
<span class="n">gdf_mean_ndvi</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;files/confini_comunali_Salento/mean_NDVI_Salento.gpkg&quot;</span><span class="p">)</span>

<span class="c1"># Ensure that both GeoDataFrames have the same CRS</span>
<span class="n">gdf_mean_ndvi</span> <span class="o">=</span> <span class="n">gdf_mean_ndvi</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">pnt</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="c1"># Function to extract mean NDVI value from the mean NDVI shapefile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_mean_ndvi</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="c1"># This function will get the value from the &#39;mean_ndvi&#39; attribute</span>
    <span class="c1"># In this case, being all polygons we will use spatial join</span>
    <span class="c1"># Starting find the polygon that contains the point and extract the mean_ndvi value</span>
    <span class="n">containing_polygon</span> <span class="o">=</span> <span class="n">gdf_mean_ndvi</span><span class="p">[</span><span class="n">gdf_mean_ndvi</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="p">)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">containing_polygon</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">containing_polygon</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;mean_ndvi&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># In case no polygon is found, return None</span>

<span class="c1"># Apply the extraction function to points</span>
<span class="n">pnt</span><span class="p">[</span><span class="s1">&#39;mean_ndvi_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnt</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">extract_mean_ndvi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Check for duplicate column names and remove any if necessary</span>
<span class="n">pnt</span> <span class="o">=</span> <span class="n">pnt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">pnt</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>

<span class="c1"># Save the updated GeoDataFrame to as a new GeoPackage</span>
<span class="n">pnt</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s2">&quot;files/extraction_points_NDVI.gpkg&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GeoPackage with NDVI values has been saved successfully.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
GeoPackage with NDVI values has been saved successfully.
</pre></div></div>
</div>
<p>Let’s check the results</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NDVI_pnt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;files/extraction_points_NDVI.gpkg&quot;</span><span class="p">)</span>
<span class="n">NDVI_pnt</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>ndvi_value</th>
      <th>mean_ndvi_value</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>273428.62</td>
      <td>4471528.55</td>
      <td>0.329571</td>
      <td>0.158953</td>
      <td>POINT (273428.620 4471528.550)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>273333.06</td>
      <td>4471504.63</td>
      <td>-0.051338</td>
      <td>0.158953</td>
      <td>POINT (273333.060 4471504.630)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>273155.69</td>
      <td>4471459.57</td>
      <td>0.361765</td>
      <td>0.158953</td>
      <td>POINT (273155.690 4471459.570)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>272889.96</td>
      <td>4471402.66</td>
      <td>0.457857</td>
      <td>0.158953</td>
      <td>POINT (272889.960 4471402.660)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>272627.77</td>
      <td>4471357.00</td>
      <td>0.410326</td>
      <td>0.158953</td>
      <td>POINT (272627.770 4471357.000)</td>
    </tr>
    <tr>
      <th>5</th>
      <td>272334.69</td>
      <td>4471315.93</td>
      <td>0.318457</td>
      <td>0.158953</td>
      <td>POINT (272334.690 4471315.930)</td>
    </tr>
    <tr>
      <th>6</th>
      <td>271986.81</td>
      <td>4471271.98</td>
      <td>0.392727</td>
      <td>0.158953</td>
      <td>POINT (271986.810 4471271.980)</td>
    </tr>
    <tr>
      <th>7</th>
      <td>271693.17</td>
      <td>4471242.75</td>
      <td>0.412121</td>
      <td>0.158953</td>
      <td>POINT (271693.170 4471242.750)</td>
    </tr>
    <tr>
      <th>8</th>
      <td>271364.28</td>
      <td>4471193.71</td>
      <td>0.330433</td>
      <td>0.158953</td>
      <td>POINT (271364.280 4471193.710)</td>
    </tr>
    <tr>
      <th>9</th>
      <td>270979.83</td>
      <td>4471147.29</td>
      <td>0.340979</td>
      <td>0.158953</td>
      <td>POINT (270979.830 4471147.290)</td>
    </tr>
    <tr>
      <th>10</th>
      <td>270558.81</td>
      <td>4471098.37</td>
      <td>0.071696</td>
      <td>0.195418</td>
      <td>POINT (270558.810 4471098.370)</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="line-block">
<div class="line">Everything seems correct.</div>
<div class="line">Then we move to a fancy visualization of collected data.</div>
<div class="line">To better express points data we will plot jointly:</div>
</div>
<ul class="simple">
<li><p>a <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> histogram which will show the trend of NDVI values and the average for each point;</p></li>
<li><p>a geospatial plot using <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> and <code class="docutils literal notranslate"><span class="pre">Rasterio</span></code> of an NDVI raster excerpt at 20m resolution, from which the values were extracted, with focus detail on the extraction points area.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span>

<span class="c1"># Load the data</span>
<span class="n">NDVI_pnt</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;files/extraction_points_NDVI.gpkg&quot;</span><span class="p">)</span>

<span class="c1"># Open the raster file</span>
<span class="n">raster_path</span> <span class="o">=</span> <span class="s1">&#39;files/Lecce_NDVI.tif&#39;</span>
<span class="n">raster_path_resized</span> <span class="o">=</span> <span class="s1">&#39;files/Lecce_NDVI_resized.tif&#39;</span> <span class="c1"># just in case of some memory issues</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># Extract raster bounds to determine the extent for zooming in</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>

    <span class="c1"># Zooming into the bounding box around the points&#39; coordinates</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">NDVI_pnt</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">total_bounds</span>

    <span class="c1"># Create the figure with 2 subplots: one for histograms and one for the map</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="c1"># Plot the histograms of &#39;ndvi_value&#39; and &#39;mean_ndvi_value&#39; for each point</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">NDVI_pnt</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">NDVI_pnt</span><span class="p">[</span><span class="s1">&#39;ndvi_value&#39;</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NDVI Value&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

    <span class="c1"># that +0.4 is used to slightly shift the bars so they dont overlap</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">NDVI_pnt</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">,</span>
                <span class="n">NDVI_pnt</span><span class="p">[</span><span class="s1">&#39;mean_ndvi_value&#39;</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean NDVI Value&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Point Index&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;NDVI Value&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;NDVI and Mean NDVI Values for Each Point&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Set x-axis ticks with a step of 1</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">NDVI_pnt</span><span class="p">)))</span>

    <span class="c1"># Plot the raster map with the points</span>
    <span class="n">show</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s2">&quot;NDVI Map with Extraction Points&quot;</span><span class="p">)</span>

    <span class="c1"># Add the points to the map</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">NDVI_pnt</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                    <span class="n">NDVI_pnt</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Extraction Points&#39;</span><span class="p">)</span>

    <span class="c1"># Add the point IDs above each point</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">NDVI_pnt</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                     <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span>
                     <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

    <span class="c1"># Set zoom limits based on the extent of the points</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Adjust zoom window as necessary</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">min_y</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="c1"># Add a legend for the raster map</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

    <span class="c1"># Show the plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_75_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_75_0.png" />
</div>
</div>
<div class="line-block">
<div class="line">Now let’s try working with another type of vector shape.</div>
<div class="line">Let’s try to create a polyline from the extraction_points used earlier, after which we create a 100m buffer around it.</div>
<div class="line">To do this we use <code class="docutils literal notranslate"><span class="pre">Geopandas</span></code> and <code class="docutils literal notranslate"><span class="pre">LineString</span></code>.</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineString</span>

<span class="c1"># Creating a polyline from points</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;files/extraction_points.gpkg&quot;</span><span class="p">)</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Save polyline as GeoPackage</span>
<span class="n">line_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">points</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">line_gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s2">&quot;files/section_line.gpkg&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">)</span>

<span class="c1"># Create a 100m buffer around the polyline to make it a precise polygonal area</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">buffer_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">buffer</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">points</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="line-block">
<div class="line">Let’s start by using the polyline.</div>
<div class="line">With the polyline, it is possible to do a multiple capillary extraction from the NDVI raster, in order to plot a index profile along the path.</div>
<div class="line">This is no different from the extraction we did previously for points only, but now using both <code class="docutils literal notranslate"><span class="pre">LineString</span></code> and <code class="docutils literal notranslate"><span class="pre">Point</span></code> from <code class="docutils literal notranslate"><span class="pre">shapely.geometry</span></code> together with <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>.</div>
<div class="line">We will also plot the extraction points as a reference during the profile.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># File paths</span>
<span class="n">ndvi_path</span> <span class="o">=</span> <span class="s2">&quot;files/Lecce_NDVI.tif&quot;</span>
<span class="n">polyline_path</span> <span class="o">=</span> <span class="s2">&quot;files/section_line.gpkg&quot;</span>
<span class="n">points_path</span> <span class="o">=</span> <span class="s1">&#39;files/extraction_points_NDVI.gpkg&#39;</span>

<span class="c1"># read NDVI raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ndvi_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">ndvi_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Band 1</span>
    <span class="n">ndvi_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

<span class="c1"># read polyline and points geopackage</span>
<span class="n">gdf_line</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">polyline_path</span><span class="p">)</span>
<span class="n">gdf_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">points_path</span><span class="p">)</span>

<span class="c1"># Extract polyline from the GeoDataFrame (starting from the first row)</span>
<span class="n">polyline</span> <span class="o">=</span> <span class="n">gdf_line</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># function to extract NDVI values along the polyline</span>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_ndvi_along_line</span><span class="p">(</span><span class="n">polyline</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">polyline</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">polyline</span><span class="o">.</span><span class="n">length</span> <span class="o">//</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">polyline</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">]</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="n">ndvi_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">coords</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">distances</span><span class="p">,</span> <span class="n">ndvi_values</span><span class="p">,</span> <span class="n">points</span>

<span class="c1"># extract NDVI values along the polyline</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ndvi_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">distances</span><span class="p">,</span> <span class="n">ndvi_values</span><span class="p">,</span> <span class="n">line_points</span> <span class="o">=</span> <span class="n">extract_ndvi_along_line</span><span class="p">(</span><span class="n">polyline</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

<span class="c1"># Find extraction points on the polyline</span>
<span class="n">point_distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">polyline</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>

<span class="c1"># Plot NDVI profile</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">ndvi_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NDVI polyline&#39;</span><span class="p">)</span>

<span class="c1"># Add labels for extraction points</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">point_distances</span><span class="p">,</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">iterrows</span><span class="p">())):</span>
    <span class="n">value_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distances</span> <span class="o">-</span> <span class="n">dist</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">ndvi_values</span><span class="p">[</span><span class="n">value_idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;extraction point&#39;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">ndvi_values</span><span class="p">[</span><span class="n">value_idx</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.009</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

<span class="c1"># Graph details</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Distance from Extraction Point 0 along the polyline (m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;NDVI value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;NDVI Profile along the polyline&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_79_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_79_0.png" />
</div>
</div>
<div class="line-block">
<div class="line">After creating the polyline and buffer area we can try plotting them using again <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> and <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>.</div>
<div class="line">In this case we will try a fancy plot displaying also the 20m resolution NDVI raster as basemap, complete with legend and coordinate references on the axes.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[101]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>

<span class="c1"># Visualize the polyline on the NDVI map</span>
<span class="n">raster_path</span> <span class="o">=</span> <span class="s1">&#39;files/Lecce_NDVI.tif&#39;</span>
<span class="n">raster_path_resized</span> <span class="o">=</span> <span class="s1">&#39;files/Lecce_NDVI_resized.tif&#39;</span> <span class="c1"># for memory issues</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">show</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>

    <span class="c1"># Plot the polyline and its buffer</span>
    <span class="n">line_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">buffer_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Create custom legend:</span>
    <span class="c1"># Legend for the polyline</span>
    <span class="n">polyline_leg</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Polyline&#39;</span><span class="p">)</span>

    <span class="c1"># Legend for the buffer area</span>
    <span class="n">buffer_leg</span> <span class="o">=</span> <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buffer (100m)&#39;</span><span class="p">)</span>

    <span class="c1"># Compose legend items</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">buffer_leg</span><span class="p">,</span> <span class="n">polyline_leg</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

    <span class="c1"># Detail zoom on the polyline area</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">line_gdf</span><span class="o">.</span><span class="n">total_bounds</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">minx</span> <span class="o">-</span> <span class="mi">200</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">+</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">miny</span> <span class="o">-</span> <span class="mi">200</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting (m)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing (m)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_81_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_81_0.png" />
</div>
</div>
<p>We can use this newly created buffer area to clip the NDVI raster.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.mask</span><span class="w"> </span><span class="kn">import</span> <span class="n">mask</span>

<span class="c1"># Cropping the NDVI raster using the buffer</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ndvi_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">out_image</span><span class="p">,</span> <span class="n">out_transform</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="n">buffer</span><span class="p">],</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set NoData values to 255</span>
    <span class="n">out_image</span><span class="p">[</span><span class="n">out_image</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="c1"># Copy the profile of the original raster and update</span>
    <span class="n">out_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">out_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">out_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">out_transform</span><span class="p">,</span>
        <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="mi">255</span>  <span class="c1"># Set NoData value to 255</span>
    <span class="p">})</span>

    <span class="c1"># Save the raster crop</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="s1">&#39;files/section_line_NDVI.tif&#39;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_image</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cropping saved in &quot;</span><span class="p">,</span> <span class="n">out_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Cropping saved in  files/section_line_NDVI.tif
</pre></div></div>
</div>
<div class="line-block">
<div class="line">In the end we can plot the buffer area cropped 20m resolution NDVI along with the extraction points used into the creation of the polyline, again using <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> and <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>.</div>
<div class="line">In this case we will keep transparency for crop process nodata pixels.</div>
<div class="line">Also this plot will have legend and coordinate references on the axes.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># Paths</span>
<span class="n">raster_path</span> <span class="o">=</span> <span class="s1">&#39;files/section_line_NDVI.tif&#39;</span>
<span class="n">points_path</span> <span class="o">=</span> <span class="s1">&#39;files/extraction_points.gpkg&#39;</span>

<span class="c1"># Read the raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># nodata are forcefully read as &#39;0&#39; instead of &#39;255&#39;, so we filter the data=&#39;0&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Get the spatial extent for the plot</span>
    <span class="n">spatial_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">top</span><span class="p">]</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">chm_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">spatial_extent</span><span class="p">)</span>

<span class="c1"># Plot the vector points (extraction points)</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">points_path</span><span class="p">)</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Add the point IDs above each point</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                 <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span>
                 <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                 <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

<span class="c1"># Add legend (colorbar) with custom legend_kwds</span>
<span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">chm_plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
<span class="n">colorbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;NDVI value&quot;</span><span class="p">)</span>

<span class="c1"># Add gridlines</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Easting (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Northing (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;NDVI along the polyline buffer area with extraction points&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="c1"># Detail zoom on the polyline area</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">minx</span> <span class="o">-</span> <span class="mi">200</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">+</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">miny</span> <span class="o">-</span> <span class="mi">200</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">+</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/PYTHON_Python_geospatial_data_analysis_SM_85_0.png" src="../_images/PYTHON_Python_geospatial_data_analysis_SM_85_0.png" />
</div>
</div>
</section>
</section>
<section id="4---Exercise">
<h2><strong>4 - Exercise</strong><a class="headerlink" href="#4---Exercise" title="Link to this heading"></a></h2>
<section id="Spatial-Data-Visualization-and-Analysis">
<h3>Spatial Data Visualization and Analysis<a class="headerlink" href="#Spatial-Data-Visualization-and-Analysis" title="Link to this heading"></a></h3>
<p>Write code and document your process in Markdown cells.</p>
</section>
<section id="Input">
<h3><strong>Input</strong><a class="headerlink" href="#Input" title="Link to this heading"></a></h3>
<ol class="arabic simple">
<li><p><strong>Dataset Import</strong></p></li>
</ol>
<ul class="simple">
<li><p>Choose a publicly available shapefile (.gpkg, .shp etc) and raster file (.tif, .jp2 etc) or</p></li>
<li><p>Use the provided raster and shapefiles used in this lesson.</p></li>
</ul>
</section>
<section id="Operations:">
<h3><strong>Operations:</strong><a class="headerlink" href="#Operations:" title="Link to this heading"></a></h3>
<ol class="arabic simple" start="2">
<li><p><strong>Geospatial Data Handling with GeoPandas</strong></p></li>
</ol>
<ul class="simple">
<li><p>Load the vector data file using GeoPandas.</p></li>
<li><p>Explore the dataset using gdf.info(), gdf.head(), and gdf.describe().</p></li>
<li><p>Extract relevant features (e.g., a specific polygon or point geometry) from the GeoDataFrame.</p></li>
<li><p>Create a buffer around a specific polygon feature and store it in a new column.</p></li>
<li><p>Perform spatial operations, such as overlaying vector data and extracting points inside the polygon.</p></li>
<li><p>Plot the vector data on a map with GeoPandas.</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p><strong>NDVI Profile Extraction with Rasterio</strong></p></li>
</ol>
<ul class="simple">
<li><p>Read a raster using Rasterio.</p></li>
<li><p>Extract pixel values along a defined line (e.g., a transect) using spatial interpolation (similar to previous examples).</p></li>
<li><p>Handle missing or NoData values from the raster by setting them to a specific value (e.g., 255) and applying masking techniques.</p></li>
<li><p>Plot the pixel values profile along the transect using Matplotlib or Seaborn.</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p><strong>Data Visualization with Matplotlib and Seaborn</strong></p></li>
</ol>
<ul class="simple">
<li><p>Create visualizations to explore the relationship between pixel values and specific spatial features (e.g., elevation, land use, or vegetation type).</p></li>
<li><p>Customize the plot by adding labels, titles, gridlines, and a legend.</p></li>
<li><p>Add a Seaborn heatmap or scatterplot to visualize the distribution of pixel values across different areas of the study region.</p></li>
</ul>
</section>
<section id="Output">
<h3><strong>Output</strong><a class="headerlink" href="#Output" title="Link to this heading"></a></h3>
<p>Save any type of output resulting from the processing and analysis of rasters and shapefiles in: &gt;exercise/result.csv</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Do you exercise here:</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Python_data_analysis_SM.html" class="btn btn-neutral float-left" title="Python data analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="RasterIO_Intro.html" class="btn btn-neutral float-right" title="RasterIO for dummies: a brief intro to a pythonic raster library" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Giuseppe Amatulli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>