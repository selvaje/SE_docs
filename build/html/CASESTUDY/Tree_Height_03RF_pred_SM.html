

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estimation of tree height using GEDI dataset - Random Forest prediction &mdash; Spatial Ecology&#39;s code documentation 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css?v=572af1d6" />
      <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Estimation of tree height using GEDI dataset - Support Vector Machine for Regression (SVR) - 2022" href="Tree_Height_04SVM_pred_2022.html" />
    <link rel="prev" title="Estimation of tree height using GEDI dataset - Predictors extraction at point location" href="Tree_Height_02Predictors_extraction.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Spatial Ecology's code documentation
              <img src="../_static/SE_compact.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">COURSE TRAINERS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../COURSETRAINERS/trainers.html">Spatial Ecology course trainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">COURSES AROUND THE WORLD</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_wcsu_02-04_2021.html">Western Connecticut State University 2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_stock_uni_04-05_2021.html">Stockholm University 2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_ml_04-05_2022.html">GeoComp &amp; ML 2022 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_modelling_10-11_2022.html">GeoComp &amp; Modelling 2022 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_ml_04-05_2023.html">GeoComp &amp; ML 2023 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_ml_04-05_2024.html">GeoComp &amp; ML 2024 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_GEO-OPEN-HACK-2024_06_2024.html">GEO-OPEN-HACK-2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_11-12_2024.html">GeoComp 2024 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_geoanlysis_04_2025.html">Geo Comp/Analysis 2025 course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COURSESAROUNDTHEWORLD/course_geocomp_ml_09-11_2025.html">GeoComp &amp; ML 2025 course</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GEO DATA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../GEODATA/geomorpho90m/geomorpho90m.html">Geomorpho90m: technical documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">LINUX VIRTUAL MACHINE</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../VIRTUALMACHINE/Setting_Ubuntu24.04_for_Spatial_Ecology_course.html">Prepare Ubuntu 24.04 for Spatial Ecology courses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VIRTUALMACHINE/Setting_Colab_for_Spatial_Ecology_course.html">Prepare Colab for Spatial Ecology courses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VIRTUALMACHINE/Setting_OSGeoLive_for_Spatial_Ecology_course.html">Prepare OSGeoLive for Spatial Ecology courses</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WEB SEMINARS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../WEBSEMINAR/webseminar.html">Raster/Vector Processing using GDAL/OGR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WEBSEMINAR/webseminar.html#image-processing-using-pktools">Image Processing using Pktools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WEBSEMINAR/webseminar.html#introduction-to-grass-gis">Introduction to GRASS GIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WEBSEMINAR/webseminar.html#geocomputation-with-high-performance-computing">GeoComputation with High Performance Computing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">BASH</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../BASH/bashintro_osgeo.html">Linux Operation System as a base for Spatial Ecology Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BASH/bashinter_osgeo.html">Manipulate text files in bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BASH/bashxargs_osgeo.html">Multi-core bash</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AWK</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../AWK/awk.html">AWK Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GDAL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../GDAL/gdal_osgeo.html">Use GDAL/OGR for raster/vector operations - osgeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GDAL/gdal_colab.html">Use GDAL/OGR for raster/vector operations - colab</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PKTOOLS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pktools_osgeo.html">Use PKTOOLS for raster/vector operations - osgeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pktools_colab.html">Use PKTOOLS for raster/vector operations - colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pyjeo_introduction1.html">Introduction to pyjeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pyjeo_introduction2.html">pyjeo: an open source image processing library in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pyjeo_pktools.html">Performing raster and vector operations in Python using pyjeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PKTOOLS/pyjeo_upscaling_surf.html">Scaling-up: batch processing on the cluster with pyjeo</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">R</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../R/R_Intro.html">R Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PYTHON</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../PYTHON/PythonEnvs.html">Python environments or how to survive to your journey in the geodata space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PYTHON/Python_Intro.html">Introduction to Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PYTHON/Geo_Python.html">Python &amp; GeoComputation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PYTHON/Python_data_analysis_SM.html">Python data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PYTHON/Python_geospatial_data_analysis_SM.html">Python geospatial data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PYTHON/RasterIO_Intro.html">RasterIO for dummies: a brief intro to a <em>pythonic</em> raster library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PYTHON/RasterIO_Intro.html#2.-Preparing-the-dataset-for-next-ML-exercises-via-rasterio">2. Preparing the dataset for next ML exercises via rasterio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PYTHON/RasterIO_Intro.html#3.-Beyond-the-basics">3. Beyond the basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PYTHON/OGCSQL.html">Generalities about OGC Geospatial extensions for SQL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GRASS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_intro.html">GRASS Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_newproject.html">Start a new GRASS project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_hydro.html">Using GRASS for stream-network extraction and basins delineation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_hydro_osboxes.html">Using GRASS for stream-network extraction and basins delineation - osboxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/grass_hydro_colab.html">Using GRASS for stream-network extraction and basins delineation in Colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/SDM1_MWood_gecomp4GRASS.html">SDM1 : Montane woodcreper - Gecomputation for the Random Forest model using GRASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GRASS/SDM1_MWood_GRASSmodel.html">SDM1 : Montane woodcreper - Random Forest Model using GRASS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HIGH PERFORMANCE COMPUTING</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../HPC/hpc_setting.html">Geocomputation at High Performance Computing Cluster (HPC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HPC/hpc_setting_grass.html">Use of GRASS in HPC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ASSIGNMENTS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ASSIGNMENTS/assignment_fall2022_solutions.html">Assignments Fall 2022</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CASE STUDY</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="SDM1_MWood_gecomp.html">SDM1 : Montane woodcreper - Gecomputation</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDM1_MWood_Rmodel.html">SDM1 : Montane woodcreper - Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDM1_MWood_gecomp4GRASS.html">SDM1 : Montane woodcreper - Gecomputation for the Random Forest model using GRASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDM1_MWood_GRASSmodel.html">SDM1 : Montane woodcreper - Random Forest Model using GRASS</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDM2_Vath_Rmodel.html">SDM2 : Varied Thrush - Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="manipulate_GSIM.html">Manipulate GSIM files</a></li>
<li class="toctree-l1"><a class="reference internal" href="Data_type_GTiff.html">Data type in GTiff</a></li>
<li class="toctree-l1"><a class="reference internal" href="temporal_interpolation.html">Temporal interpolation of landsat images</a></li>
<li class="toctree-l1"><a class="reference internal" href="DTW.html">Dynamic Time Warping</a></li>
<li class="toctree-l1"><a class="reference internal" href="pred_NP.html">Estimating nitrogen and phosphorus concentrations in streams and rivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="NN-day1.html">Estimating nitrogen concentrations in streams and rivers using NN</a></li>
<li class="toctree-l1"><a class="reference internal" href="NN-day2.html">Autoencoder (AE), Variational Autoencoder (VAE) and Generative Adversarial Network (GAN)</a></li>
<li class="toctree-l1"><a class="reference internal" href="NN-day3.html">LSTM Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_01DataExplore.html">Estimation of tree height using GEDI dataset - Data explore</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_02Predictors_extraction.html">Estimation of tree height using GEDI dataset - Predictors extraction at point location</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Estimation of tree height using GEDI dataset - Random Forest prediction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Jupyterlab-setup-and-libraries-retrieving-[Just-for-UBUNTU-24.04]">Jupyterlab setup and libraries retrieving <strong>[Just for UBUNTU 24.04]</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#Jupyterlab-setup-and-libraries-retrieving-[Just-for-OSGEOLIVE16]">Jupyterlab setup and libraries retrieving <strong>[Just for OSGEOLIVE16]</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#Data-retrieving-(&gt;3GB)">Data retrieving (&gt;3GB)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Open-the-notebook-lesson">Open the notebook lesson</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Model-definition">Model definition</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Different-types-of-models">Different types of models</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Random-forest">Random forest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Random-Forest-test"><strong>Random Forest test</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="#Data-analysis">Data analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Data-set-splitting">Data set splitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Random-Forest-default-parameters">Random Forest default parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Model-tuning-whith-Hyperparameters-Tweeking">Model tuning whith Hyperparameters Tweeking</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Model-tuning-with-data-selection">Model tuning with data selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Model-run-using-default-parameters-and-wuality-flag-selected-data">Model run using default parameters and wuality flag selected data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Model-Final-Assesment">Model Final Assesment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Model-Prediction-on-Raster">Model Prediction on Raster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Predict-on-the-raster-using-pyspatialml-(deprecated-library)">Predict on the raster using pyspatialml (deprecated library)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Predict-on-the-raster-using-xarray-and-rasterio-(Full-size-90m-res-raster-prediction-&gt;12h)">Predict on the raster using xarray and rasterio (Full size 90m res raster prediction &gt;12h)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Predict-on-the-raster-using-xarray-and-rasterio-(1000x1000-UL-corner-tile-for-90m-res-raster-prediction)">Predict on the raster using xarray and rasterio (1000x1000 UL corner tile for 90m res raster prediction)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_04SVM_pred_2022.html">Estimation of tree height using GEDI dataset - Support Vector Machine for Regression (SVR) - 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_04SVM_pred_2023.html">Estimation of tree height using GEDI dataset - Support Vector Machine for Regression (SVR) - 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_04SVM_pred_2024.html">Estimation of tree height using GEDI dataset - Support Vector Machine for Regression (SVR) - 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_04SVM_pred_2024.html#Exercise:-explore-the-other-parameters-offered-by-the-SVM-library-and-try-to-make-the-model-better.-Some-suggestions:">Exercise: explore the other parameters offered by the SVM library and try to make the model better. Some suggestions:</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_05Perceptron_pred_2022.html">Estimation of tree height using GEDI dataset - Perceptron 1 - 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_05Perceptron_intro_2023.html">Estimation of tree height using GEDI dataset - Perceptron 1 - 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_05Perceptron_intro_2024.html">Estimation of tree height using GEDI dataset - Perceptron - 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_06Perceptron_pred_2023.html">Estimation of tree height using GEDI dataset - Perceptron tree prediction - 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_06Perceptron_complete_2024.html">Estimation of tree height using GEDI dataset - Perceptron complete - 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_05Perceptron_pred_clean_2022.html">Estimation of tree height using GEDI dataset - Clean Data - Perceptron 2 - 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_06NeuralNets_pred.html">Estimation of tree height using GEDI dataset - Neural Network 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tree_Height_07FeedForward_Networks_2024.html">Estimation of tree height using GEDI dataset - Neural Network 1 - 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="NNs_pt3_SHAP.html">Neural Nets (pt.3), Interpretability and Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="CNN_satelite_2022.html">Using Multi-layer Perceptron and Convolutional Neural Networks for Satellite image classification - 2022.</a></li>
<li class="toctree-l1"><a class="reference internal" href="CNN_satelite_2023.html">Using Multi-layer Perceptron and Convolutional Neural Networks for Satellite image classification - 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="CNN_satelite_2023.html#Using-CNNs-for-a-image-dataset">Using CNNs for a image dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="foundation_model_IIASA2024.html">Prithvi 100M model</a></li>
<li class="toctree-l1"><a class="reference internal" href="foundation_model_IIASA2024.html#Proposed-exercises">Proposed exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="NN_Unsupervised_2024.html">Autoencoder (AE), Variational Autoencoder (VAE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="NN_Unsupervised_2024.html#Implementing-an-Autoencoder">Implementing an Autoencoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="NN_Unsupervised_2024.html#Autoencoding-MNIST">Autoencoding MNIST</a></li>
<li class="toctree-l1"><a class="reference internal" href="NN_Unsupervised_2024.html#Section-2">Section 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="NN_Unsupervised_2024.html#Section-3---Generative-Models">Section 3 - Generative Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="LSTMs_tutorial.html">Using LSTM for time-series predictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="CNN_satelite_with_GPT_code_2023.html">Using GPT to implement a Convolutional Neural Networks for Satellite image classification.</a></li>
<li class="toctree-l1"><a class="reference internal" href="Classification_pyjeo_sklearn_2023.html">Classification in Python using pyjeo and sklearn</a></li>
<li class="toctree-l1"><a class="reference internal" href="GEEviaPython_2023.html">Google Earth Engine use via Python, containers and other mythical beasts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Students Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../STUDENTSPROJECTS/index.html">1. 2021 SWEDEN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../STUDENTSPROJECTS/index.html#matera">2. 2022 MATERA</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">OUTDOOR</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../OUTDOOR/outdoor_orientering.html">Do not get lost in the wilderness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OUTDOOR/outdoor_info.html">Shelter locations close to Gioia del Colle (BA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OUTDOOR/bike_accomodation.html">Accomodation in Gioia del Colle (BA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OUTDOOR/puglia_discover.html">Discover Puglia by bike!</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TALKS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../TALKS/intelligent_modelling.html">Intelligent modelling in time and space: combine GeoComputation and Machine Learning for  environmental application.</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ADMIN</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ADMIN/00_pktools_gdrive_install.html">Install pktools on the gdrive and be able to use from any Colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ADMIN/video.html">Video tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ADMIN/Compiling_OTB.html">Compiling OTB from source</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Spatial Ecology's code documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">&lt;no title&gt;</a></li>
      <li class="breadcrumb-item active">Estimation of tree height using GEDI dataset - Random Forest prediction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/CASESTUDY/Tree_Height_03RF_pred_SM.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Estimation-of-tree-height-using-GEDI-dataset---Random-Forest-prediction">
<h1>Estimation of tree height using GEDI dataset - Random Forest prediction<a class="headerlink" href="#Estimation-of-tree-height-using-GEDI-dataset---Random-Forest-prediction" title="Link to this heading"></a></h1>
<section id="Jupyterlab-setup-and-libraries-retrieving-[Just-for-UBUNTU-24.04]">
<h2>Jupyterlab setup and libraries retrieving <strong>[Just for UBUNTU 24.04]</strong><a class="headerlink" href="#Jupyterlab-setup-and-libraries-retrieving-[Just-for-UBUNTU-24.04]" title="Link to this heading"></a></h2>
<p>To run this lesson properly on osboxes.org you need to have a clean install of jupyterlab using the command line. If you didn’t do it for the previous lesson (Python data analysis or Python geospatial analysis), do it for this one, directly on the terminal:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pipx uninstall jupyterlab
pipx install --system-site-packages jupyterlab
</pre></div>
</div>
<p>and just after that, you can procede to install python libraries, using the apt install always in the terminal:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo apt install python3-numpy python3-pandas python3-sklearn python3-matplotlib python3-rasterio python3-geopandas python3-seaborn python3-skimage python3-xarray
</pre></div>
</div>
</section>
<section id="Jupyterlab-setup-and-libraries-retrieving-[Just-for-OSGEOLIVE16]">
<h2>Jupyterlab setup and libraries retrieving <strong>[Just for OSGEOLIVE16]</strong><a class="headerlink" href="#Jupyterlab-setup-and-libraries-retrieving-[Just-for-OSGEOLIVE16]" title="Link to this heading"></a></h2>
<p>In order to run this notebook you need to run this command lines in your terminal:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>source $HOME/venv/bin/activate
sudo apt update
sudo apt install python3-pip
pip3 install pyspatialml
</pre></div>
</div>
<p>after that all other needed libraries directly on jupyter with the magic lines (!):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>!pip3 install &quot;pandas&gt;=2.2.2,&lt;3.0.0&quot; &quot;numpy&gt;=1.26.4,&lt;2.0.0&quot; &quot;rasterio&gt;=1.3.10,&lt;2.0.0&quot; &quot;scikit-learn&gt;=1.4.2,&lt;2.0.0&quot; &quot;scipy&gt;=1.13.0,&lt;2.0.0&quot; &quot;matplotlib&gt;=3.9.0,&lt;4.0.0&quot; &quot;xarray&gt;=2024.1.0,&lt;2025.0.0&quot;
</pre></div>
</div>
</section>
<section id="Data-retrieving-(&gt;3GB)">
<h2>Data retrieving (&gt;3GB)<a class="headerlink" href="#Data-retrieving-(>3GB)" title="Link to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd  /media/sf_LVM_shared/my_SE_data/exercise/
pipx install gdown
~/.local/bin/gdown 1Y60EuLsfmTICTX-U_FxcE1odNAf04bd-
tar -xvzf tree_height.tar.gz
</pre></div>
</div>
</section>
<section id="Open-the-notebook-lesson">
<h2>Open the notebook lesson<a class="headerlink" href="#Open-the-notebook-lesson" title="Link to this heading"></a></h2>
<p>Open the lesson using the CL</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd /media/sf_LVM_shared/my_SE_data/exercise
jupyter-lab Tree_Height_03RF_pred_SM.ipynb
</pre></div>
</div>
</section>
<section id="Model-definition">
<h2>Model definition<a class="headerlink" href="#Model-definition" title="Link to this heading"></a></h2>
<div class="line-block">
<div class="line">Find a relationship between tree height and enviromental predictors to be able to predict out side the GEDI observation.</div>
<div class="line">The model, in its simplest form, looks like the following:</div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>y ~ f ( a*x1 + b*x2 + c*x3 + …)  + ε,
</pre></div>
</div>
<p>where y is the <strong>response variable</strong>, the x’s are <strong>predictor variables</strong>, and ε is the <strong>associated error</strong>.</p>
<section id="Different-types-of-models">
<h3>Different types of models<a class="headerlink" href="#Different-types-of-models" title="Link to this heading"></a></h3>
<p>Parametric models – make assumptions about the underlying distribution of the data:</p>
<ul class="simple">
<li><p>Maximum likelihood classification,</p></li>
<li><p>Discriminant analysis,</p></li>
<li><p>General linear models (ex. linear regression)</p></li>
</ul>
<p>Nonparametric models – make no assumptions about the underlying data distributions:</p>
<ul class="simple">
<li><p>Generalized additive models,</p></li>
<li><p>Support Vector Machine,</p></li>
<li><p>Artificial neural networks,</p></li>
<li><p>Random Forest</p></li>
</ul>
</section>
</section>
<section id="Random-forest">
<h2>Random forest<a class="headerlink" href="#Random-forest" title="Link to this heading"></a></h2>
<p>Random forest is a Supervised Machine Learning Algorithm that is used widely in <strong>Classification</strong> (containing categorical variables) and <strong>Regression</strong> (response continuous variables) problems. It builds decision trees on different samples and takes their majority vote for classification and average in case of regression.</p>
<p>One of the most important features of the Random Forest Algorithm is that it can handle continuous and categorical variables predictors without any assamption on their data distribution, dimension, and even if the predictors are autocorrelated.</p>
<div class="line-block">
<div class="line"><strong>Bagging</strong></div>
<div class="line">Bagging, also known as Bootstrap Aggregation is the ensemble technique used by random forest. Choosesing a random sample from the data set it is creating a tree. Each tree is generated from the samples (Bootstrap Samples) provided by the Original Data with replacement known as row sampling. This step of row sampling with replacement is called bootstrap. Each is trained independently which generates results. The final output is based on majority voting after combining the results of all models.
This step which involves combining all the results and generating output based on majority voting is known as tree aggregation.</div>
</div>
<p><strong>Steps involved in random forest algorithm:</strong></p>
<ul>
<li><p>Step 1: In Random forest n number of random records are taken from the data set having k number of records.</p></li>
<li><p>Step 2: Individual decision trees are constructed for each sample.</p></li>
<li><div class="line-block">
<div class="line">Step 3: Each decision tree will generate an output.</div>
</div>
</li>
<li><p>Step 4: Final output is considered based on Majority Voting or Averaging for Classification and regression respectively.</p></li>
</ul>
<p>(source <a class="reference external" href="https://www.analyticsvidhya.com/blog/2021/06/understanding-random-forest/">https://www.analyticsvidhya.com/blog/2021/06/understanding-random-forest/</a>)</p>
<p><img alt="RandomForest" src="https://www.researchgate.net/publication/354354484/figure/fig4/AS:1080214163595269&#64;1634554534720/Illustration-of-random-forest-trees.jpg" /></p>
</section>
<section id="Random-Forest-test">
<h2><strong>Random Forest test</strong><a class="headerlink" href="#Random-Forest-test" title="Link to this heading"></a></h2>
<p>In this exercise we will use Random Forest Regression algorithm with the <a class="reference external" href="https://scikit-learn.org/stable/">sklearn</a> python package to estimage the tree height. In last step, we will see how it was possible to have a prediction on a raster using <a class="reference external" href="https://pyspatialml.readthedocs.io/en/latest/index.html">Pyspatialml</a> library (now deprecated) and how we can to the same but using the updated more robust <a class="reference external" href="https://docs.xarray.dev/en/stable/getting-started-guide/index.html">Xarray</a> and
<a class="reference external" href="https://rasterio.readthedocs.io/en/stable/intro.html">Rasterio</a> libraries for the spatial prediction on the raster files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span><span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">6.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Data-analysis">
<h2>Data analysis<a class="headerlink" href="#Data-analysis" title="Link to this heading"></a></h2>
<p>Before everything we need to import the raw data, within the extracted predictors and show whole the data distribution</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;tree_height/txt/eu_x_y_height_predictors_select.txt&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>  <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># change column name</span>
<span class="n">predictors</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;dev-magnitude&#39;</span><span class="p">:</span><span class="s1">&#39;devmagnitude&#39;</span><span class="p">}</span> <span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
<span class="n">predictors</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>X</th>
      <th>Y</th>
      <th>h</th>
      <th>BLDFIE_WeigAver</th>
      <th>CECSOL_WeigAver</th>
      <th>CHELSA_bio18</th>
      <th>CHELSA_bio4</th>
      <th>convergence</th>
      <th>cti</th>
      <th>devmagnitude</th>
      <th>eastness</th>
      <th>elev</th>
      <th>forestheight</th>
      <th>glad_ard_SVVI_max</th>
      <th>glad_ard_SVVI_med</th>
      <th>glad_ard_SVVI_min</th>
      <th>northness</th>
      <th>ORCDRC_WeigAver</th>
      <th>outlet_dist_dw_basin</th>
      <th>SBIO3_Isothermality_5_15cm</th>
      <th>SBIO4_Temperature_Seasonality_5_15cm</th>
      <th>treecover</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>6.050001</td>
      <td>49.727499</td>
      <td>3139.00</td>
      <td>1540</td>
      <td>13</td>
      <td>2113</td>
      <td>5893</td>
      <td>-10.486560</td>
      <td>-238043120</td>
      <td>1.158417</td>
      <td>0.069094</td>
      <td>353.983124</td>
      <td>23</td>
      <td>276.871094</td>
      <td>46.444092</td>
      <td>347.665405</td>
      <td>0.042500</td>
      <td>9</td>
      <td>780403</td>
      <td>19.798992</td>
      <td>440.672211</td>
      <td>85</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>6.050002</td>
      <td>49.922155</td>
      <td>1454.75</td>
      <td>1491</td>
      <td>12</td>
      <td>1993</td>
      <td>5912</td>
      <td>33.274361</td>
      <td>-208915344</td>
      <td>-1.755341</td>
      <td>0.269112</td>
      <td>267.511688</td>
      <td>19</td>
      <td>-49.526367</td>
      <td>19.552734</td>
      <td>-130.541748</td>
      <td>0.182780</td>
      <td>16</td>
      <td>772777</td>
      <td>20.889412</td>
      <td>457.756195</td>
      <td>85</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>6.050002</td>
      <td>48.602377</td>
      <td>853.50</td>
      <td>1521</td>
      <td>17</td>
      <td>2124</td>
      <td>5983</td>
      <td>0.045293</td>
      <td>-137479792</td>
      <td>1.908780</td>
      <td>-0.016055</td>
      <td>389.751160</td>
      <td>21</td>
      <td>93.257324</td>
      <td>50.743652</td>
      <td>384.522461</td>
      <td>0.036253</td>
      <td>14</td>
      <td>898820</td>
      <td>20.695877</td>
      <td>481.879700</td>
      <td>62</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>6.050009</td>
      <td>48.151979</td>
      <td>3141.00</td>
      <td>1526</td>
      <td>16</td>
      <td>2569</td>
      <td>6130</td>
      <td>-33.654274</td>
      <td>-267223072</td>
      <td>0.965787</td>
      <td>0.067767</td>
      <td>380.207703</td>
      <td>27</td>
      <td>542.401367</td>
      <td>202.264160</td>
      <td>386.156738</td>
      <td>0.005139</td>
      <td>15</td>
      <td>831824</td>
      <td>19.375000</td>
      <td>479.410278</td>
      <td>85</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>6.050010</td>
      <td>49.588410</td>
      <td>2065.25</td>
      <td>1547</td>
      <td>14</td>
      <td>2108</td>
      <td>5923</td>
      <td>27.493824</td>
      <td>-107809368</td>
      <td>-0.162624</td>
      <td>0.014065</td>
      <td>308.042786</td>
      <td>25</td>
      <td>136.048340</td>
      <td>146.835205</td>
      <td>198.127441</td>
      <td>0.028847</td>
      <td>17</td>
      <td>796962</td>
      <td>18.777500</td>
      <td>457.880066</td>
      <td>85</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>6.050014</td>
      <td>48.608456</td>
      <td>1246.50</td>
      <td>1515</td>
      <td>19</td>
      <td>2124</td>
      <td>6010</td>
      <td>-1.602039</td>
      <td>17384282</td>
      <td>1.447979</td>
      <td>-0.018912</td>
      <td>364.527100</td>
      <td>18</td>
      <td>221.339844</td>
      <td>247.387207</td>
      <td>480.387939</td>
      <td>0.042747</td>
      <td>14</td>
      <td>897945</td>
      <td>19.398880</td>
      <td>474.331329</td>
      <td>62</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>6.050016</td>
      <td>48.571401</td>
      <td>2938.75</td>
      <td>1520</td>
      <td>19</td>
      <td>2169</td>
      <td>6147</td>
      <td>27.856503</td>
      <td>-66516432</td>
      <td>-1.073956</td>
      <td>0.002280</td>
      <td>254.679596</td>
      <td>19</td>
      <td>125.250488</td>
      <td>87.865234</td>
      <td>160.696777</td>
      <td>0.037254</td>
      <td>11</td>
      <td>908426</td>
      <td>20.170450</td>
      <td>476.414520</td>
      <td>96</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>6.050019</td>
      <td>49.921613</td>
      <td>3294.75</td>
      <td>1490</td>
      <td>12</td>
      <td>1995</td>
      <td>5912</td>
      <td>22.102139</td>
      <td>-297770784</td>
      <td>-1.402633</td>
      <td>0.309765</td>
      <td>294.927765</td>
      <td>26</td>
      <td>-86.729492</td>
      <td>-145.584229</td>
      <td>-190.062988</td>
      <td>0.222435</td>
      <td>15</td>
      <td>772784</td>
      <td>20.855963</td>
      <td>457.195404</td>
      <td>86</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9</td>
      <td>6.050020</td>
      <td>48.822645</td>
      <td>1623.50</td>
      <td>1554</td>
      <td>18</td>
      <td>1973</td>
      <td>6138</td>
      <td>18.496584</td>
      <td>-25336536</td>
      <td>-0.800016</td>
      <td>0.010370</td>
      <td>240.493759</td>
      <td>22</td>
      <td>-51.470703</td>
      <td>-245.886719</td>
      <td>172.074707</td>
      <td>0.004428</td>
      <td>8</td>
      <td>839132</td>
      <td>21.812290</td>
      <td>496.231110</td>
      <td>64</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10</td>
      <td>6.050024</td>
      <td>49.847522</td>
      <td>1400.00</td>
      <td>1521</td>
      <td>15</td>
      <td>2187</td>
      <td>5886</td>
      <td>-5.660453</td>
      <td>-278652608</td>
      <td>1.477951</td>
      <td>-0.068720</td>
      <td>376.671143</td>
      <td>12</td>
      <td>277.297363</td>
      <td>273.141846</td>
      <td>-138.895996</td>
      <td>0.098817</td>
      <td>13</td>
      <td>768873</td>
      <td>21.137711</td>
      <td>466.976685</td>
      <td>70</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NUMBER OF ROWS:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">predictors</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NUMBER OF ROWS: 1267239
</pre></div></div>
</div>
<p>To deeper analyze data distribution its always good to plot them</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">predictors</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]),</span><span class="nb">max</span><span class="p">(</span><span class="n">predictors</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]),</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">((</span><span class="n">predictors</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]),</span><span class="n">bins</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_18_0.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_18_0.png" />
</div>
</div>
<p>In this way we can see where the date spans to, and detect outliers.</p>
<p>Indeed, in this case we’re gonna select only trees with height below 70m (because in this area, the highest tree detected in germany was 67m <a class="reference external" href="https://visit.freiburg.de/en/attractions/waldtraut-germany-s-tallest-tree">https://visit.freiburg.de/en/attractions/waldtraut-germany-s-tallest-tree</a>).</p>
<p>And we procede sampling just 100K points out of the 1.2M, to train a lighter model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictors_sel</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">predictors</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">7000</span><span class="p">)</span>  <span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>

<span class="c1"># add a height column in meter</span>
<span class="n">predictors_sel</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;hm&#39;</span> <span class="p">,</span>  <span class="n">predictors_sel</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span> <span class="p">)</span>

<span class="c1"># overlook</span>
<span class="n">predictors_sel</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>X</th>
      <th>Y</th>
      <th>h</th>
      <th>hm</th>
      <th>BLDFIE_WeigAver</th>
      <th>CECSOL_WeigAver</th>
      <th>CHELSA_bio18</th>
      <th>CHELSA_bio4</th>
      <th>convergence</th>
      <th>cti</th>
      <th>devmagnitude</th>
      <th>eastness</th>
      <th>elev</th>
      <th>forestheight</th>
      <th>glad_ard_SVVI_max</th>
      <th>glad_ard_SVVI_med</th>
      <th>glad_ard_SVVI_min</th>
      <th>northness</th>
      <th>ORCDRC_WeigAver</th>
      <th>outlet_dist_dw_basin</th>
      <th>SBIO3_Isothermality_5_15cm</th>
      <th>SBIO4_Temperature_Seasonality_5_15cm</th>
      <th>treecover</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>81999</th>
      <td>82000</td>
      <td>6.349125</td>
      <td>49.644223</td>
      <td>2659.75</td>
      <td>26.5975</td>
      <td>1530</td>
      <td>16</td>
      <td>2272</td>
      <td>5931</td>
      <td>21.476559</td>
      <td>-141539392</td>
      <td>1.694310</td>
      <td>-0.040122</td>
      <td>331.223236</td>
      <td>23</td>
      <td>631.313477</td>
      <td>214.736084</td>
      <td>365.218750</td>
      <td>0.057163</td>
      <td>25</td>
      <td>717991</td>
      <td>18.626610</td>
      <td>451.421082</td>
      <td>86</td>
    </tr>
    <tr>
      <th>965362</th>
      <td>965363</td>
      <td>9.012956</td>
      <td>49.690358</td>
      <td>2689.50</td>
      <td>26.8950</td>
      <td>1536</td>
      <td>12</td>
      <td>2137</td>
      <td>6537</td>
      <td>15.065849</td>
      <td>120771872</td>
      <td>-1.399779</td>
      <td>-0.072601</td>
      <td>242.992401</td>
      <td>26</td>
      <td>353.459473</td>
      <td>270.740967</td>
      <td>220.016357</td>
      <td>0.026610</td>
      <td>9</td>
      <td>719463</td>
      <td>20.024574</td>
      <td>492.804718</td>
      <td>75</td>
    </tr>
    <tr>
      <th>1236259</th>
      <td>1236260</td>
      <td>9.801078</td>
      <td>49.395159</td>
      <td>2572.00</td>
      <td>25.7200</td>
      <td>1528</td>
      <td>16</td>
      <td>2238</td>
      <td>6472</td>
      <td>16.836056</td>
      <td>-162671216</td>
      <td>0.910004</td>
      <td>-0.033257</td>
      <td>418.785919</td>
      <td>20</td>
      <td>-54.990723</td>
      <td>61.513428</td>
      <td>257.196045</td>
      <td>0.045267</td>
      <td>8</td>
      <td>806762</td>
      <td>19.990988</td>
      <td>525.202148</td>
      <td>82</td>
    </tr>
    <tr>
      <th>1115641</th>
      <td>1115642</td>
      <td>9.382723</td>
      <td>49.106039</td>
      <td>2370.00</td>
      <td>23.7000</td>
      <td>1513</td>
      <td>15</td>
      <td>2407</td>
      <td>6637</td>
      <td>-24.503428</td>
      <td>-231658992</td>
      <td>-0.858004</td>
      <td>-0.064393</td>
      <td>267.034180</td>
      <td>4</td>
      <td>536.372314</td>
      <td>470.607422</td>
      <td>432.341064</td>
      <td>0.030045</td>
      <td>6</td>
      <td>784144</td>
      <td>19.837236</td>
      <td>517.255615</td>
      <td>29</td>
    </tr>
    <tr>
      <th>215407</th>
      <td>215408</td>
      <td>6.773116</td>
      <td>49.944617</td>
      <td>1392.00</td>
      <td>13.9200</td>
      <td>1515</td>
      <td>12</td>
      <td>1952</td>
      <td>6118</td>
      <td>26.732821</td>
      <td>-193019280</td>
      <td>0.534557</td>
      <td>-0.005609</td>
      <td>300.268585</td>
      <td>22</td>
      <td>-162.502686</td>
      <td>-200.892090</td>
      <td>-412.381104</td>
      <td>0.056135</td>
      <td>15</td>
      <td>666767</td>
      <td>19.065788</td>
      <td>437.629272</td>
      <td>74</td>
    </tr>
    <tr>
      <th>939859</th>
      <td>939860</td>
      <td>8.948157</td>
      <td>49.643079</td>
      <td>2365.25</td>
      <td>23.6525</td>
      <td>1481</td>
      <td>13</td>
      <td>2466</td>
      <td>6341</td>
      <td>-10.630081</td>
      <td>-171884224</td>
      <td>1.417312</td>
      <td>-0.121560</td>
      <td>400.390808</td>
      <td>26</td>
      <td>-52.929199</td>
      <td>-124.971191</td>
      <td>-149.944336</td>
      <td>0.015808</td>
      <td>9</td>
      <td>737709</td>
      <td>19.441750</td>
      <td>473.700439</td>
      <td>89</td>
    </tr>
    <tr>
      <th>157727</th>
      <td>157728</td>
      <td>6.620174</td>
      <td>49.837913</td>
      <td>3160.75</td>
      <td>31.6075</td>
      <td>1536</td>
      <td>13</td>
      <td>2164</td>
      <td>6052</td>
      <td>-57.077930</td>
      <td>-253935056</td>
      <td>1.182596</td>
      <td>-0.038630</td>
      <td>343.578552</td>
      <td>24</td>
      <td>178.370117</td>
      <td>86.893066</td>
      <td>392.301758</td>
      <td>-0.081356</td>
      <td>23</td>
      <td>675920</td>
      <td>19.584587</td>
      <td>443.499878</td>
      <td>100</td>
    </tr>
    <tr>
      <th>376387</th>
      <td>376388</td>
      <td>7.163473</td>
      <td>49.791920</td>
      <td>3010.00</td>
      <td>30.1000</td>
      <td>1352</td>
      <td>12</td>
      <td>2377</td>
      <td>5621</td>
      <td>-3.525097</td>
      <td>-193161968</td>
      <td>3.196814</td>
      <td>0.090454</td>
      <td>699.986816</td>
      <td>22</td>
      <td>435.113525</td>
      <td>436.794434</td>
      <td>406.962158</td>
      <td>-0.108846</td>
      <td>32</td>
      <td>638925</td>
      <td>22.397139</td>
      <td>416.059174</td>
      <td>87</td>
    </tr>
    <tr>
      <th>426482</th>
      <td>426483</td>
      <td>7.277403</td>
      <td>49.534507</td>
      <td>277.75</td>
      <td>2.7775</td>
      <td>1494</td>
      <td>15</td>
      <td>2251</td>
      <td>6162</td>
      <td>7.484096</td>
      <td>-268103968</td>
      <td>0.745217</td>
      <td>0.029769</td>
      <td>391.105804</td>
      <td>14</td>
      <td>-40.088135</td>
      <td>-26.999023</td>
      <td>-72.698975</td>
      <td>0.078123</td>
      <td>12</td>
      <td>641196</td>
      <td>20.374083</td>
      <td>485.715973</td>
      <td>75</td>
    </tr>
    <tr>
      <th>286481</th>
      <td>286482</td>
      <td>6.954634</td>
      <td>48.417400</td>
      <td>2362.50</td>
      <td>23.6250</td>
      <td>1331</td>
      <td>20</td>
      <td>3297</td>
      <td>6108</td>
      <td>15.627705</td>
      <td>-346475904</td>
      <td>0.985921</td>
      <td>0.047404</td>
      <td>547.931702</td>
      <td>33</td>
      <td>-2.996826</td>
      <td>-0.247314</td>
      <td>-181.765503</td>
      <td>0.207945</td>
      <td>50</td>
      <td>960411</td>
      <td>21.377501</td>
      <td>454.721680</td>
      <td>95</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NUMBER OF ROWS:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">predictors_sel</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NUMBER OF ROWS: 100000
</pre></div></div>
</div>
<p>Now we can see again the data distribution with the same plotting used before</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">predictors_sel</span><span class="p">[</span><span class="s1">&#39;hm&#39;</span><span class="p">]),</span><span class="nb">max</span><span class="p">(</span><span class="n">predictors_sel</span><span class="p">[</span><span class="s1">&#39;hm&#39;</span><span class="p">]),</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">((</span><span class="n">predictors_sel</span><span class="p">[</span><span class="s1">&#39;hm&#39;</span><span class="p">]),</span><span class="n">bins</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_23_0.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_23_0.png" />
</div>
</div>
<p>To have a comparison we’ll analyze the <strong>The Global Forest Canopy Height, 2019 map</strong>. This has been released in 2020 (within a scientific publication <a class="reference external" href="https://doi.org/10.1016/j.rse.2020.112165">https://doi.org/10.1016/j.rse.2020.112165</a>).</p>
<p>The authors used a regression tree model that was calibrated and applied to each individual Landsat GLAD ARD tile (1° × 1°) in a “moving window” mode.</p>
<p>This tree height estimation its available as forestheight.tiff and their extracted values available in the table as forestheight column.</p>
<p>To see how this model performed we can see a correlation plot and its calculated pearson coefficient.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">predictors</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span><span class="n">predictors</span><span class="p">[</span><span class="s1">&#39;forestheight&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;sensed tree height</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;estimated tree height</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">ident</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span><span class="n">ident</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x712ff962c980&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_25_1.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_25_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculating the pearson correlation index</span>
<span class="n">pearsonr_Publication_Estimation</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">predictors</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">],</span><span class="n">predictors</span><span class="p">[</span><span class="s1">&#39;forestheight&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PEARSON CORRELATION COEFFINCENT:&quot;</span><span class="p">,</span> <span class="n">pearsonr_Publication_Estimation</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PEARSON CORRELATION COEFFINCENT: 0.4527925130004339
</pre></div></div>
</div>
<p>In this procedure we will try to outperform this model Pearson Correlation Coefficent.</p>
<p>To do that we’re gonna use a more advanced Machine Learning architecture with some more and different enviromental predictors that could better express the ecological asset and the physical conditions.</p>
</section>
<section id="Data-set-splitting">
<h2>Data set splitting<a class="headerlink" href="#Data-set-splitting" title="Link to this heading"></a></h2>
<p>To procede we need to split the dataset (<em>predictors_sel</em>) in order to create the response variable table that will be used against the predictors variables (excluding the forestheight predictors).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">predictors_sel</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">predictors_sel</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">feat</span> <span class="o">=</span> <span class="n">predictors_sel</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">]]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<p>Its always good to double check that we select the right columns in the right order</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;BLDFIE_WeigAver&#39;, &#39;CECSOL_WeigAver&#39;, &#39;CHELSA_bio18&#39;,
       &#39;CHELSA_bio4&#39;, &#39;convergence&#39;, &#39;cti&#39;, &#39;devmagnitude&#39;, &#39;eastness&#39;,
       &#39;elev&#39;, &#39;glad_ard_SVVI_max&#39;, &#39;glad_ard_SVVI_med&#39;,
       &#39;glad_ard_SVVI_min&#39;, &#39;northness&#39;, &#39;ORCDRC_WeigAver&#39;,
       &#39;outlet_dist_dw_basin&#39;, &#39;SBIO3_Isothermality_5_15cm&#39;,
       &#39;SBIO4_Temperature_Seasonality_5_15cm&#39;, &#39;treecover&#39;], dtype=object)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RESPONSE VARIABLE DIMENSION:&quot;</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RESPONSE VARIABLE DIMENSION: (100000, 1)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PREDICTING FEATURES DIMENSION:&quot;</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PREDICTING FEATURES DIMENSION: (100000, 18)
</pre></div></div>
</div>
<p>Now we can create 4 different dataset:</p>
<ul class="simple">
<li><p>2 for model algorithm training (<em>X_train</em> and <em>Y_train</em>)</p></li>
<li><p>2 for model testing (<em>X_test</em> and <em>Y_test</em>)</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Random-Forest-default-parameters">
<h2>Random Forest default parameters<a class="headerlink" href="#Random-Forest-default-parameters" title="Link to this heading"></a></h2>
<p>Random Forest can be implemented using the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html">RandomForestRegressor in scikit-learn</a></p>
<p>We can procede on training the Random Forest model using its default parameters.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">rf</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;bootstrap&#39;: True,
 &#39;ccp_alpha&#39;: 0.0,
 &#39;criterion&#39;: &#39;squared_error&#39;,
 &#39;max_depth&#39;: None,
 &#39;max_features&#39;: 1.0,
 &#39;max_leaf_nodes&#39;: None,
 &#39;max_samples&#39;: None,
 &#39;min_impurity_decrease&#39;: 0.0,
 &#39;min_samples_leaf&#39;: 1,
 &#39;min_samples_split&#39;: 2,
 &#39;min_weight_fraction_leaf&#39;: 0.0,
 &#39;monotonic_cst&#39;: None,
 &#39;n_estimators&#39;: 100,
 &#39;n_jobs&#39;: None,
 &#39;oob_score&#39;: False,
 &#39;random_state&#39;: 42,
 &#39;verbose&#39;: 0,
 &#39;warm_start&#39;: False}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rfReg</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rfReg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
<span class="n">dic_pred</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rfReg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rfReg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">pearsonr_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span><span class="n">y_train</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span><span class="n">y_test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PEARSON CORRELATION COEFFINCENT:&quot;</span><span class="p">,</span> <span class="n">pearsonr_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PEARSON CORRELATION COEFFINCENT: [0.6035710046325166, 0.506707480767017]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># checking the oob score</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OUT OF BAG SCORE:&quot;</span><span class="p">,</span> <span class="n">rfReg</span><span class="o">.</span><span class="n">oob_score_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
OUT OF BAG SCORE: 0.2625683482738882
</pre></div></div>
</div>
<p>Additional resources that can be used to reduce more the oob error can be found at:</p>
<p><a class="reference external" href="https://scikit-learn.org/stable/auto_examples/ensemble/plot_ensemble_oob.html">https://scikit-learn.org/stable/auto_examples/ensemble/plot_ensemble_oob.html</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span><span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Training GEDI Height (all dataset)</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Training Tree Height prediction</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">ident</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span><span class="n">ident</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x712ff7839910&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_41_1.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_41_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Testing GEDI Height (all dataset)</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Testing Tree Height prediction</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">ident</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span><span class="n">ident</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x712ff7a23f50&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_42_1.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_42_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">impt</span> <span class="o">=</span> <span class="p">[</span><span class="n">rfReg</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">feature_importances_</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">rfReg</span><span class="o">.</span><span class="n">estimators_</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">impt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 1, 13,  0,  4,  6,  8, 16,  2, 15,  5, 12,  3, 11,  9, 14,  7, 10,
       17])
</pre></div></div>
</div>
<p>To deeper analyze model behaviour in response variable regression we can extract the Feature Importance Ranking</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feat</span><span class="p">)),</span><span class="n">impt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">impt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feat</span><span class="p">)),</span><span class="n">feat</span><span class="p">[</span><span class="n">ind</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_46_0.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_46_0.png" />
</div>
</div>
</section>
<section id="Model-tuning-whith-Hyperparameters-Tweeking">
<h2>Model tuning whith Hyperparameters Tweeking<a class="headerlink" href="#Model-tuning-whith-Hyperparameters-Tweeking" title="Link to this heading"></a></h2>
<p>To improve model performance we can use tools like <em>GridSearchCV</em> to find with a recursive search the best combination of all model hyperparameters imployed.</p>
<p>Hyperparameters that were setted as default in the first model run, like:</p>
<ul class="simple">
<li><p>“max_features”: number of features to consider when looking for the best split.</p></li>
<li><p>“max_samples”: number of samples to draw from X to train each base estimator.</p></li>
<li><p>“n_estimators”: identify the number of trees that must grow. It must be large enough so that the error is stabilized. Defoult 100.</p></li>
<li><p>“max_depth”: max number of levels in each decision tree.</p></li>
</ul>
<p>By using this code we can tune up those parameters to improve the algoirithm performance (this code is not runned directly because of its big computational demand as for time and memory perspective)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pipeline = Pipeline([(&#39;rf&#39;,RandomForestRegressor())])

parameters = {
        &#39;rf__max_features&#39;:(3,4,5),
        &#39;rf__max_samples&#39;:(0.5,0.6,0.7),
        &#39;rf__n_estimators&#39;:(500,1000),
        &#39;rf__max_depth&#39;:(50,100,200,300)}

grid_search = GridSearchCV(pipeline,parameters,n_jobs=6,cv=5,scoring=&#39;r2&#39;,verbose=1)
grid_search.fit(X_train,y_train)


rfReg = RandomForestRegressor(n_estimators=5000,max_features=0.33,max_depth=500,max_samples=0.7,n_jobs=-1,random_state=24 , oob_score = True)
rfReg.fit(X_train, y_train);
dic_pred = {}
dic_pred[&#39;train&#39;] = rfReg.predict(X_train)
dic_pred[&#39;test&#39;] = rfReg.predict(X_test)
pearsonr_all_tune = [pearsonr(dic_pred[&#39;train&#39;],y_train)[0],pearsonr(dic_pred[&#39;test&#39;],y_test)[0]]
pearsonr_all_tune

grid_search.best_score_

print (&#39;Best Training score: %0.3f&#39; % grid_search.best_score_)
print (&#39;Optimal parameters:&#39;) best_par = grid_search.best_estimator_.get_params()
for par_name in sorted(parameters.keys()):
    print (&#39;\t%s: %r&#39; % (par_name, best_par[par_name]))
</pre></div>
</div>
<p>Tracking the error rate trend as in <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/ensemble/plot_ensemble_oob.html">https://scikit-learn.org/stable/auto_examples/ensemble/plot_ensemble_oob.html</a></p>
<p>Features importance ranking shows that the most important variable is treecover followed by Spectral Variability Vegetation Index, and outlet_dist_dw_basin which is a proxy of water accumulation.</p>
<p>Besides eastness and northness describes microclimat condition.</p>
</section>
<section id="Model-tuning-with-data-selection">
<h2>Model tuning with data selection<a class="headerlink" href="#Model-tuning-with-data-selection" title="Link to this heading"></a></h2>
<p>We can enhance the model performance also by having a wise data selection.</p>
<p>In this case we can have it based on data quality flag (available in the dataset) to select more reilable tree height points.</p>
<p><strong>File storing tree hight (cm) obtained by 6 algorithms, with their associate quality flags.</strong> The quality flags can be used to refine and select the best tree height estimation and use it as tree height observation.</p>
<ul class="simple">
<li><p>a?_95: tree hight (cm) at 95 quintile, for each algorithm</p></li>
<li><p>min_rh_95: minimum value of tree hight (cm) ammong the 6 algorithms</p></li>
<li><p>max_rh_95: maximum value of tree hight (cm) ammong the 6 algorithms</p></li>
<li><p>BEAM: 1-4 coverage beam = lower power (worse) ; 5-8 power beam = higher power (better)</p></li>
<li><p>digital_elev: digital mdoel elevation</p></li>
<li><p>elev_low: elevation of center of lowest mode</p></li>
<li><p>qc_a?: quality_flag for six algorithms quality_flag = 1 (better); = 0 (worse)</p></li>
<li><p>se_a?: sensitivity for six algorithms sensitivity &lt; 0.95 (worse); sensitivity &gt; 0.95 (beter )</p></li>
<li><p>deg_fg: (degrade_flag) not-degraded 0 (better) ; degraded &gt; 0 (worse)</p></li>
<li><p>solar_ele: solar elevation. &gt; 0 day (worse); &lt; 0 night (better)</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">height_6algorithms</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;tree_height/txt/eu_y_x_select_6algorithms_fullTable.txt&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>  <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">height_6algorithms</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>X</th>
      <th>Y</th>
      <th>a1_95</th>
      <th>a2_95</th>
      <th>a3_95</th>
      <th>a4_95</th>
      <th>a5_95</th>
      <th>a6_95</th>
      <th>min_rh_95</th>
      <th>max_rh_95</th>
      <th>BEAM</th>
      <th>digital_elev</th>
      <th>elev_low</th>
      <th>qc_a1</th>
      <th>qc_a2</th>
      <th>qc_a3</th>
      <th>qc_a4</th>
      <th>qc_a5</th>
      <th>qc_a6</th>
      <th>se_a1</th>
      <th>se_a2</th>
      <th>se_a3</th>
      <th>se_a4</th>
      <th>se_a5</th>
      <th>se_a6</th>
      <th>deg_fg</th>
      <th>solar_ele</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>6.050001</td>
      <td>49.727499</td>
      <td>3139</td>
      <td>3139</td>
      <td>3139</td>
      <td>3120</td>
      <td>3139</td>
      <td>3139</td>
      <td>3120</td>
      <td>3139</td>
      <td>5</td>
      <td>410.0</td>
      <td>383.72153</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.962</td>
      <td>0.984</td>
      <td>0.968</td>
      <td>0.962</td>
      <td>0.989</td>
      <td>0.979</td>
      <td>0</td>
      <td>17.7</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>6.050002</td>
      <td>49.922155</td>
      <td>1022</td>
      <td>2303</td>
      <td>970</td>
      <td>872</td>
      <td>5596</td>
      <td>1524</td>
      <td>872</td>
      <td>5596</td>
      <td>5</td>
      <td>290.0</td>
      <td>2374.14110</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.948</td>
      <td>0.990</td>
      <td>0.960</td>
      <td>0.948</td>
      <td>0.994</td>
      <td>0.980</td>
      <td>0</td>
      <td>43.7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>6.050002</td>
      <td>48.602377</td>
      <td>380</td>
      <td>1336</td>
      <td>332</td>
      <td>362</td>
      <td>1336</td>
      <td>1340</td>
      <td>332</td>
      <td>1340</td>
      <td>4</td>
      <td>440.0</td>
      <td>435.97781</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.947</td>
      <td>0.975</td>
      <td>0.956</td>
      <td>0.947</td>
      <td>0.981</td>
      <td>0.968</td>
      <td>0</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>6.050009</td>
      <td>48.151979</td>
      <td>3153</td>
      <td>3142</td>
      <td>3142</td>
      <td>3127</td>
      <td>3138</td>
      <td>3142</td>
      <td>3127</td>
      <td>3153</td>
      <td>2</td>
      <td>450.0</td>
      <td>422.00537</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.930</td>
      <td>0.970</td>
      <td>0.943</td>
      <td>0.930</td>
      <td>0.978</td>
      <td>0.962</td>
      <td>0</td>
      <td>-14.2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>6.050010</td>
      <td>49.588410</td>
      <td>666</td>
      <td>4221</td>
      <td>651</td>
      <td>33</td>
      <td>5611</td>
      <td>2723</td>
      <td>33</td>
      <td>5611</td>
      <td>8</td>
      <td>370.0</td>
      <td>2413.74830</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.941</td>
      <td>0.983</td>
      <td>0.946</td>
      <td>0.941</td>
      <td>0.992</td>
      <td>0.969</td>
      <td>0</td>
      <td>22.1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>6.050014</td>
      <td>48.608456</td>
      <td>787</td>
      <td>1179</td>
      <td>1187</td>
      <td>761</td>
      <td>1833</td>
      <td>1833</td>
      <td>761</td>
      <td>1833</td>
      <td>3</td>
      <td>420.0</td>
      <td>415.51581</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.952</td>
      <td>0.979</td>
      <td>0.961</td>
      <td>0.952</td>
      <td>0.986</td>
      <td>0.975</td>
      <td>0</td>
      <td>0.2</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">height_6algorithms_sel</span> <span class="o">=</span> <span class="n">height_6algorithms</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;BEAM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;qc_a1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;qc_a2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;qc_a3&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;qc_a4&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;qc_a5&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;qc_a6&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;se_a1&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;se_a2&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;se_a3&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;se_a4&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;se_a5&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;se_a6&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;deg_fg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                                            <span class="o">&amp;</span>   <span class="p">(</span><span class="n">height_6algorithms</span><span class="p">[</span><span class="s1">&#39;solar_ele&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">height_6algorithms_sel</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>X</th>
      <th>Y</th>
      <th>a1_95</th>
      <th>a2_95</th>
      <th>a3_95</th>
      <th>a4_95</th>
      <th>a5_95</th>
      <th>a6_95</th>
      <th>min_rh_95</th>
      <th>max_rh_95</th>
      <th>BEAM</th>
      <th>digital_elev</th>
      <th>elev_low</th>
      <th>qc_a1</th>
      <th>qc_a2</th>
      <th>qc_a3</th>
      <th>qc_a4</th>
      <th>qc_a5</th>
      <th>qc_a6</th>
      <th>se_a1</th>
      <th>se_a2</th>
      <th>se_a3</th>
      <th>se_a4</th>
      <th>se_a5</th>
      <th>se_a6</th>
      <th>deg_fg</th>
      <th>solar_ele</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>6.050019</td>
      <td>49.921613</td>
      <td>3303</td>
      <td>3288</td>
      <td>3296</td>
      <td>3236</td>
      <td>3857</td>
      <td>3292</td>
      <td>3236</td>
      <td>3857</td>
      <td>7</td>
      <td>320.0</td>
      <td>297.68533</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.971</td>
      <td>0.988</td>
      <td>0.976</td>
      <td>0.971</td>
      <td>0.992</td>
      <td>0.984</td>
      <td>0</td>
      <td>-33.9</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12</td>
      <td>6.050039</td>
      <td>47.995344</td>
      <td>2762</td>
      <td>2736</td>
      <td>2740</td>
      <td>2747</td>
      <td>3893</td>
      <td>2736</td>
      <td>2736</td>
      <td>3893</td>
      <td>5</td>
      <td>390.0</td>
      <td>368.55121</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.975</td>
      <td>0.990</td>
      <td>0.979</td>
      <td>0.975</td>
      <td>0.994</td>
      <td>0.987</td>
      <td>0</td>
      <td>-37.3</td>
    </tr>
    <tr>
      <th>14</th>
      <td>15</td>
      <td>6.050046</td>
      <td>49.865317</td>
      <td>1398</td>
      <td>2505</td>
      <td>2509</td>
      <td>1316</td>
      <td>2848</td>
      <td>2505</td>
      <td>1316</td>
      <td>2848</td>
      <td>6</td>
      <td>340.0</td>
      <td>330.40564</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.973</td>
      <td>0.990</td>
      <td>0.979</td>
      <td>0.973</td>
      <td>0.994</td>
      <td>0.986</td>
      <td>0</td>
      <td>-18.2</td>
    </tr>
    <tr>
      <th>15</th>
      <td>16</td>
      <td>6.050048</td>
      <td>49.050020</td>
      <td>984</td>
      <td>943</td>
      <td>947</td>
      <td>958</td>
      <td>2617</td>
      <td>947</td>
      <td>943</td>
      <td>2617</td>
      <td>6</td>
      <td>300.0</td>
      <td>291.22598</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.978</td>
      <td>0.991</td>
      <td>0.982</td>
      <td>0.978</td>
      <td>0.995</td>
      <td>0.988</td>
      <td>0</td>
      <td>-35.4</td>
    </tr>
    <tr>
      <th>16</th>
      <td>17</td>
      <td>6.050049</td>
      <td>48.391359</td>
      <td>3362</td>
      <td>3332</td>
      <td>3336</td>
      <td>3351</td>
      <td>4467</td>
      <td>3336</td>
      <td>3332</td>
      <td>4467</td>
      <td>5</td>
      <td>530.0</td>
      <td>504.78122</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.973</td>
      <td>0.988</td>
      <td>0.977</td>
      <td>0.973</td>
      <td>0.992</td>
      <td>0.984</td>
      <td>0</td>
      <td>-5.1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1267207</th>
      <td>1267208</td>
      <td>9.949829</td>
      <td>49.216272</td>
      <td>2160</td>
      <td>2816</td>
      <td>2816</td>
      <td>2104</td>
      <td>3299</td>
      <td>2816</td>
      <td>2104</td>
      <td>3299</td>
      <td>8</td>
      <td>420.0</td>
      <td>386.44556</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.980</td>
      <td>0.993</td>
      <td>0.984</td>
      <td>0.980</td>
      <td>0.995</td>
      <td>0.989</td>
      <td>0</td>
      <td>-16.9</td>
    </tr>
    <tr>
      <th>1267211</th>
      <td>1267212</td>
      <td>9.949856</td>
      <td>49.881190</td>
      <td>3190</td>
      <td>3179</td>
      <td>3179</td>
      <td>3171</td>
      <td>3822</td>
      <td>3179</td>
      <td>3171</td>
      <td>3822</td>
      <td>6</td>
      <td>380.0</td>
      <td>363.69348</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.968</td>
      <td>0.986</td>
      <td>0.974</td>
      <td>0.968</td>
      <td>0.990</td>
      <td>0.982</td>
      <td>0</td>
      <td>-35.1</td>
    </tr>
    <tr>
      <th>1267216</th>
      <td>1267217</td>
      <td>9.949880</td>
      <td>49.873435</td>
      <td>2061</td>
      <td>2828</td>
      <td>2046</td>
      <td>2024</td>
      <td>2828</td>
      <td>2828</td>
      <td>2024</td>
      <td>2828</td>
      <td>7</td>
      <td>380.0</td>
      <td>361.06812</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.967</td>
      <td>0.988</td>
      <td>0.974</td>
      <td>0.967</td>
      <td>0.993</td>
      <td>0.983</td>
      <td>0</td>
      <td>-35.1</td>
    </tr>
    <tr>
      <th>1267227</th>
      <td>1267228</td>
      <td>9.949958</td>
      <td>49.127182</td>
      <td>366</td>
      <td>2307</td>
      <td>1260</td>
      <td>355</td>
      <td>3531</td>
      <td>2719</td>
      <td>355</td>
      <td>3531</td>
      <td>6</td>
      <td>500.0</td>
      <td>493.52792</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.973</td>
      <td>0.989</td>
      <td>0.978</td>
      <td>0.973</td>
      <td>0.993</td>
      <td>0.985</td>
      <td>0</td>
      <td>-36.0</td>
    </tr>
    <tr>
      <th>1267237</th>
      <td>1267238</td>
      <td>9.949999</td>
      <td>49.936763</td>
      <td>2513</td>
      <td>2490</td>
      <td>2490</td>
      <td>2494</td>
      <td>2490</td>
      <td>2490</td>
      <td>2490</td>
      <td>2513</td>
      <td>5</td>
      <td>360.0</td>
      <td>346.54227</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.968</td>
      <td>0.988</td>
      <td>0.974</td>
      <td>0.968</td>
      <td>0.993</td>
      <td>0.983</td>
      <td>0</td>
      <td>-32.2</td>
    </tr>
  </tbody>
</table>
<p>226892 rows × 28 columns</p>
</div></div>
</div>
<p>Calculate the mean height excluidng the maximum and minimum values</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">height_sel</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;ID&#39;</span> <span class="p">:</span> <span class="n">height_6algorithms_sel</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="p">,</span>
                            <span class="s1">&#39;hm_sel&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">height_6algorithms_sel</span><span class="p">[</span><span class="s1">&#39;a1_95&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">height_6algorithms_sel</span><span class="p">[</span><span class="s1">&#39;a2_95&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">height_6algorithms_sel</span><span class="p">[</span><span class="s1">&#39;a3_95&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">height_6algorithms_sel</span><span class="p">[</span><span class="s1">&#39;a4_95&#39;</span><span class="p">]</span>
                             <span class="o">+</span> <span class="n">height_6algorithms_sel</span><span class="p">[</span><span class="s1">&#39;a5_95&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">height_6algorithms_sel</span><span class="p">[</span><span class="s1">&#39;a6_95&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">height_6algorithms_sel</span><span class="p">[</span><span class="s1">&#39;min_rh_95&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">height_6algorithms_sel</span><span class="p">[</span><span class="s1">&#39;max_rh_95&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">400</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">height_sel</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>hm_sel</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>32.9475</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12</td>
      <td>27.4625</td>
    </tr>
    <tr>
      <th>14</th>
      <td>15</td>
      <td>22.2925</td>
    </tr>
    <tr>
      <th>15</th>
      <td>16</td>
      <td>9.5900</td>
    </tr>
    <tr>
      <th>16</th>
      <td>17</td>
      <td>33.4625</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1267207</th>
      <td>1267208</td>
      <td>26.5200</td>
    </tr>
    <tr>
      <th>1267211</th>
      <td>1267212</td>
      <td>31.8175</td>
    </tr>
    <tr>
      <th>1267216</th>
      <td>1267217</td>
      <td>24.4075</td>
    </tr>
    <tr>
      <th>1267227</th>
      <td>1267228</td>
      <td>16.6300</td>
    </tr>
    <tr>
      <th>1267237</th>
      <td>1267238</td>
      <td>24.9100</td>
    </tr>
  </tbody>
</table>
<p>226892 rows × 2 columns</p>
</div></div>
</div>
<p>Merge the new height with the predictors table, using the ID as Primary Key</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictors_hm_sel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span> <span class="n">predictors</span> <span class="p">,</span>  <span class="n">height_sel</span> <span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span> <span class="p">,</span>  <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span> <span class="p">,</span>  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictors_hm_sel</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>X</th>
      <th>Y</th>
      <th>h</th>
      <th>BLDFIE_WeigAver</th>
      <th>CECSOL_WeigAver</th>
      <th>CHELSA_bio18</th>
      <th>CHELSA_bio4</th>
      <th>convergence</th>
      <th>cti</th>
      <th>devmagnitude</th>
      <th>eastness</th>
      <th>elev</th>
      <th>forestheight</th>
      <th>glad_ard_SVVI_max</th>
      <th>glad_ard_SVVI_med</th>
      <th>glad_ard_SVVI_min</th>
      <th>northness</th>
      <th>ORCDRC_WeigAver</th>
      <th>outlet_dist_dw_basin</th>
      <th>SBIO3_Isothermality_5_15cm</th>
      <th>SBIO4_Temperature_Seasonality_5_15cm</th>
      <th>treecover</th>
      <th>hm_sel</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8</td>
      <td>6.050019</td>
      <td>49.921613</td>
      <td>3294.75</td>
      <td>1490</td>
      <td>12</td>
      <td>1995</td>
      <td>5912</td>
      <td>22.102139</td>
      <td>-297770784</td>
      <td>-1.402633</td>
      <td>0.309765</td>
      <td>294.927765</td>
      <td>26</td>
      <td>-86.729492</td>
      <td>-145.584229</td>
      <td>-190.062988</td>
      <td>0.222435</td>
      <td>15</td>
      <td>772784</td>
      <td>20.855963</td>
      <td>457.195404</td>
      <td>86</td>
      <td>32.9475</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12</td>
      <td>6.050039</td>
      <td>47.995344</td>
      <td>2746.25</td>
      <td>1523</td>
      <td>12</td>
      <td>2612</td>
      <td>6181</td>
      <td>3.549103</td>
      <td>-71279992</td>
      <td>0.507727</td>
      <td>-0.021408</td>
      <td>322.920227</td>
      <td>26</td>
      <td>660.006104</td>
      <td>92.722168</td>
      <td>190.979736</td>
      <td>-0.034787</td>
      <td>16</td>
      <td>784807</td>
      <td>20.798000</td>
      <td>460.501221</td>
      <td>97</td>
      <td>27.4625</td>
    </tr>
    <tr>
      <th>2</th>
      <td>15</td>
      <td>6.050046</td>
      <td>49.865317</td>
      <td>2229.25</td>
      <td>1517</td>
      <td>13</td>
      <td>2191</td>
      <td>5901</td>
      <td>31.054762</td>
      <td>-186807440</td>
      <td>-1.375050</td>
      <td>-0.126880</td>
      <td>291.412537</td>
      <td>7</td>
      <td>1028.385498</td>
      <td>915.806396</td>
      <td>841.586182</td>
      <td>0.024677</td>
      <td>16</td>
      <td>766444</td>
      <td>19.941267</td>
      <td>454.185089</td>
      <td>54</td>
      <td>22.2925</td>
    </tr>
    <tr>
      <th>3</th>
      <td>16</td>
      <td>6.050048</td>
      <td>49.050020</td>
      <td>959.00</td>
      <td>1526</td>
      <td>14</td>
      <td>2081</td>
      <td>6100</td>
      <td>9.933455</td>
      <td>-183562672</td>
      <td>-0.382834</td>
      <td>0.086874</td>
      <td>246.288010</td>
      <td>24</td>
      <td>-12.283691</td>
      <td>-58.179199</td>
      <td>174.205566</td>
      <td>0.094175</td>
      <td>10</td>
      <td>805730</td>
      <td>19.849365</td>
      <td>470.946533</td>
      <td>78</td>
      <td>9.5900</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17</td>
      <td>6.050049</td>
      <td>48.391359</td>
      <td>3346.25</td>
      <td>1489</td>
      <td>19</td>
      <td>2486</td>
      <td>5966</td>
      <td>-6.957157</td>
      <td>-273522688</td>
      <td>2.989759</td>
      <td>0.214769</td>
      <td>474.409088</td>
      <td>24</td>
      <td>125.583008</td>
      <td>6.154297</td>
      <td>128.129150</td>
      <td>0.017164</td>
      <td>15</td>
      <td>950190</td>
      <td>21.179420</td>
      <td>491.398376</td>
      <td>85</td>
      <td>33.4625</td>
    </tr>
    <tr>
      <th>5</th>
      <td>19</td>
      <td>6.050053</td>
      <td>49.877876</td>
      <td>529.00</td>
      <td>1531</td>
      <td>12</td>
      <td>2184</td>
      <td>5915</td>
      <td>-24.278454</td>
      <td>-377335296</td>
      <td>0.265329</td>
      <td>-0.248356</td>
      <td>335.534760</td>
      <td>25</td>
      <td>593.601074</td>
      <td>228.712402</td>
      <td>315.298340</td>
      <td>-0.127365</td>
      <td>17</td>
      <td>764713</td>
      <td>19.760756</td>
      <td>448.580811</td>
      <td>96</td>
      <td>5.2900</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictors_hm_sel</span> <span class="o">=</span> <span class="n">predictors_hm_sel</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">predictors</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">7000</span><span class="p">)</span> <span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictors_hm_sel</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>X</th>
      <th>Y</th>
      <th>h</th>
      <th>BLDFIE_WeigAver</th>
      <th>CECSOL_WeigAver</th>
      <th>CHELSA_bio18</th>
      <th>CHELSA_bio4</th>
      <th>convergence</th>
      <th>cti</th>
      <th>devmagnitude</th>
      <th>eastness</th>
      <th>elev</th>
      <th>forestheight</th>
      <th>glad_ard_SVVI_max</th>
      <th>glad_ard_SVVI_med</th>
      <th>glad_ard_SVVI_min</th>
      <th>northness</th>
      <th>ORCDRC_WeigAver</th>
      <th>outlet_dist_dw_basin</th>
      <th>SBIO3_Isothermality_5_15cm</th>
      <th>SBIO4_Temperature_Seasonality_5_15cm</th>
      <th>treecover</th>
      <th>hm_sel</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>67109</th>
      <td>358075</td>
      <td>7.121301</td>
      <td>48.393362</td>
      <td>3127.00</td>
      <td>1390</td>
      <td>14</td>
      <td>3278</td>
      <td>6149</td>
      <td>-18.622808</td>
      <td>-349385216</td>
      <td>1.205495</td>
      <td>0.221449</td>
      <td>628.071411</td>
      <td>28</td>
      <td>16.379883</td>
      <td>-1.361572</td>
      <td>-254.569824</td>
      <td>0.122928</td>
      <td>30</td>
      <td>870714</td>
      <td>21.026922</td>
      <td>455.862976</td>
      <td>89</td>
      <td>31.2700</td>
    </tr>
    <tr>
      <th>49443</th>
      <td>271106</td>
      <td>6.915753</td>
      <td>48.398865</td>
      <td>2755.00</td>
      <td>1403</td>
      <td>16</td>
      <td>2880</td>
      <td>6227</td>
      <td>-10.780100</td>
      <td>-364243424</td>
      <td>0.597950</td>
      <td>0.212738</td>
      <td>479.239380</td>
      <td>28</td>
      <td>94.056396</td>
      <td>13.479736</td>
      <td>-101.955322</td>
      <td>0.052124</td>
      <td>26</td>
      <td>956659</td>
      <td>20.500694</td>
      <td>460.670288</td>
      <td>85</td>
      <td>27.5500</td>
    </tr>
    <tr>
      <th>225998</th>
      <td>1262978</td>
      <td>9.924864</td>
      <td>49.878408</td>
      <td>2404.25</td>
      <td>1497</td>
      <td>14</td>
      <td>2044</td>
      <td>6528</td>
      <td>-5.170033</td>
      <td>-260566736</td>
      <td>1.070872</td>
      <td>-0.060704</td>
      <td>322.041046</td>
      <td>20</td>
      <td>256.728516</td>
      <td>15.479248</td>
      <td>-28.410645</td>
      <td>0.124602</td>
      <td>8</td>
      <td>855708</td>
      <td>19.397581</td>
      <td>507.361115</td>
      <td>78</td>
      <td>24.0425</td>
    </tr>
    <tr>
      <th>46927</th>
      <td>257606</td>
      <td>6.880155</td>
      <td>49.368619</td>
      <td>2322.00</td>
      <td>1514</td>
      <td>15</td>
      <td>2292</td>
      <td>6233</td>
      <td>11.174547</td>
      <td>-242390336</td>
      <td>-0.602614</td>
      <td>-0.084595</td>
      <td>268.367157</td>
      <td>20</td>
      <td>236.149902</td>
      <td>236.915039</td>
      <td>371.205322</td>
      <td>-0.050283</td>
      <td>11</td>
      <td>769062</td>
      <td>21.441999</td>
      <td>496.682587</td>
      <td>58</td>
      <td>23.2200</td>
    </tr>
    <tr>
      <th>27199</th>
      <td>146987</td>
      <td>6.582437</td>
      <td>49.476879</td>
      <td>2464.25</td>
      <td>1521</td>
      <td>14</td>
      <td>2117</td>
      <td>6219</td>
      <td>-6.374312</td>
      <td>-234200800</td>
      <td>-1.728040</td>
      <td>0.231585</td>
      <td>182.034286</td>
      <td>23</td>
      <td>73.248047</td>
      <td>19.785400</td>
      <td>249.853027</td>
      <td>0.019138</td>
      <td>11</td>
      <td>731353</td>
      <td>20.218201</td>
      <td>483.040649</td>
      <td>93</td>
      <td>24.6425</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>25984</th>
      <td>139170</td>
      <td>6.551567</td>
      <td>49.175072</td>
      <td>2125.00</td>
      <td>1511</td>
      <td>17</td>
      <td>2252</td>
      <td>6015</td>
      <td>-14.249553</td>
      <td>-248558160</td>
      <td>2.698703</td>
      <td>-0.056752</td>
      <td>371.123718</td>
      <td>25</td>
      <td>141.861816</td>
      <td>2.110840</td>
      <td>86.527588</td>
      <td>0.024905</td>
      <td>12</td>
      <td>800114</td>
      <td>20.031235</td>
      <td>479.971527</td>
      <td>85</td>
      <td>21.2500</td>
    </tr>
    <tr>
      <th>46950</th>
      <td>257777</td>
      <td>6.880572</td>
      <td>49.535945</td>
      <td>231.00</td>
      <td>1519</td>
      <td>14</td>
      <td>2161</td>
      <td>6189</td>
      <td>32.561085</td>
      <td>89643480</td>
      <td>-1.137112</td>
      <td>-0.001126</td>
      <td>286.474335</td>
      <td>0</td>
      <td>937.622314</td>
      <td>743.368652</td>
      <td>405.727051</td>
      <td>-0.008619</td>
      <td>10</td>
      <td>787605</td>
      <td>21.355637</td>
      <td>486.371185</td>
      <td>4</td>
      <td>2.3100</td>
    </tr>
    <tr>
      <th>160836</th>
      <td>912341</td>
      <td>8.879877</td>
      <td>48.959728</td>
      <td>1810.50</td>
      <td>1518</td>
      <td>15</td>
      <td>2200</td>
      <td>6501</td>
      <td>-45.779213</td>
      <td>-249658704</td>
      <td>0.581574</td>
      <td>0.009894</td>
      <td>277.630981</td>
      <td>23</td>
      <td>321.381836</td>
      <td>71.376465</td>
      <td>304.113281</td>
      <td>-0.130948</td>
      <td>15</td>
      <td>832408</td>
      <td>18.087175</td>
      <td>476.243561</td>
      <td>99</td>
      <td>18.1050</td>
    </tr>
    <tr>
      <th>100900</th>
      <td>558839</td>
      <td>7.634858</td>
      <td>49.360323</td>
      <td>2422.75</td>
      <td>1533</td>
      <td>11</td>
      <td>2377</td>
      <td>6304</td>
      <td>-23.222776</td>
      <td>-286424256</td>
      <td>0.680885</td>
      <td>0.017598</td>
      <td>367.074890</td>
      <td>25</td>
      <td>-84.395996</td>
      <td>-98.640869</td>
      <td>22.901367</td>
      <td>-0.179092</td>
      <td>10</td>
      <td>895793</td>
      <td>18.074240</td>
      <td>468.273102</td>
      <td>80</td>
      <td>24.2275</td>
    </tr>
    <tr>
      <th>67155</th>
      <td>358294</td>
      <td>7.121821</td>
      <td>49.908679</td>
      <td>3338.00</td>
      <td>1535</td>
      <td>11</td>
      <td>1946</td>
      <td>6144</td>
      <td>-16.786621</td>
      <td>-319256448</td>
      <td>0.482177</td>
      <td>0.128489</td>
      <td>345.215790</td>
      <td>26</td>
      <td>-161.289062</td>
      <td>-201.367188</td>
      <td>-307.723389</td>
      <td>-0.012693</td>
      <td>6</td>
      <td>591350</td>
      <td>18.666250</td>
      <td>450.020935</td>
      <td>87</td>
      <td>33.3800</td>
    </tr>
  </tbody>
</table>
<p>100000 rows × 24 columns</p>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">predictors_hm_sel</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">predictors_hm_sel</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">23</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">feat</span> <span class="o">=</span> <span class="n">predictors_hm_sel</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">]]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;BLDFIE_WeigAver&#39;, &#39;CECSOL_WeigAver&#39;, &#39;CHELSA_bio18&#39;,
       &#39;CHELSA_bio4&#39;, &#39;convergence&#39;, &#39;cti&#39;, &#39;devmagnitude&#39;, &#39;eastness&#39;,
       &#39;elev&#39;, &#39;glad_ard_SVVI_max&#39;, &#39;glad_ard_SVVI_med&#39;,
       &#39;glad_ard_SVVI_min&#39;, &#39;northness&#39;, &#39;ORCDRC_WeigAver&#39;,
       &#39;outlet_dist_dw_basin&#39;, &#39;SBIO3_Isothermality_5_15cm&#39;,
       &#39;SBIO4_Temperature_Seasonality_5_15cm&#39;, &#39;treecover&#39;], dtype=object)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RESPONSE VARIABLE DIMENSION:&quot;</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
RESPONSE VARIABLE DIMENSION: (100000, 1)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PREDICTING FEATURES DIMENSION:&quot;</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PREDICTING FEATURES DIMENSION: (100000, 18)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Model-run-using-default-parameters-and-wuality-flag-selected-data">
<h2>Model run using default parameters and wuality flag selected data<a class="headerlink" href="#Model-run-using-default-parameters-and-wuality-flag-selected-data" title="Link to this heading"></a></h2>
<p>Training Random Forest using default parameters</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rfReg</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rfReg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
<span class="n">dic_pred</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rfReg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rfReg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># checking the oob score</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OUT OF BAG SCORE:&quot;</span><span class="p">,</span> <span class="n">rfReg</span><span class="o">.</span><span class="n">oob_score_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
OUT OF BAG SCORE: 0.37252902906812235
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pearsonr_all_sel</span> <span class="o">=</span> <span class="p">[</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span><span class="n">y_train</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span><span class="n">y_test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PEARSON CORRELATION COEFFINCENT:&quot;</span><span class="p">,</span> <span class="n">pearsonr_all_sel</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PEARSON CORRELATION COEFFINCENT: [0.746007848830619, 0.6125852590365624]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span><span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Training GEDI Height (all dataset)</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Training Tree Height prediction</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">ident</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span><span class="n">ident</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x712ff41c05c0&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_72_1.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_72_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">dic_pred</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Testing GEDI Height (all dataset)</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Testing Tree Height prediction</span><span class="se">\n</span><span class="s1"> (m)&#39;</span><span class="p">)</span>
<span class="n">ident</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span><span class="n">ident</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x712ff3e5f7d0&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_73_1.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_73_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">impt</span> <span class="o">=</span> <span class="p">[</span><span class="n">rfReg</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">feature_importances_</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">rfReg</span><span class="o">.</span><span class="n">estimators_</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">impt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 1, 13,  0,  4, 16,  6,  8, 15,  5,  2, 11,  3, 12,  9, 14,  7, 10,
       17])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feat</span><span class="p">)),</span><span class="n">impt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">impt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feat</span><span class="p">)),</span><span class="n">feat</span><span class="p">[</span><span class="n">ind</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_76_0.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_76_0.png" />
</div>
</div>
</section>
<section id="Model-Final-Assesment">
<h2>Model Final Assesment<a class="headerlink" href="#Model-Final-Assesment" title="Link to this heading"></a></h2>
<p>we can do a comparison between published model performance and ours.</p>
<p><strong>Global Forest Canopy Height, 2019</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PEARSON CORRELATION INDEX:&quot;</span><span class="p">,</span> <span class="n">pearsonr_Publication_Estimation</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PEARSON CORRELATION INDEX: 0.4527925130004339
</pre></div></div>
</div>
<p><strong>Random Forest Model [100k GEDI subset] [fine tuning=NO] [data selection=NO]</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PEARSON CORRELATION COEFFINCENT:&quot;</span><span class="p">,</span> <span class="n">pearsonr_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PEARSON CORRELATION COEFFINCENT: [0.6035710046325166, 0.506707480767017]
</pre></div></div>
</div>
<p><strong>Random Forest Model [100k GEDI subset] [fine tuning=NO] [data selection=YES]</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PEARSON CORRELATION COEFFINCENT:&quot;</span><span class="p">,</span> <span class="n">pearsonr_all_sel</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PEARSON CORRELATION COEFFINCENT: [0.746007848830619, 0.6125852590365624]
</pre></div></div>
</div>
<p>If we want to improve even more the selected data model, we can perform again a GridSearch hyperparameter fine tuning</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pipeline = Pipeline([(&#39;rf&#39;,RandomForestRegressor())])

parameters = {
    &#39;rf__max_features&#39;:(&quot;log2&quot;,&quot;sqrt&quot;,0.33),
    &#39;rf__max_samples&#39;:(0.5,0.6,0.7),
    &#39;rf__n_estimators&#39;:(500,1000),
    &#39;rf__max_depth&#39;:(50,100,200)}
grid_search = GridSearchCV(pipeline,parameters,n_jobs=-1,cv=3,scoring=&#39;r2&#39;,verbose=1)
grid_search.fit(X_train,y_train)

grid_search.best_score_

print (&#39;Best Training score: %0.3f&#39; % grid_search.best_score_)
print (&#39;Optimal parameters:&#39;)
best_par = grid_search.best_estimator_.get_params()
for par_name in sorted(parameters.keys()):
    print (&#39;\t%s: %r&#39; % (par_name, best_par[par_name]))

rfReg = RandomForestRegressor(n_estimators=500,max_features=&#39;sqrt&#39;,max_depth=50,max_samples=0.6,n_jobs=-1,random_state=24)
rfReg.fit(X_train, y_train);
dic_pred = {}
dic_pred[&#39;train&#39;] = rfReg.predict(X_train)
dic_pred[&#39;test&#39;] = rfReg.predict(X_test)
[pearsonr(dic_pred[&#39;train&#39;],y_train)[0],pearsonr(dic_pred[&#39;test&#39;],y_test)[0]]
</pre></div>
</div>
</section>
<section id="Model-Prediction-on-Raster">
<h2>Model Prediction on Raster<a class="headerlink" href="#Model-Prediction-on-Raster" title="Link to this heading"></a></h2>
<section id="Predict-on-the-raster-using-pyspatialml-(deprecated-library)">
<h3>Predict on the raster using pyspatialml (deprecated library)<a class="headerlink" href="#Predict-on-the-raster-using-pyspatialml-(deprecated-library)" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># import Global Landsat Analysis Ready Data
glad_ard_SVVI_min = &quot;tree_height/geodata_raster/glad_ard_SVVI_min.tif&quot;
glad_ard_SVVI_med = &quot;tree_height/geodata_raster/glad_ard_SVVI_med.tif&quot;
glad_ard_SVVI_max = &quot;tree_height/geodata_raster/glad_ard_SVVI_max.tif&quot;

# import climate data
CHELSA_bio4 = &quot;tree_height/geodata_raster/CHELSA_bio4.tif&quot;
CHELSA_bio18 = &quot;tree_height/geodata_raster/CHELSA_bio18.tif&quot;

# import soil data
BLDFIE_WeigAver = &quot;tree_height/geodata_raster/BLDFIE_WeigAver.tif&quot;
CECSOL_WeigAver = &quot;tree_height/geodata_raster/CECSOL_WeigAver.tif&quot;
ORCDRC_WeigAver = &quot;tree_height/geodata_raster/ORCDRC_WeigAver.tif&quot;

# import geomorphological data (DEM derived)
elev = &quot;tree_height/geodata_raster/elev.tif&quot;
convergence = &quot;tree_height/geodata_raster/convergence.tif&quot;
northness = &quot;tree_height/geodata_raster/northness.tif&quot;
eastness = &quot;tree_height/geodata_raster/eastness.tif&quot;
devmagnitude = &quot;tree_height/geodata_raster/dev-magnitude.tif&quot;

# import hydrographic data (from hydrography90m)
cti = &quot;tree_height/geodata_raster/cti.tif&quot;
outlet_dist_dw_basin = &quot;tree_height/geodata_raster/outlet_dist_dw_basin.tif&quot;

# import soil climate data

SBIO3_Isothermality_5_15cm = &quot;tree_height/geodata_raster/SBIO3_Isothermality_5_15cm.tif&quot;
SBIO4_Temperature_Seasonality_5_15cm = &quot;tree_height/geodata_raster/SBIO4_Temperature_Seasonality_5_15cm.tif&quot;

# import forest cover data

treecover = &quot;tree_height/geodata_raster/treecover.tif&quot;
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>from pyspatialml import Raster
predictors_rasters = [glad_ard_SVVI_min, glad_ard_SVVI_med, glad_ard_SVVI_max,
                      CHELSA_bio4,CHELSA_bio18,
                      BLDFIE_WeigAver,CECSOL_WeigAver,ORCDRC_WeigAver,
                      elev,convergence,northness,eastness,devmagnitude,cti,outlet_dist_dw_basin,
                      SBIO3_Isothermality_5_15cm,SBIO4_Temperature_Seasonality_5_15cm,treecover]

stack = Raster(predictors_rasters)
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>result = stack.predict(estimator=rfReg, dtype=&#39;int16&#39;, nodata=-1)
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot regression result</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;plasma&quot;</span>
<span class="n">result</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_91_0.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_91_0.png" />
</div>
</div>
</section>
<section id="Predict-on-the-raster-using-xarray-and-rasterio-(Full-size-90m-res-raster-prediction-&gt;12h)">
<h3>Predict on the raster using xarray and rasterio (Full size 90m res raster prediction &gt;12h)<a class="headerlink" href="#Predict-on-the-raster-using-xarray-and-rasterio-(Full-size-90m-res-raster-prediction->12h)" title="Link to this heading"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>import xarray as xr
import rasterio
import numpy as np
import pandas as pd
from sklearn.ensemble import RandomForestRegressor
import os

# Define paths to raster files
raster_paths = {
    &#39;glad_ard_SVVI_min&#39;: &quot;tree_height/geodata_raster/glad_ard_SVVI_min.tif&quot;,
    &#39;glad_ard_SVVI_med&#39;: &quot;tree_height/geodata_raster/glad_ard_SVVI_med.tif&quot;,
    &#39;glad_ard_SVVI_max&#39;: &quot;tree_height/geodata_raster/glad_ard_SVVI_max.tif&quot;,
    &#39;CHELSA_bio4&#39;: &quot;tree_height/geodata_raster/CHELSA_bio4.tif&quot;,
    &#39;CHELSA_bio18&#39;: &quot;tree_height/geodata_raster/CHELSA_bio18.tif&quot;,
    &#39;BLDFIE_WeigAver&#39;: &quot;tree_height/geodata_raster/BLDFIE_WeigAver.tif&quot;,
    &#39;CECSOL_WeigAver&#39;: &quot;tree_height/geodata_raster/CECSOL_WeigAver.tif&quot;,
    &#39;ORCDRC_WeigAver&#39;: &quot;tree_height/geodata_raster/ORCDRC_WeigAver.tif&quot;,
    &#39;elev&#39;: &quot;tree_height/geodata_raster/elev.tif&quot;,
    &#39;convergence&#39;: &quot;tree_height/geodata_raster/convergence.tif&quot;,
    &#39;northness&#39;: &quot;tree_height/geodata_raster/northness.tif&quot;,
    &#39;eastness&#39;: &quot;tree_height/geodata_raster/eastness.tif&quot;,
    &#39;devmagnitude&#39;: &quot;tree_height/geodata_raster/dev-magnitude.tif&quot;,
    &#39;cti&#39;: &quot;tree_height/geodata_raster/cti.tif&quot;,
    &#39;outlet_dist_dw_basin&#39;: &quot;tree_height/geodata_raster/outlet_dist_dw_basin.tif&quot;,
    &#39;SBIO3_Isothermality_5_15cm&#39;: &quot;tree_height/geodata_raster/SBIO3_Isothermality_5_15cm.tif&quot;,
    &#39;SBIO4_Temperature_Seasonality_5_15cm&#39;: &quot;tree_height/geodata_raster/SBIO4_Temperature_Seasonality_5_15cm.tif&quot;,
    &#39;treecover&#39;: &quot;tree_height/geodata_raster/treecover.tif&quot;
}

# Load raster files into an xarray Dataset
raster_datasets = []
for name, path in raster_paths.items():
    with rasterio.open(path) as src:
        # Read raster data and convert to xarray DataArray
        data = src.read(1)  # Read the first band
        coords = {
            &#39;y&#39;: np.linspace(src.bounds.top, src.bounds.bottom, src.height),
            &#39;x&#39;: np.linspace(src.bounds.left, src.bounds.right, src.width)
        }
        da = xr.DataArray(data, coords=coords, dims=[&#39;y&#39;, &#39;x&#39;], name=name)
        raster_datasets.append(da)

# Combine all DataArrays into a single Dataset
stack = xr.merge(raster_datasets)

# Prepare data for prediction
# Convert the stack to a 2D array where each row is a pixel and columns are features
feature_names = list(raster_paths.keys())
data_array = stack.to_array(dim=&#39;variable&#39;).transpose(&#39;y&#39;, &#39;x&#39;, &#39;variable&#39;)
data_2d = data_array.values.reshape(-1, len(feature_names))

# Create a mask for valid data (exclude pixels where any predictor is NaN)
valid_mask = ~np.any(np.isnan(data_2d), axis=1)
valid_data = data_2d[valid_mask]

# Predict tree heights for valid pixels using the trained RandomForestRegressor (rfReg)
predictions = np.full(data_2d.shape[0], -1, dtype=np.int16)  # Initialize with nodata value
predictions[valid_mask] = rfReg.predict(valid_data)

# Reshape predictions back to the original raster shape
pred_2d = predictions.reshape(data_array.shape[0], data_array.shape[1])

# Save the prediction as a new raster file
output_path = &quot;tree_height/geodata_raster/predicted_tree_height.tif&quot;
with rasterio.open(
    list(raster_paths.values())[0],  # Use the first raster as a template for metadata
) as src:
    profile = src.profile
    profile.update(dtype=rasterio.int16, nodata=-1)

with rasterio.open(output_path, &#39;w&#39;, **profile) as dst:
    dst.write(pred_2d, 1)

# Plot the result using xarray
ds_pred = xr.DataArray(pred_2d, coords={&#39;y&#39;: stack.y, &#39;x&#39;: stack.x}, dims=[&#39;y&#39;, &#39;x&#39;], name=&#39;predicted_height&#39;)
ds_pred.plot(cmap=&#39;plasma&#39;, figsize=(12, 12))
plt.title(&quot;Predicted Tree Height&quot;)
plt.show()
</pre></div>
</div>
</section>
<section id="Predict-on-the-raster-using-xarray-and-rasterio-(1000x1000-UL-corner-tile-for-90m-res-raster-prediction)">
<h3>Predict on the raster using xarray and rasterio (1000x1000 UL corner tile for 90m res raster prediction)<a class="headerlink" href="#Predict-on-the-raster-using-xarray-and-rasterio-(1000x1000-UL-corner-tile-for-90m-res-raster-prediction)" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[92]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define paths to raster files</span>
<span class="n">raster_paths</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># import Global Landsat Analysis Ready Data</span>
    <span class="s1">&#39;glad_ard_SVVI_min&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/glad_ard_SVVI_min.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;glad_ard_SVVI_med&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/glad_ard_SVVI_med.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;glad_ard_SVVI_max&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/glad_ard_SVVI_max.tif&quot;</span><span class="p">,</span>
    <span class="c1"># import climate data</span>
    <span class="s1">&#39;CHELSA_bio4&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/CHELSA_bio4.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;CHELSA_bio18&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/CHELSA_bio18.tif&quot;</span><span class="p">,</span>
    <span class="c1"># import soil data</span>
    <span class="s1">&#39;BLDFIE_WeigAver&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/BLDFIE_WeigAver.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;CECSOL_WeigAver&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/CECSOL_WeigAver.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;ORCDRC_WeigAver&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/ORCDRC_WeigAver.tif&quot;</span><span class="p">,</span>
    <span class="c1"># import geomorphological data (DEM derived)</span>
    <span class="s1">&#39;elev&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/elev.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;convergence&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/convergence.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;northness&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/northness.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;eastness&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/eastness.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;devmagnitude&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/dev-magnitude.tif&quot;</span><span class="p">,</span>
    <span class="c1"># import hydrographic data (from hydrography90m)</span>
    <span class="s1">&#39;cti&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/cti.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;outlet_dist_dw_basin&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/outlet_dist_dw_basin.tif&quot;</span><span class="p">,</span>
    <span class="c1"># import soil climate data</span>
    <span class="s1">&#39;SBIO3_Isothermality_5_15cm&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/SBIO3_Isothermality_5_15cm.tif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;SBIO4_Temperature_Seasonality_5_15cm&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/SBIO4_Temperature_Seasonality_5_15cm.tif&quot;</span><span class="p">,</span>
    <span class="c1"># import forest cover data</span>
    <span class="s1">&#39;treecover&#39;</span><span class="p">:</span> <span class="s2">&quot;tree_height/geodata_raster/treecover.tif&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio.windows</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="c1"># Define a small window (1000x1000 UL corner) to avoid high time/computation demand</span>
<span class="n">window</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">Window</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Load raster files into an xarray Dataset with NoData handling</span>
<span class="n">raster_datasets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">raster_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Get NoData value from raster metadata</span>
        <span class="n">nodata</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span> <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># Read data within the specified window</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

        <span class="c1"># Replace raster-specific NoData values with np.nan for consistency</span>
        <span class="k">if</span> <span class="n">nodata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">nodata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># Transform coordinates for the window</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
        <span class="n">xs_geo</span><span class="p">,</span> <span class="n">ys_geo</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
        <span class="n">x_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs_geo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># X coordinates for columns</span>
        <span class="n">y_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ys_geo</span><span class="p">])</span>  <span class="c1"># Y coordinates for rows</span>

        <span class="c1"># Create xarray DataArray</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">},</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>  <span class="c1"># Store NoData as NaN in attributes</span>
        <span class="p">)</span>
        <span class="n">raster_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>

<span class="c1"># Combine all DataArrays into a single Dataset</span>
<span class="n">stack</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">raster_datasets</span><span class="p">)</span>

<span class="c1"># Prepare data for prediction</span>
<span class="c1"># Convert the stack to a 2D array where each row is a pixel and columns are features</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raster_paths</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">data_array</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">)</span>
<span class="n">data_2d</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">))</span>

<span class="c1"># Create a mask for valid data (exclude pixels where any predictor is NaN)</span>
<span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_2d</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">valid_data</span> <span class="o">=</span> <span class="n">data_2d</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

<span class="c1"># Predict tree heights for valid pixels using the trained RandomForestRegressor</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">data_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>  <span class="c1"># Initialize with NoData value (-1)</span>
<span class="k">if</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Ensure there is valid data to predict</span>
    <span class="n">predictions</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">rfReg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No valid data (non-NoData pixels) available for prediction.&quot;</span><span class="p">)</span>

<span class="c1"># Reshape predictions back to the original raster shape</span>
<span class="n">pred_2d</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Save the prediction as a new raster file</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;tree_height/geodata_raster/predicted_tree_height_light.tif&quot;</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">raster_paths</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
        <span class="n">nodata</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Explicitly set NoData value</span>
        <span class="n">width</span><span class="o">=</span><span class="n">window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">window_transform</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pred_2d</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plot the result using xarray with NoData masking</span>
<span class="n">ds_pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
    <span class="n">pred_2d</span><span class="p">,</span>
    <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">x</span><span class="p">},</span>
    <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;predicted_tree_height&#39;</span><span class="p">,</span>
    <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Mask NoData values (-1) for visualization</span>
<span class="n">ds_pred_masked</span> <span class="o">=</span> <span class="n">ds_pred</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_pred</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plot with a colorbar and appropriate scaling for tree heights</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">ds_pred_masked</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Tree Height (m)&#39;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Predicted Tree Height (1000x1000px, NoData masked)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X (geographic)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y (geographic)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_96_0.png" src="../_images/CASESTUDY_Tree_Height_03RF_pred_SM_96_0.png" />
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Tree_Height_02Predictors_extraction.html" class="btn btn-neutral float-left" title="Estimation of tree height using GEDI dataset - Predictors extraction at point location" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Tree_Height_04SVM_pred_2022.html" class="btn btn-neutral float-right" title="Estimation of tree height using GEDI dataset - Support Vector Machine for Regression (SVR) - 2022" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Giuseppe Amatulli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>