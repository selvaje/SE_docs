<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1.5. Emulating FLEXPART with a Multi-Layer Perceptron &mdash; Spatial Ecology&#39;s code documentation 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/jupyter-sphinx.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/thebelab.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="1.6. Processing Elmer/Ice output" href="Felicity_Alice_Holmes_Geocomp_project.html" />
    <link rel="prev" title="1.4. Statistical comparison global gridded climate datasets and their influence on LPJ-GUESS model outputs" href="Alexandra_Pongr%C3%A1cz_project_idea.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Spatial Ecology's code documentation
            <img src="../../_static/SE_compact.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">COURSE TRAINERS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../COURSETRAINERS/trainers.html">Spatial Ecology course trainers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">COURSES AROUND THE WORLD</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../COURSESAROUNDTHEWORLD/course_wcsu_02-04_2021.html">Western Connecticut State University 2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COURSESAROUNDTHEWORLD/course_stock_uni_04-05_2021.html">Stockholm University 2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../COURSESAROUNDTHEWORLD/course_geocomp_ml_04-05_2022.html">GeoComp &amp; ML 2022 course</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GEO DATA</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../GEODATA/geomorpho90m/geomorpho90m.html">Geomorpho90m: technical documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">LINUX VIRTUAL MACHINE</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../VIRTUALMACHINE/Setting_Colab_for_for_Spatial_Ecology_course.html">Prepare Colab for Spatial Ecology courses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../VIRTUALMACHINE/Setting_OSGeoLive_for_for_Spatial_Ecology_course.html">Prepare OSGeoLive for Spatial Ecology courses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../VIRTUALMACHINE/Setting_OSGeoLive_curso_para_Ecologia_Espacial.html">Prepare OSGeoLive para el curso de ecología espacial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WEB SEMINARS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../WEBSEMINAR/webseminar.html">Raster/Vector Processing using GDAL/OGR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WEBSEMINAR/webseminar.html#image-processing-using-pktools">Image Processing using Pktools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WEBSEMINAR/webseminar.html#introduction-to-grass-gis">Introduction to GRASS GIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WEBSEMINAR/webseminar.html#geocomputation-with-high-performance-computing">GeoComputation with High Performance Computing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">BASH</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../BASH/bashintro_osgeo.html">Linux Operation System as a base for Spatial Ecology Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BASH/bashinter_osgeo.html">Manipulate text files in bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BASH/bashxargs_osgeo.html">Multi-core bash</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AWK</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../AWK/awk.html">AWK Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GDAL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../GDAL/gdal_osgeo.html">Use GDAL/OGR for raster/vector operations - osgeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GDAL/gdal_colab.html">Use GDAL/OGR for raster/vector operations - colab</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PKTOOLS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PKTOOLS/pktools_osgeo.html">Use PKTOOLS for raster/vector operations - osgeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PKTOOLS/pktools_colab.html">Use PKTOOLS for raster/vector operations - colab</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">R</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../R/R_Intro.html">R Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PYTHON</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PYTHON/Python_Intro.html">Introduction to Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PYTHON/Geo_Python.html">Python &amp; GeoComputation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GRASS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../GRASS/grass_intro.html">GRASS Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GRASS/grass_hydro.html">Using GRASS for stream-network extraction and basins delineation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CASE STUDY</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/SDM1_MWood_gecomp.html">SDM1 : Montane woodcreper - Gecomputation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/SDM1_MWood_Rmodel.html">SDM1 : Montane woodcreper - Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/SDM2_Vath_Rmodel.html">SDM2 : Varied Thrush - Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/manipulate_GSIM.html">Manipulate GSIM files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/Data_type_GTiff.html">Data type in GTiff</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/temporal_interpolation.html">Temporal interpolation of landsat images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/DTW.html">Dynamic Time Warping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/pred_NP.html">Estimating nitrogen and phosphorus concentrations in streams and rivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/NN-day1.html">Estimating nitrogen concentrations in streams and rivers using NN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/NN-day2.html">Autoencoder (AE), Variational Autoencoder (VAE) and Generative Adversarial Network (GAN)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/NN-day3.html">LSTM Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/Tree_Height_01DataExplore.html">Estimation of tree height using GEDI dataset - Data explore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/Tree_Height_02SVM_pred.html">Estimation of tree height using GEDI dataset - Support Vector Machine for Regression (SVR)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/Tree_Height_03RF_pred.html">Estimation of tree height using GEDI dataset - Random Forest prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/Tree_Height_04Perceptron_pred.html">Estimation of tree height using GEDI dataset - Perceptron 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/Tree_Height_04Perceptron_pred_clean.html">Estimation of tree height using GEDI dataset - Clean Data - Perceptron 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CASESTUDY/Tree_Height_05NeuralNets_pred.html">Estimation of tree height using GEDI dataset - Neural Network 1</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Students Projects</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">1. 2021 SWEDEN</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Farzad_VahidiMayamey_sw2021_a.html">1.1. Calculating landcover distribution &amp; vegetation extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="Farzad_VahidiMayamey_sw2021_b.html">1.2. Compiling OTB from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="Alejandro_Uribe_Geo_comp_pro_AU.html">1.3. Observed and simulated internal variability climate feedbacks comparison.</a></li>
<li class="toctree-l2"><a class="reference internal" href="Alexandra_Pongr%C3%A1cz_project_idea.html">1.4. Statistical comparison global gridded climate datasets and their influence on LPJ-GUESS model outputs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">1.5. Emulating FLEXPART with a Multi-Layer Perceptron</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Carlos-Gómez-Ortiz">1.5.1. Carlos Gómez-Ortiz</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Department-of-Physical-Geography-and-Ecosystem-Science">1.5.2. Department of Physical Geography and Ecosystem Science</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Lund-University">1.5.3. Lund University</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Abstract">1.5.3.1. Abstract</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Inverse-modeling-is-a-commonly-used-method-and-a-formal-approach-to-estimate-the-variables-driving-the-evolution-of-a-system,-e.g. greenhouse-gases-(GHG)-sources-and-sinks,-based-on-the-observable-manifestations-of-that-system,-e.g. GHG-concentrations-in-the-atmosphere.-This-has-been-developed-and-applied-for-decades-and-it-covers-a-wide-range-of-techniques-and-mathematical-approaches-as-well-as-topics-in-the-field-of-the-biogeochemistry.-This-implies-the-use-of-multiple-models-such-as-a-CTM-for-generating-background-concentrations,-a-Lagrangian-transport-model-to-generate-regional-concentrations,-and-multiple-flux-models-to-generate-prior-emissions.-All-these-models-take-several-computational-time-besides-the-proper-computational-time-of-the-inverse-modeling.-Replacing-one-of-these-steps-with-a-tool-that-emulates-its-functioning-but-at-a-lower-computational-cost-could-facilitate-testing-and-benchmarking-tasks.-LUMIA-(Lund-University-Modular-Inversion-Algorithm)-(Monteil-&amp;-Scholze,-2019)-is-a-variational-atmospheric-inverse-modeling-system-developed-within-the-regional-European-atmospheric-transport-inversion-comparison-(EUROCOM)-project-(Monteil-et-al.,-2020)-for-optimizing-terrestrial-surface-CO2-fluxes-over-Europe-using-ICOS-in-situ-observations.-In-this-Jupyter-Notebook,-I-will-apply-a-AI-tool-to-emulate-the-Lagrangian-model-FLEXPART-to-simulate-the-regional-concentrations-at-one-of-the-stations-whitin-the-EUROCOM-project.">1.5.4. Inverse modeling is a commonly used method and a formal approach to estimate the variables driving the evolution of a system, e.g. greenhouse gases (GHG) sources and sinks, based on the observable manifestations of that system, e.g. GHG concentrations in the atmosphere. This has been developed and applied for decades and it covers a wide range of techniques and mathematical approaches as well as topics in the field of the biogeochemistry. This implies the use of multiple models such as a CTM for generating background concentrations, a Lagrangian transport model to generate regional concentrations, and multiple flux models to generate prior emissions. All these models take several computational time besides the proper computational time of the inverse modeling. Replacing one of these steps with a tool that emulates its functioning but at a lower computational cost could facilitate testing and benchmarking tasks. LUMIA (Lund University Modular Inversion Algorithm) (Monteil &amp; Scholze, 2019) is a variational atmospheric inverse modeling system developed within the regional European atmospheric transport inversion comparison (EUROCOM) project (Monteil et al., 2020) for optimizing terrestrial surface CO2 fluxes over Europe using ICOS in-situ observations. In this Jupyter Notebook, I will apply a AI tool to emulate the Lagrangian model FLEXPART to simulate the regional concentrations at one of the stations whitin the EUROCOM project.</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Import-packages">1.5.4.1. Import packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Download-data">1.5.4.2. Download data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Retrieve-data-from-swestore">1.5.4.3. Retrieve data from swestore</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Plot-fluxes-and-observations">1.5.4.4. Plot fluxes and observations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Modeling-observations">1.5.4.5. Modeling observations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Felicity_Alice_Holmes_Geocomp_project.html">1.6. Processing Elmer/Ice output</a></li>
<li class="toctree-l2"><a class="reference internal" href="Hamm_Alexandra_final_project.html">1.7. pan-Arctic classified slope and aspect maps (Geo computation only)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Jacopo_Cantoni_SeasonAnalisis.html">1.8. Seasonal Analisis of discharges in the Mälaren catchement.</a></li>
<li class="toctree-l2"><a class="reference internal" href="Julia_Wagner_Geocomputation.html">1.9. Mapping of soil organic carbon stocks with Random Forest</a></li>
<li class="toctree-l2"><a class="reference internal" href="Kap%C3%A1s_Roz%C3%A1lia_project.html">1.10. NDVI Computation</a></li>
<li class="toctree-l2"><a class="reference internal" href="SaeidAminjafariProject.html">1.11. Phase Change Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="Tatiana_Klisho_project.html">1.12. Relationship between continental-scale patterns of fire activity and modes of climate variability</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">OUTDOOR</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OUTDOOR/outdoor_orientering.html">Do not get lost in the wilderness</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TALKS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TALKS/intelligent_modelling.html">Intelligent modelling in time and space: combine GeoComputation and Machine Learning for  environmental application.</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ADMIN</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ADMIN/00_pktools_gdrive_install.html">Install pktools on the gdrive and be able to use from any Colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ADMIN/video.html">Video tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ADMIN/Compiling_OTB.html">Compiling OTB from source</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spatial Ecology's code documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html"><span class="section-number">1. </span>2021 SWEDEN</a> &raquo;</li>
      <li><span class="section-number">1.5. </span>Emulating FLEXPART with a Multi-Layer Perceptron</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/STUDENTSPROJECTS/Proj_2021_SW/Carlos_Gómez-Ortiz_GeocomputationProject.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Emulating-FLEXPART-with-a-Multi-Layer-Perceptron">
<h1><span class="section-number">1.5. </span>Emulating FLEXPART with a Multi-Layer Perceptron<a class="headerlink" href="#Emulating-FLEXPART-with-a-Multi-Layer-Perceptron" title="Permalink to this headline"></a></h1>
<section id="Carlos-Gómez-Ortiz">
<h2><span class="section-number">1.5.1. </span>Carlos Gómez-Ortiz<a class="headerlink" href="#Carlos-Gómez-Ortiz" title="Permalink to this headline"></a></h2>
</section>
<section id="Department-of-Physical-Geography-and-Ecosystem-Science">
<h2><span class="section-number">1.5.2. </span>Department of Physical Geography and Ecosystem Science<a class="headerlink" href="#Department-of-Physical-Geography-and-Ecosystem-Science" title="Permalink to this headline"></a></h2>
</section>
<section id="Lund-University">
<h2><span class="section-number">1.5.3. </span>Lund University<a class="headerlink" href="#Lund-University" title="Permalink to this headline"></a></h2>
<section id="Abstract">
<h3><span class="section-number">1.5.3.1. </span>Abstract<a class="headerlink" href="#Abstract" title="Permalink to this headline"></a></h3>
</section>
</section>
<section id="Inverse-modeling-is-a-commonly-used-method-and-a-formal-approach-to-estimate-the-variables-driving-the-evolution-of-a-system,-e.g. greenhouse-gases-(GHG)-sources-and-sinks,-based-on-the-observable-manifestations-of-that-system,-e.g. GHG-concentrations-in-the-atmosphere.-This-has-been-developed-and-applied-for-decades-and-it-covers-a-wide-range-of-techniques-and-mathematical-approaches-as-well-as-topics-in-the-field-of-the-biogeochemistry.-This-implies-the-use-of-multiple-models-such-as-a-CTM-for-generating-background-concentrations,-a-Lagrangian-transport-model-to-generate-regional-concentrations,-and-multiple-flux-models-to-generate-prior-emissions.-All-these-models-take-several-computational-time-besides-the-proper-computational-time-of-the-inverse-modeling.-Replacing-one-of-these-steps-with-a-tool-that-emulates-its-functioning-but-at-a-lower-computational-cost-could-facilitate-testing-and-benchmarking-tasks.-LUMIA-(Lund-University-Modular-Inversion-Algorithm)-(Monteil-&amp;-Scholze,-2019)-is-a-variational-atmospheric-inverse-modeling-system-developed-within-the-regional-European-atmospheric-transport-inversion-comparison-(EUROCOM)-project-(Monteil-et-al.,-2020)-for-optimizing-terrestrial-surface-CO2-fluxes-over-Europe-using-ICOS-in-situ-observations.-In-this-Jupyter-Notebook,-I-will-apply-a-AI-tool-to-emulate-the-Lagrangian-model-FLEXPART-to-simulate-the-regional-concentrations-at-one-of-the-stations-whitin-the-EUROCOM-project.">
<h2><span class="section-number">1.5.4. </span>Inverse modeling is a commonly used method and a formal approach to estimate the variables driving the evolution of a system, e.g. greenhouse gases (GHG) sources and sinks, based on the observable manifestations of that system, e.g. GHG concentrations in the atmosphere. This has been developed and applied for decades and it covers a wide range of techniques and mathematical approaches as well as topics in the field of the biogeochemistry. This implies the use of multiple models such as a CTM for generating background concentrations, a Lagrangian transport model to generate regional concentrations, and multiple flux models to generate prior emissions. All these models take several computational time besides the proper computational time of the inverse modeling. Replacing one of these steps with a tool that emulates its functioning but at a lower computational cost could facilitate testing and benchmarking tasks. LUMIA (Lund University Modular Inversion Algorithm) (Monteil &amp; Scholze, 2019) is a variational atmospheric inverse modeling system developed within the regional European atmospheric transport inversion comparison (EUROCOM) project (Monteil et al., 2020) for optimizing terrestrial surface CO2 fluxes over Europe using ICOS in-situ observations. In this Jupyter Notebook, I will apply a AI tool to emulate the Lagrangian model FLEXPART to simulate the regional concentrations at one of the stations whitin the EUROCOM project.<a class="headerlink" href="#Inverse-modeling-is-a-commonly-used-method-and-a-formal-approach-to-estimate-the-variables-driving-the-evolution-of-a-system,-e.g. greenhouse-gases-(GHG)-sources-and-sinks,-based-on-the-observable-manifestations-of-that-system,-e.g. GHG-concentrations-in-the-atmosphere.-This-has-been-developed-and-applied-for-decades-and-it-covers-a-wide-range-of-techniques-and-mathematical-approaches-as-well-as-topics-in-the-field-of-the-biogeochemistry.-This-implies-the-use-of-multiple-models-such-as-a-CTM-for-generating-background-concentrations,-a-Lagrangian-transport-model-to-generate-regional-concentrations,-and-multiple-flux-models-to-generate-prior-emissions.-All-these-models-take-several-computational-time-besides-the-proper-computational-time-of-the-inverse-modeling.-Replacing-one-of-these-steps-with-a-tool-that-emulates-its-functioning-but-at-a-lower-computational-cost-could-facilitate-testing-and-benchmarking-tasks.-LUMIA-(Lund-University-Modular-Inversion-Algorithm)-(Monteil-&-Scholze,-2019)-is-a-variational-atmospheric-inverse-modeling-system-developed-within-the-regional-European-atmospheric-transport-inversion-comparison-(EUROCOM)-project-(Monteil-et-al.,-2020)-for-optimizing-terrestrial-surface-CO2-fluxes-over-Europe-using-ICOS-in-situ-observations.-In-this-Jupyter-Notebook,-I-will-apply-a-AI-tool-to-emulate-the-Lagrangian-model-FLEXPART-to-simulate-the-regional-concentrations-at-one-of-the-stations-whitin-the-EUROCOM-project." title="Permalink to this headline"></a></h2>
<section id="Import-packages">
<h3><span class="section-number">1.5.4.1. </span>Import packages<a class="headerlink" href="#Import-packages" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/carlos/Downloads/urlgrabber-4.0.0&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">urlgrabber.grabber</span> <span class="kn">import</span> <span class="n">URLGrabber</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">lumia</span> <span class="kn">import</span> <span class="n">Tools</span><span class="p">,</span> <span class="n">obsdb</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">meshgrid</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">ones</span><span class="p">,</span> <span class="n">column_stack</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">date_range</span><span class="p">,</span> <span class="n">Timestamp</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">plot</span><span class="p">,</span> <span class="n">subplots</span><span class="p">,</span> <span class="n">subplots_adjust</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">tight_layout</span>
<span class="kn">from</span> <span class="nn">seaborn</span> <span class="kn">import</span> <span class="n">histplot</span>
<span class="kn">import</span> <span class="nn">cartopy</span>

</pre></div>
</div>
</div>
</section>
<section id="Download-data">
<h3><span class="section-number">1.5.4.2. </span>Download data<a class="headerlink" href="#Download-data" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">getFiles</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;Downloads&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span><span class="c1">#&#39;observations.apri.tar.gz&#39;, &#39;observations.apos.tar.gz&#39;, &#39;modelData.apri.nc&#39;, &#39;modelData.apos.nc&#39;], force=False):</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">inv</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">],</span><span class="s1">&#39;.secrets/swestore&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">uname</span><span class="p">,</span> <span class="n">pwd</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="n">grab</span> <span class="o">=</span> <span class="n">URLGrabber</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;https://webdav.swestore.se/snic/tmflex/</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">inv</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">username</span><span class="o">=</span><span class="n">uname</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">pwd</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span> <span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">grab</span><span class="o">.</span><span class="n">urlgrab</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="Retrieve-data-from-swestore">
<h3><span class="section-number">1.5.4.3. </span>Retrieve data from swestore<a class="headerlink" href="#Retrieve-data-from-swestore" title="Permalink to this headline"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;FLEXPART&#39;</span>
<span class="c1"># project = &#39;verify&#39;</span>
<span class="n">project</span> <span class="o">=</span> <span class="s1">&#39;footprints&#39;</span>
<span class="n">inv</span> <span class="o">=</span> <span class="s1">&#39;LPJGUESS_ERA5_hourly.200-g.1.0-e-monthly.weekly_&#39;</span>
<span class="c1"># inv = &#39;eurocom05x05/verify&#39;</span>
<span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;htm.150m.2019-01.hdf&#39;</span><span class="p">]</span>
<span class="c1"># getFiles(folder, project, inv, files)</span>
</pre></div>
</div>
</div>
</section>
<section id="Plot-fluxes-and-observations">
<h3><span class="section-number">1.5.4.4. </span>Plot fluxes and observations<a class="headerlink" href="#Plot-fluxes-and-observations" title="Permalink to this headline"></a></h3>
<section id="Read-the-fluxes">
<h4><span class="section-number">1.5.4.4.1. </span>Read the fluxes<a class="headerlink" href="#Read-the-fluxes" title="Permalink to this headline"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">emis_apri</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Downloads&#39;</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="s1">&#39;modelData.apri.nc&#39;</span><span class="p">))</span>
<span class="n">emis_apos</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Downloads&#39;</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="s1">&#39;modelData.apos.nc&#39;</span><span class="p">))</span>
<span class="n">biosphere_apri</span> <span class="o">=</span> <span class="n">emis_apri</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;emis&#39;</span><span class="p">][:]</span>
<span class="n">biosphere_apos</span> <span class="o">=</span> <span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;emis&#39;</span><span class="p">][:]</span>
</pre></div>
</div>
</div>
</section>
<section id="Read-the-observations">
<h4><span class="section-number">1.5.4.4.2. </span>Read the observations<a class="headerlink" href="#Read-the-observations" title="Permalink to this headline"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">db</span> <span class="o">=</span> <span class="n">obsdb</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Downloads&#39;</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="s1">&#39;observations.apos.tar.gz&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="Determine-the-spatial-and-temporal-coordinates">
<h4><span class="section-number">1.5.4.4.3. </span>Determine the spatial and temporal coordinates<a class="headerlink" href="#Determine-the-spatial-and-temporal-coordinates" title="Permalink to this headline"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">reg</span> <span class="o">=</span> <span class="n">Tools</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">latitudes</span><span class="o">=</span><span class="n">emis_apri</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lats&#39;</span><span class="p">][:],</span> <span class="n">longitudes</span><span class="o">=</span><span class="n">emis_apri</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lons&#39;</span><span class="p">][:])</span>
<span class="n">tstart</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">emis_apri</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;times_start&#39;</span><span class="p">]])</span>
<span class="n">tend</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">emis_apri</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;times_end&#39;</span><span class="p">]])</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">tend</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">tstart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Plot-the-observation-sites">
<h4><span class="section-number">1.5.4.4.4. </span>Plot the observation sites<a class="headerlink" href="#Plot-the-observation-sites" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">cartopy</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">lonmin</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">lonmax</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">latmin</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">latmax</span><span class="p">)</span>
<span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bio_apri_monthly</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">.75</span>
<span class="n">bio_data</span> <span class="o">=</span> <span class="n">bio_apri_monthly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">bio_data</span><span class="p">[</span><span class="n">bio_data</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nan</span>
<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bio_data</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;GnBu&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

<span class="n">coord</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">33</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">site_i</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()):</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">site</span> <span class="o">==</span> <span class="n">site</span><span class="o">.</span><span class="n">Index</span><span class="p">]</span>
    <span class="n">coord</span><span class="p">[</span><span class="n">isite</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">array</span><span class="p">((</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lon</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">site_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coord</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">coord</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">site_i</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Map&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_17_0.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_17_0.png" />
</div>
</div>
</section>
<section id="Compute-monthly-and-daily-fluxes-in-PgC">
<h4><span class="section-number">1.5.4.4.5. </span>Compute monthly and daily fluxes in PgC<a class="headerlink" href="#Compute-monthly-and-daily-fluxes-in-PgC" title="Permalink to this headline"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">biosphere_apri</span> <span class="o">*=</span> <span class="n">reg</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">*</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mf">44.e-6</span> <span class="o">*</span> <span class="mf">1.e-15</span>
<span class="n">biosphere_apos</span> <span class="o">*=</span> <span class="n">reg</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">*</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mf">44.e-6</span> <span class="o">*</span> <span class="mf">1.e-15</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">month</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tstart</span><span class="p">])</span>

<span class="n">bio_apri_monthly</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">nlat</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">nlon</span><span class="p">))</span>
<span class="n">bio_apos_monthly</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">nlat</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">nlon</span><span class="p">))</span>
<span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">bio_apri_monthly</span><span class="p">[</span><span class="n">month</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">biosphere_apri</span><span class="p">[</span><span class="n">months</span> <span class="o">==</span> <span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bio_apos_monthly</span><span class="p">[</span><span class="n">month</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">biosphere_apos</span><span class="p">[</span><span class="n">months</span> <span class="o">==</span> <span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">bios_apri_daily</span> <span class="o">=</span> <span class="n">biosphere_apri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">nlat</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">nlon</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">bios_apos_daily</span> <span class="o">=</span> <span class="n">biosphere_apos</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">nlat</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">nlon</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Plot-daily-fluxes-aggregated-over-the-domain">
<h4><span class="section-number">1.5.4.4.6. </span>Plot daily fluxes aggregated over the domain<a class="headerlink" href="#Plot-daily-fluxes-aggregated-over-the-domain" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">date_range</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">bios_apri_daily</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apri&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">bios_apos_daily</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apos&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fab9d35f250&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_21_1.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_21_1.png" />
</div>
</div>
</section>
<section id="Plot-the-fit-to-observations">
<h4><span class="section-number">1.5.4.4.7. </span>Plot the fit to observations<a class="headerlink" href="#Plot-the-fit-to-observations" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">db</span> <span class="o">=</span> <span class="n">obsdb</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Downloads&#39;</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="s1">&#39;observations.apos.tar.gz&#39;</span><span class="p">))</span>
<span class="n">nsites</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">nsites</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mf">3.5</span><span class="o">*</span><span class="n">nsites</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()):</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">site</span> <span class="o">==</span> <span class="n">site</span><span class="o">.</span><span class="n">Index</span><span class="p">]</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">mix_apri</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apri&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;MediumVioletRed&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apos&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;DodgerBlue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">mix_background</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;FireBrick&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">histplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">dbs</span><span class="o">.</span><span class="n">mix_apri</span><span class="o">-</span><span class="n">dbs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apri&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;MediumVioletRed&#39;</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">)</span>
    <span class="n">histplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="o">-</span><span class="n">dbs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apos&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;DodgerBlue&#39;</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_23_0.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_23_0.png" />
</div>
</div>
</section>
</section>
<section id="Modeling-observations">
<h3><span class="section-number">1.5.4.5. </span>Modeling observations<a class="headerlink" href="#Modeling-observations" title="Permalink to this headline"></a></h3>
<section id="Time-series">
<h4><span class="section-number">1.5.4.5.1. </span>Time-series<a class="headerlink" href="#Time-series" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="n">dbs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">site</span> <span class="o">==</span> <span class="s1">&#39;htm&#39;</span><span class="p">]</span>

<span class="n">tid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">emis_apri</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;times_start&#39;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tid</span><span class="p">)):</span>
    <span class="n">tid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">tid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">time_filled</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">))):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">array</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">time_filled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>


</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1min 57s, sys: 675 ms, total: 1min 57s
Wall time: 1min 57s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">time_gap</span> <span class="o">=</span> <span class="n">delete</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">tid</span><span class="p">),</span> <span class="n">time_filled</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">time_gap_plot</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_gap</span><span class="p">)))</span><span class="o">*</span><span class="mi">450</span>
<span class="n">time_gap_plot</span> <span class="o">=</span> <span class="n">column_stack</span><span class="p">((</span><span class="n">time_gap</span><span class="p">,</span><span class="n">time_gap_plot</span><span class="p">))</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_gap_plot</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">time_gap_plot</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;gap&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Hyltemossa&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Gaps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_27_0.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_27_0.png" />
</div>
</div>
</section>
<section id="Preparing-input-data">
<h4><span class="section-number">1.5.4.5.2. </span>Preparing input data<a class="headerlink" href="#Preparing-input-data" title="Permalink to this headline"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lat</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lats&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lats&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.25</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lon</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lons&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lon</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lons&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lon</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.25</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">biosphere_apos_htm</span> <span class="o">=</span> <span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;emis&#39;</span><span class="p">][:,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]</span>
<span class="n">fossil_apos_htm</span> <span class="o">=</span> <span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;fossil&#39;</span><span class="p">][</span><span class="s1">&#39;emis&#39;</span><span class="p">][:,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]</span>

<span class="n">biosphere_apos_htm_nogap</span> <span class="o">=</span> <span class="n">biosphere_apos_htm</span><span class="p">[</span><span class="n">time_filled</span><span class="p">]</span>
<span class="n">fossil_apos_htm_nogap</span> <span class="o">=</span> <span class="n">fossil_apos_htm</span><span class="p">[</span><span class="n">time_filled</span><span class="p">]</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">column_stack</span><span class="p">((</span><span class="n">biosphere_apos_htm_nogap</span><span class="p">,</span> <span class="n">fossil_apos_htm_nogap</span><span class="p">))</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Importing-additional-packages">
<h4><span class="section-number">1.5.4.5.3. </span>Importing additional packages<a class="headerlink" href="#Importing-additional-packages" title="Permalink to this headline"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">regularizers</span><span class="p">,</span> <span class="n">optimizers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Activation</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">TimeDistributed</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Lambda</span><span class="p">,</span> <span class="n">concatenate</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">GRU</span><span class="p">,</span> <span class="n">SimpleRNN</span><span class="p">,</span> <span class="n">RNN</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">SGD</span><span class="p">,</span> <span class="n">Adam</span><span class="p">,</span> <span class="n">RMSprop</span><span class="p">,</span> <span class="n">Nadam</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span> <span class="k">as</span> <span class="nn">rn</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow.keras</span> <span class="k">as</span> <span class="nn">keras</span>
<span class="kn">import</span> <span class="nn">time</span>
</pre></div>
</div>
</div>
</section>
<section id="MLP-model">
<h4><span class="section-number">1.5.4.5.4. </span>MLP model<a class="headerlink" href="#MLP-model" title="Permalink to this headline"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">pipline</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span>
            <span class="n">n_nod</span><span class="p">,</span>
            <span class="n">drop_nod</span><span class="p">,</span>
            <span class="n">act_fun</span> <span class="o">=</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>
            <span class="n">out_act_fun</span> <span class="o">=</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span>
            <span class="n">opt_method</span> <span class="o">=</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>
            <span class="n">cost_fun</span> <span class="o">=</span> <span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
            <span class="n">lr_rate</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="n">lambd</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">num_out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="n">lays</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp_dim</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_nod</span>

    <span class="n">main_input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;main_input&#39;</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">main_input</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_nod</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">nod</span><span class="p">,</span>
                  <span class="n">activation</span> <span class="o">=</span> <span class="n">act_fun</span><span class="p">,</span>
                  <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="n">lambd</span><span class="p">))(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="n">drop_nod</span><span class="p">[</span><span class="n">i</span><span class="p">])(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">num_out</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">out_act_fun</span> <span class="p">)(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">optimizers</span><span class="p">,</span> <span class="n">opt_method</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span>  <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">main_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">output</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr_rate</span><span class="p">,</span> <span class="n">clipnorm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">),</span>
                  <span class="n">loss</span> <span class="o">=</span> <span class="n">cost_fun</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Standardization function</span>

<span class="k">def</span> <span class="nf">standard</span><span class="p">(</span><span class="n">comp_data</span><span class="p">,</span> <span class="n">tv_data</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tv_data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">comp_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">comp_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">de_standard</span><span class="p">(</span><span class="n">comp_data</span><span class="p">,</span> <span class="n">pred_data</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">pred_data</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">comp_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">comp_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Function-to-calculate-results">
<h4><span class="section-number">1.5.4.5.5. </span>Function to calculate results<a class="headerlink" href="#Function-to-calculate-results" title="Permalink to this headline"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">stats_reg</span><span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">d_pred</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MSE&#39;</span><span class="p">,</span> <span class="s1">&#39;CorrCoeff&#39;</span><span class="p">]</span>

    <span class="n">pcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d_pred</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="s1">&#39;trn&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">]:</span>
        <span class="n">mse</span> <span class="o">=</span> <span class="n">estimat</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mse</span> <span class="o">=</span> <span class="n">estimat</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">B</span> <span class="o">=</span> <span class="p">[</span><span class="n">mse</span><span class="p">,</span> <span class="n">pcorr</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;STATISTICS for </span><span class="si">{}</span><span class="s1"> Data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">),</span> <span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">):</span>
         <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;   &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Generating-training-and-validation-datasets">
<h4><span class="section-number">1.5.4.5.6. </span>Generating training and validation datasets<a class="headerlink" href="#Generating-training-and-validation-datasets" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Generate training and validation data</span>
<span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">.75</span><span class="p">)</span>
<span class="n">val_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">train_size</span>

<span class="n">train_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">x_train</span> <span class="o">=</span> <span class="n">x</span><span class="p">[[</span><span class="n">train_index</span><span class="p">]]</span>
<span class="n">d_train</span> <span class="o">=</span> <span class="n">d</span><span class="p">[[</span><span class="n">train_index</span><span class="p">]]</span>

<span class="n">x_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">train_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">d_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">train_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Standardization of both inputs and targets</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x_train</span><span class="p">)</span>
<span class="n">x_val</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x_val</span><span class="p">)</span>

<span class="n">d_train</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d_train</span><span class="p">)</span>
<span class="n">d_val</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;ipython-input-60-fc2cd7ff4c1a&gt;:8: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  d_train = d[[train_index]]
</pre></div></div>
</div>
</section>
<section id="Training-the-MLP">
<h4><span class="section-number">1.5.4.5.7. </span>Training the MLP<a class="headerlink" href="#Training-the-MLP" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.0</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>            <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>    <span class="c1">#Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 9 µs, sys: 0 ns, total: 9 µs
Wall time: 15.5 µs
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[231]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.0</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;tanh&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_7&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_14 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_7 (Dropout)          (None, 3)                 0
_________________________________________________________________
dense_15 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00017876314814202487
CorrCoeff   0.612490603484116

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.00019656501535791904
CorrCoeff   0.6010231101273652

 ##################################################
CPU times: user 29min 48s, sys: 53min 44s, total: 1h 23min 33s
Wall time: 3min 34s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[231]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f40d4148f70&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_40_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_40_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_40_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_40_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_40_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_40_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[232]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.0</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_8&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_16 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_8 (Dropout)          (None, 3)                 0
_________________________________________________________________
dense_17 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00016998716455418617
CorrCoeff   0.6229274626422414

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.0001797070144675672
CorrCoeff   0.6126583323489367

 ##################################################
CPU times: user 28min 57s, sys: 51min 55s, total: 1h 20min 52s
Wall time: 3min 27s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[232]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f41042b55e0&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_41_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_41_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_41_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_41_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_41_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_41_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[233]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.0</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_9&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_18 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_9 (Dropout)          (None, 3)                 0
_________________________________________________________________
dense_19 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00025753240333870053
CorrCoeff   0.28453889146907146

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.0002598793071229011
CorrCoeff   0.32232902575332284

 ##################################################
CPU times: user 29min 27s, sys: 52min 55s, total: 1h 22min 22s
Wall time: 3min 31s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[233]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f4104622520&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_42_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_42_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_42_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_42_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_42_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_42_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[234]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.0</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;softmax&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_10&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_20 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_10 (Dropout)         (None, 3)                 0
_________________________________________________________________
dense_21 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.006078554317355156
CorrCoeff   nan

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.0060547417961061
CorrCoeff   nan

 ##################################################
CPU times: user 30min 4s, sys: 53min 53s, total: 1h 23min 58s
Wall time: 3min 35s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/lib/function_base.py:2642: RuntimeWarning: invalid value encountered in true_divide
  c /= stddev[:, None]
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/lib/function_base.py:2643: RuntimeWarning: invalid value encountered in true_divide
  c /= stddev[None, :]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[234]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f414e98f1f0&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_43_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_43_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_43_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_43_4.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_43_5.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_43_5.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[235]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.0</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;SGD&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_11&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_22 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_11 (Dropout)         (None, 3)                 0
_________________________________________________________________
dense_23 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.0001678869448369369
CorrCoeff   0.629566898360391

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.00017670282977633178
CorrCoeff   0.6177834055093928

 ##################################################
CPU times: user 29min, sys: 52min 7s, total: 1h 21min 7s
Wall time: 3min 27s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[235]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f4104457400&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_44_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_44_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_44_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_44_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_44_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_44_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[236]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.0</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Nadam&#39;</span><span class="p">,</span>          <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_12&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_24 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_12 (Dropout)         (None, 3)                 0
_________________________________________________________________
dense_25 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00016082111687865108
CorrCoeff   0.65416212866746

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.00017367156397085637
CorrCoeff   0.6334759651999986

 ##################################################
CPU times: user 29min 51s, sys: 53min 54s, total: 1h 23min 46s
Wall time: 3min 34s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[236]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f40f5c47b80&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_45_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_45_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_45_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_45_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_45_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_45_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[237]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.0</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;RMSprop&#39;</span><span class="p">,</span>        <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_13&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_26 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_13 (Dropout)         (None, 3)                 0
_________________________________________________________________
dense_27 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00021665332315023988
CorrCoeff   0.6523700632199257

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.0002438862866256386
CorrCoeff   0.6308466959417949

 ##################################################
CPU times: user 30min 18s, sys: 54min 16s, total: 1h 24min 34s
Wall time: 3min 40s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[237]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f416e550ca0&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_46_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_46_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_46_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_46_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_46_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_46_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[238]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.01</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>   <span class="c1"># Batch size = all data (batch learning)</span>
                      <span class="c1">#batch_size=150,                    # Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_14&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_28 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_14 (Dropout)         (None, 3)                 0
_________________________________________________________________
dense_29 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.0011568532790988684
CorrCoeff   0.27274236652685657

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.00026253453688696027
CorrCoeff   0.31293852699811564

 ##################################################
CPU times: user 26min 50s, sys: 43min 48s, total: 1h 10min 38s
Wall time: 3min 4s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[238]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f40f5e03fa0&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_47_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_47_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_47_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_47_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_47_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_47_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[239]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.01</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_15&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_30 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_15 (Dropout)         (None, 3)                 0
_________________________________________________________________
dense_31 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00017078199016395956
CorrCoeff   0.6634442592016316

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.00016517832409590483
CorrCoeff   0.6523983887574706

 ##################################################
CPU times: user 30min 2s, sys: 53min 44s, total: 1h 23min 46s
Wall time: 3min 35s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[239]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f40f5b2e8b0&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_48_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_48_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_48_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_48_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_48_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_48_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[243]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.01</span><span class="p">],</span>               <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_19&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_38 (Dense)             (None, 3)                 9
_________________________________________________________________
dropout_19 (Dropout)         (None, 3)                 0
_________________________________________________________________
dense_39 (Dense)             (None, 1)                 4
=================================================================
Total params: 13
Trainable params: 13
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00016062274517025799
CorrCoeff   0.6645116727126994

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.0001652294013183564
CorrCoeff   0.6536313767355278

 ##################################################
CPU times: user 29min 38s, sys: 53min 7s, total: 1h 22min 46s
Wall time: 3min 33s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[243]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f40f6cab370&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_49_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_49_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_49_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_49_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_49_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_49_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[251]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.01</span><span class="p">],</span>              <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_27&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_54 (Dense)             (None, 6)                 18
_________________________________________________________________
dropout_27 (Dropout)         (None, 6)                 0
_________________________________________________________________
dense_55 (Dense)             (None, 1)                 7
=================================================================
Total params: 25
Trainable params: 25
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00016617908840999007
CorrCoeff   0.668969350336334

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.00016493901784997433
CorrCoeff   0.6560995009257078

 ##################################################
CPU times: user 29min 14s, sys: 52min 20s, total: 1h 21min 34s
Wall time: 3min 29s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[251]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f4084637f10&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_50_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_50_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_50_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_50_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_50_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_50_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[252]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.01</span><span class="p">],</span>              <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_28&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_56 (Dense)             (None, 9)                 27
_________________________________________________________________
dropout_28 (Dropout)         (None, 9)                 0
_________________________________________________________________
dense_57 (Dense)             (None, 1)                 10
=================================================================
Total params: 37
Trainable params: 37
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00015652619185857475
CorrCoeff   0.6705900837463853

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.00016342980961780995
CorrCoeff   0.6556862691323897

 ##################################################
CPU times: user 30min 11s, sys: 54min 12s, total: 1h 24min 23s
Wall time: 3min 36s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[252]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f40f5a0f160&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_51_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_51_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_51_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_51_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_51_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_51_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[254]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.01</span><span class="p">],</span>              <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_30&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_60 (Dense)             (None, 12)                36
_________________________________________________________________
dropout_30 (Dropout)         (None, 12)                0
_________________________________________________________________
dense_61 (Dense)             (None, 1)                 13
=================================================================
Total params: 49
Trainable params: 49
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.00015669157437514514
CorrCoeff   0.6730087345978446

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.00016233550559263676
CorrCoeff   0.6582768498106989

 ##################################################
CPU times: user 29min 44s, sys: 53min 19s, total: 1h 23min 3s
Wall time: 3min 32s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[254]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f4104127a00&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_52_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_52_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_52_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_52_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_52_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_52_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># Define the network, cost function and minimization method</span>
<span class="n">INPUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inp_dim&#39;</span><span class="p">:</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;n_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">],</span>                   <span class="c1"># number of nodes in hidden layer</span>
         <span class="s1">&#39;drop_nod&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">.01</span><span class="p">],</span>              <span class="c1"># fraction of the input units to drop</span>
         <span class="s1">&#39;act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;relu&#39;</span><span class="p">,</span>              <span class="c1"># activation functions for the hidden layer</span>
         <span class="s1">&#39;out_act_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>        <span class="c1"># output activation function</span>
         <span class="s1">&#39;opt_method&#39;</span><span class="p">:</span> <span class="s1">&#39;Adam&#39;</span><span class="p">,</span>           <span class="c1"># minimization method</span>
         <span class="s1">&#39;cost_fun&#39;</span><span class="p">:</span> <span class="s1">&#39;mse&#39;</span><span class="p">,</span>              <span class="c1"># error function</span>
         <span class="s1">&#39;lr_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>               <span class="c1"># learningrate</span>
         <span class="s1">&#39;lambd&#39;</span> <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>                  <span class="c1"># L2</span>
         <span class="s1">&#39;num_out&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>                 <span class="c1"># if binary --&gt; 1 |  regression--&gt; num output | multi-class--&gt; num of classes</span>

<span class="c1"># Get the model</span>
<span class="n">model_ex3</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

<span class="c1"># Print a summary of the model</span>
<span class="n">model_ex3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Train the model</span>
<span class="n">estimator_ex3</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                      <span class="n">d_train</span><span class="p">,</span>
                      <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>      <span class="c1"># Number of epochs</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                      <span class="c1">#batch_size = x_train.shape[0],   # Batch size = all data (batch learning)</span>
                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>                    <span class="c1"># Batch size for true SGD</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Call the stats function to print out statistics for classification problems</span>
<span class="n">pred_trn</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_val</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>
<span class="n">stats_reg</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">estimator_ex3</span><span class="p">)</span>

<span class="c1"># Scatter plots of predicted and true values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_train</span><span class="p">,</span> <span class="n">pred_trn</span><span class="p">,</span> <span class="s1">&#39;g*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Training)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="s1">&#39;b*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predict vs True (Validation)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># Training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;Model training&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;training error&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">estimator_ex3</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">k</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;model_33&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
main_input (InputLayer)      [(None, 2)]               0
_________________________________________________________________
dense_66 (Dense)             (None, 15)                45
_________________________________________________________________
dropout_33 (Dropout)         (None, 15)                0
_________________________________________________________________
dense_67 (Dense)             (None, 1)                 16
=================================================================
Total params: 61
Trainable params: 61
Non-trainable params: 0
_________________________________________________________________

 ########## STATISTICS for Training Data ##########

MSE   0.5419843792915344
CorrCoeff   0.6782207027684092

 ##################################################

 ########## STATISTICS for Validation Data ##########

MSE   0.5472683906555176
CorrCoeff   0.6924202708728275

 ##################################################
CPU times: user 34min 48s, sys: 1h 4min 43s, total: 1h 39min 32s
Wall time: 4min 15s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f4a18f3eee0&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_53_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_53_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_53_3.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_53_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_53_4.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_53_4.png" />
</div>
</div>
</section>
<section id="Plotting-results">
<h4><span class="section-number">1.5.4.5.8. </span>Plotting results<a class="headerlink" href="#Plotting-results" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="n">x_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">biosphere_apos_htm</span><span class="p">,</span> <span class="n">fossil_apos_htm</span><span class="p">))</span>

<span class="n">x_std</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x_comp</span><span class="p">)</span>

<span class="n">d_pred</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_std</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">biosphere_apos_htm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">d_pred_dstd</span> <span class="o">=</span> <span class="n">de_standard</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d_pred</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apos&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">d_pred_dstd</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Hyltemossa&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 7.38 s, sys: 13.9 s, total: 21.3 s
Wall time: 991 ms
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(17905.958333333332, 18261.958333333332)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_55_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_55_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="n">x_std</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="n">d_pred</span> <span class="o">=</span> <span class="n">model_ex3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_std</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">biosphere_apos_htm_nogap</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">d_pred_dstd</span> <span class="o">=</span> <span class="n">de_standard</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d_pred</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apos&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">d_pred_dstd</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Hyltemossa&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 3.45 s, sys: 6.88 s, total: 10.3 s
Wall time: 500 ms
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(17905.958333333332, 18261.958333333332)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_56_2.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_56_2.png" />
</div>
</div>
</section>
<section id="Training-MLPs-for-all-sites">
<h4><span class="section-number">1.5.4.5.9. </span>Training MLPs for all sites<a class="headerlink" href="#Training-MLPs-for-all-sites" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()):</span>

    <span class="n">dbs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">site</span> <span class="o">==</span> <span class="n">site</span><span class="o">.</span><span class="n">Index</span><span class="p">]</span>

    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lats&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lats&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.25</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lons&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lon</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lons&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lon</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.25</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">biosphere_apos</span> <span class="o">=</span> <span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;emis&#39;</span><span class="p">][:,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]</span>
    <span class="n">fossil_apos</span> <span class="o">=</span> <span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;fossil&#39;</span><span class="p">][</span><span class="s1">&#39;emis&#39;</span><span class="p">][:,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]</span>

    <span class="n">time_filled</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">))):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">array</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time_filled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">biosphere_apos_nogap</span> <span class="o">=</span> <span class="n">biosphere_apos</span><span class="p">[</span><span class="n">time_filled</span><span class="p">]</span>
    <span class="n">fossil_apos_nogap</span> <span class="o">=</span> <span class="n">fossil_apos</span><span class="p">[</span><span class="n">time_filled</span><span class="p">]</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">column_stack</span><span class="p">((</span><span class="n">biosphere_apos_nogap</span><span class="p">,</span> <span class="n">fossil_apos_nogap</span><span class="p">))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">)</span>

    <span class="c1"># Generate training and validation data</span>
    <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">.75</span><span class="p">)</span>
    <span class="n">val_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">train_size</span>

    <span class="n">train_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x</span><span class="p">[[</span><span class="n">train_index</span><span class="p">]]</span>
    <span class="n">d_train</span> <span class="o">=</span> <span class="n">d</span><span class="p">[[</span><span class="n">train_index</span><span class="p">]]</span>

    <span class="n">x_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">train_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">d_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">train_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Standardization of both inputs and targets</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x_train</span><span class="p">)</span>
    <span class="n">x_val</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x_val</span><span class="p">)</span>

    <span class="n">d_train</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d_train</span><span class="p">)</span>
    <span class="n">d_val</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d_val</span><span class="p">)</span>

    <span class="c1">#MLP training</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">pipline</span><span class="p">(</span><span class="o">**</span><span class="n">INPUT</span><span class="p">)</span>

    <span class="n">estimator</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span>
                          <span class="n">d_train</span><span class="p">,</span>
                          <span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span><span class="n">d_val</span><span class="p">),</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                          <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">Index</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">isite</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
bir 0
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
bsd 1
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
cmn 2
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dec 3
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dig 4
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
gat 5
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
hpb 6
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
htm 7
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
hun 8
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ipr 9
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
jfj 10
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
kit 11
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
kre 12
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
lin 13
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
lmu 14
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
lut 15
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
nor 16
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ope 17
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
oxk 18
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
pal 19
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
puy 20
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
rgl 21
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sac 22
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
smr 23
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ssl 24
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ste 25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
svb 26
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tac 27
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
toh 28
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
trn 29
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
uto 30
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
wao 31
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/carlos/miniconda3/envs/geocomp/lib/python3.9/site-packages/numpy/ma/core.py:3220: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  dout = self.data[indx]
&lt;timed exec&gt;:30: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
zsf 32
CPU times: user 16h 43min 28s, sys: 1d 5h 32min 9s, total: 1d 22h 15min 38s
Wall time: 2h 42min 41s
</pre></div></div>
</div>
</section>
<section id="Plotting-results-for-all-sites">
<h4><span class="section-number">1.5.4.5.10. </span>Plotting results for all sites<a class="headerlink" href="#Plotting-results-for-all-sites" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="c1"># db = obsdb(os.path.join(&#39;Downloads&#39;, inv, &#39;observations.apos.tar.gz&#39;))</span>
<span class="n">nsites</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="n">nsites</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mf">3.5</span><span class="o">*</span><span class="n">nsites</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()):</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">site</span> <span class="o">==</span> <span class="n">site</span><span class="o">.</span><span class="n">Index</span><span class="p">]</span>

    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lats&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lats&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.25</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lons&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lon</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;lons&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">lon</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.25</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">biosphere_apos</span> <span class="o">=</span> <span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;biosphere&#39;</span><span class="p">][</span><span class="s1">&#39;emis&#39;</span><span class="p">][:,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]</span>
    <span class="n">fossil_apos</span> <span class="o">=</span> <span class="n">emis_apos</span><span class="p">[</span><span class="s1">&#39;fossil&#39;</span><span class="p">][</span><span class="s1">&#39;emis&#39;</span><span class="p">][:,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]</span>

    <span class="n">time_filled</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">))):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">array</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time_filled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">biosphere_apos_nogap</span> <span class="o">=</span> <span class="n">biosphere_apos</span><span class="p">[</span><span class="n">time_filled</span><span class="p">]</span>
    <span class="n">fossil_apos_nogap</span> <span class="o">=</span> <span class="n">fossil_apos</span><span class="p">[</span><span class="n">time_filled</span><span class="p">]</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">column_stack</span><span class="p">((</span><span class="n">biosphere_apos_nogap</span><span class="p">,</span> <span class="n">fossil_apos_nogap</span><span class="p">))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">)</span>

    <span class="n">x_std</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">model</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">Index</span><span class="p">))</span>

    <span class="n">d_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_std</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">biosphere_apos_nogap</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">d_pred_dstd</span> <span class="o">=</span> <span class="n">de_standard</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d_pred</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apos&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;DodgerBlue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">d_pred_dstd</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;FireBrick&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">histplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="o">-</span><span class="n">dbs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apos&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;MediumVioletRed&#39;</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">)</span>
    <span class="n">histplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d_pred_dstd</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">obs</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;DodgerBlue&#39;</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">isite</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Pred&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 45min 58s, sys: 2min 32s, total: 48min 31s
Wall time: 45min 2s
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_60_1.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_60_1.png" />
</div>
</div>
</section>
<section id="Conclusions">
<h4><span class="section-number">1.5.4.5.11. </span>Conclusions<a class="headerlink" href="#Conclusions" title="Permalink to this headline"></a></h4>
<ul class="simple">
<li><p>The MLP does not identify peaks.</p></li>
<li><p>Generating the emulator is feasible, the MLP just need more tuning.</p></li>
<li><p>The emulator calculate observations in less than 1min against 1hr of FLEXPART.</p></li>
<li><p>It is necessary to explore other ML and DL techniques.</p></li>
</ul>
</section>
<section id="References">
<h4><span class="section-number">1.5.4.5.12. </span>References<a class="headerlink" href="#References" title="Permalink to this headline"></a></h4>
<ul class="simple">
<li><p>Monteil, G., Broquet, G., Scholze, M., Lang, M., Karstens, U., Gerbig, C., Koch, F.-T., Smith, N. E., Thompson, R. L., Luijkx, I. T., White, E., Meesters, A., Ciais, P., Ganesan, A. L., Manning, A., Mischurow, M., Peters, W., Peylin, P., Tarniewicz, J., Rigby, M., Rödenbeck, C., Vermeulen, A., and Walton, E. M.: The regional European atmospheric transport inversion comparison, EUROCOM: first results on European-wide terrestrial carbon fluxes for the period 2006–2015, Atmos. Chem. Phys., 20,
12063–12091, <a class="reference external" href="https://doi.org/10.5194/acp-20-12063-2020">https://doi.org/10.5194/acp-20-12063-2020</a>, 2020.</p></li>
<li><p>Monteil, G. and Scholze, M.: Regional CO2 inversions with LUMIA, the Lund University Modular Inversion Algorithm, v1.0, Geosci. Model Dev., 14, 3383–3406, <a class="reference external" href="https://doi.org/10.5194/gmd-14-3383-2021">https://doi.org/10.5194/gmd-14-3383-2021</a>, 2021.</p></li>
</ul>
</section>
<section id="LSTM-model">
<h4><span class="section-number">1.5.4.5.13. </span>LSTM model<a class="headerlink" href="#LSTM-model" title="Permalink to this headline"></a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apos&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dbs</span><span class="p">[(</span><span class="n">dbs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s1">&#39;2019-06-20&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dbs</span><span class="p">[(</span><span class="n">dbs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s1">&#39;2019-06-20&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Hyltemossa&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">db</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(17905.958333333332, 18261.958333333332)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_66_1.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_66_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>

<span class="n">new_dbs</span> <span class="o">=</span> <span class="n">dbs</span><span class="p">[(</span><span class="n">dbs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s1">&#39;2019-06-20&#39;</span><span class="p">)]</span>

<span class="n">time_filled</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_dbs</span><span class="o">.</span><span class="n">time</span><span class="p">))):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">array</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_dbs</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_dbs</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">time_filled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="n">biosphere_apos_htm_nogap</span> <span class="o">=</span> <span class="n">biosphere_apos_htm</span><span class="p">[</span><span class="n">time_filled</span><span class="p">]</span>
<span class="n">fossil_apos_htm_nogap</span> <span class="o">=</span> <span class="n">fossil_apos_htm</span><span class="p">[</span><span class="n">time_filled</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 51.5 s, sys: 265 ms, total: 51.8 s
Wall time: 51.8 s
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">biosphere_apos_htm_nogap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">.5</span><span class="p">)</span>
<span class="n">val_size</span>   <span class="o">=</span> <span class="n">biosphere_apos_htm_nogap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">train_size</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xtest</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">biosphere_apos_htm_nogap</span><span class="p">,</span> <span class="n">biosphere_apos_htm_nogap</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
<span class="n">ytest</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">new_dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">),</span> <span class="n">array</span><span class="p">(</span><span class="n">new_dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">)[:</span><span class="n">train_size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">biosphere_apos_htm_nogap</span><span class="p">,</span> <span class="n">biosphere_apos_htm_nogap</span><span class="p">[</span><span class="n">train_size</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">standard</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">new_dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">),</span> <span class="n">array</span><span class="p">(</span><span class="n">new_dbs</span><span class="o">.</span><span class="n">mix_apos</span><span class="p">)[</span><span class="n">train_size</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[104]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">ns</span><span class="p">,</span><span class="n">tlen</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Parameters defining the mini-batch size and</span>
<span class="c1"># the sequence length for truncated BPTT</span>
<span class="n">mb</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">nmb</span> <span class="o">=</span> <span class="n">ns</span><span class="o">//</span><span class="n">mb</span>
<span class="n">batchlen</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">ntsteps</span> <span class="o">=</span> <span class="n">tlen</span><span class="o">//</span><span class="n">batchlen</span>

<span class="c1"># The network type</span>
<span class="c1"># net = SimpleRNN</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">GRU</span>
<span class="c1"># net = LSTM</span>

<span class="c1"># Number of hidden nodes in the first hidden layer</span>
<span class="n">nh1</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># This is only if you would like to add an additional hidden layer. See below.</span>
<span class="n">nh2</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># The activation function</span>
<span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;tanh&#39;</span>
<span class="c1"># activation = &#39;relu&#39;</span>

<span class="c1"># The number of epochs</span>
<span class="n">nE</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1">#Start defining the model</span>
<span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleting &quot;model&quot;&#39;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">model</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">nh1</span><span class="p">,</span>
              <span class="n">batch_input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">batchlen</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
              <span class="n">stateful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">))</span>

<span class="c1"># Uncomment this line if you want to add an additional hidden layer</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">net</span><span class="p">(</span><span class="n">nh2</span><span class="p">,</span>
              <span class="n">batch_input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">batchlen</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
              <span class="n">stateful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

<span class="n">adam</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.003</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">adam</span><span class="p">,</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Now the training part</span>
<span class="n">trnTrgVar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y</span><span class="p">[:,:])</span>        <span class="c1"># Variance for train target signal</span>
<span class="n">testTrgVar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">ytest</span><span class="p">[:,:])</span>   <span class="c1"># Variance for test target signal</span>
<span class="n">ndone</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;Time/Epoch&#39;</span><span class="p">,</span> <span class="s1">&#39; Train-Err&#39;</span><span class="p">,</span> <span class="s1">&#39;  Test-Err&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nE</span><span class="p">):</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">sumloss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmb</span><span class="p">):</span>
        <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">batch</span><span class="o">*</span><span class="n">mb</span><span class="p">,(</span><span class="n">batch</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mb</span>
        <span class="n">model</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tstep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntsteps</span><span class="p">):</span>
            <span class="n">t1</span><span class="p">,</span><span class="n">t2</span> <span class="o">=</span> <span class="n">tstep</span><span class="o">*</span><span class="n">batchlen</span><span class="p">,(</span><span class="n">tstep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">batchlen</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
            <span class="n">sumloss</span> <span class="o">+=</span> <span class="n">loss</span>
    <span class="n">meanloss</span> <span class="o">=</span> <span class="n">sumloss</span><span class="o">/</span><span class="p">(</span><span class="n">nmb</span><span class="o">*</span><span class="n">ntsteps</span><span class="p">)</span>

    <span class="c1"># Test error</span>
    <span class="n">sumlossvalid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmb</span><span class="p">):</span>
        <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">batch</span><span class="o">*</span><span class="n">mb</span><span class="p">,(</span><span class="n">batch</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mb</span>
        <span class="n">model</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tstep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntsteps</span><span class="p">):</span>
            <span class="n">t1</span><span class="p">,</span><span class="n">t2</span> <span class="o">=</span> <span class="n">tstep</span><span class="o">*</span><span class="n">batchlen</span><span class="p">,(</span><span class="n">tstep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">batchlen</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">xtest</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> <span class="n">ytest</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">,</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span><span class="n">batch_size</span><span class="o">=</span><span class="n">mb</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sumlossvalid</span> <span class="o">+=</span> <span class="n">loss</span>
    <span class="n">meanlossvalid</span> <span class="o">=</span> <span class="n">sumlossvalid</span><span class="o">/</span><span class="p">(</span><span class="n">nmb</span><span class="o">*</span><span class="n">ntsteps</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">ndone</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ndone</span><span class="p">,</span> <span class="s2">&quot;    </span><span class="si">{:.2f}</span><span class="s2">        </span><span class="si">{:.5f}</span><span class="s2">     </span><span class="si">{:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">,</span> <span class="n">meanloss</span><span class="o">/</span><span class="n">trnTrgVar</span><span class="p">,</span> <span class="n">meanlossvalid</span><span class="o">/</span><span class="n">testTrgVar</span><span class="p">))</span>


</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Deleting &#34;model&#34;
Model: &#34;sequential_17&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
gru_1 (GRU)                  (2, 50, 5)                120
_________________________________________________________________
gru_2 (GRU)                  (2, 50, 3)                90
_________________________________________________________________
time_distributed_17 (TimeDis (2, 50, 1)                4
=================================================================
Total params: 214
Trainable params: 214
Non-trainable params: 0
_________________________________________________________________
Epoch Time/Epoch  Train-Err   Test-Err
1     8.82        2.18668     1.49826
2     3.15        1.64169     1.53532
3     3.46        1.26127     1.57184
4     3.01        1.02113     1.60562
5     2.83        0.88291     1.63145
6     3.10        0.81232     1.64281
7     3.28        0.78065     1.63607
8     2.97        0.76629     1.61286
9     2.83        0.75655     1.57873
10     3.37        0.74653     1.53990
11     3.29        0.73561     1.50100
12     3.13        0.72454     1.46459
13     3.71        0.71399     1.43165
14     3.63        0.70435     1.40235
15     3.11        0.69578     1.37650
16     3.22        0.68828     1.35384
17     3.47        0.68177     1.33414
18     3.04        0.67611     1.31720
19     3.47        0.67112     1.30282
20     3.12        0.66665     1.29081
21     3.47        0.66258     1.28095
22     3.47        0.65880     1.27300
23     3.33        0.65523     1.26674
24     2.95        0.65184     1.26194
25     3.46        0.64859     1.25839
26     3.38        0.64545     1.25591
27     3.20        0.64241     1.25435
28     3.19        0.63945     1.25357
29     3.58        0.63657     1.25347
30     3.43        0.63376     1.25394
31     3.60        0.63102     1.25493
32     3.87        0.62833     1.25635
33     4.11        0.62571     1.25817
34     3.44        0.62313     1.26033
35     3.29        0.62060     1.26279
36     3.07        0.61810     1.26550
37     3.61        0.61564     1.26843
38     3.53        0.61318     1.27154
39     3.16        0.61073     1.27479
40     3.19        0.60826     1.27815
41     3.64        0.60575     1.28158
42     3.30        0.60320     1.28504
43     3.32        0.60056     1.28852
44     3.49        0.59782     1.29200
45     2.72        0.59494     1.29544
46     3.49        0.59188     1.29885
47     3.16        0.58859     1.30220
48     3.73        0.58500     1.30550
49     3.37        0.58105     1.30874
50     3.49        0.57663     1.31192
51     3.57        0.57162     1.31506
52     3.48        0.56593     1.31818
53     3.44        0.55955     1.32139
54     3.28        0.55279     1.32489
55     3.55        0.54666     1.32913
56     3.22        0.54281     1.33476
57     3.51        0.54144     1.34222
58     3.39        0.53938     1.35094
59     3.28        0.53437     1.35941
60     2.91        0.52814     1.36638
61     3.31        0.52253     1.37165
62     3.14        0.51835     1.37575
63     3.22        0.51359     1.37953
64     3.56        0.51248     1.38299
65     3.80        0.50268     1.38760
66     3.81        0.52437     1.39027
67     3.43        0.56124     1.41232
68     2.93        0.54031     1.43148
69     3.06        0.53363     1.41749
70     3.22        0.52108     1.40265
71     3.56        0.49672     1.39267
72     3.22        0.49561     1.38081
73     4.29        0.50230     1.38312
74     3.23        0.54482     1.39098
75     3.30        0.52376     1.38926
76     3.45        0.57464     1.41002
77     3.44        0.50423     1.43052
78     3.34        0.51539     1.41246
79     4.05        0.49421     1.38920
80     3.00        0.48073     1.37629
81     3.45        0.48636     1.37103
82     3.31        0.49812     1.37980
83     3.43        0.53177     1.38889
84     3.96        0.49725     1.38593
85     4.08        0.55637     1.40708
86     3.32        0.50200     1.42577
87     3.26        0.50539     1.40428
88     3.37        0.50172     1.38786
89     3.70        0.48809     1.38009
90     3.70        0.48630     1.36921
91     3.48        0.52163     1.38221
92     2.91        0.50409     1.39597
93     3.54        0.49802     1.38396
94     3.75        0.51307     1.38567
95     3.36        0.49323     1.39106
96     3.44        0.49491     1.37772
97     3.48        0.48908     1.37075
98     3.40        0.47400     1.37419
99     3.34        0.47474     1.37405
100     3.44        0.47399     1.37678
CPU times: user 47min 7s, sys: 1h 26min 21s, total: 2h 13min 29s
Wall time: 5min 44s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[105]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xshow</span> <span class="o">=</span> <span class="n">xtest</span><span class="p">[:</span><span class="n">mb</span><span class="p">]</span>
<span class="n">yshow</span> <span class="o">=</span> <span class="n">ytest</span><span class="p">[:</span><span class="n">mb</span><span class="p">]</span>
<span class="n">yout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mb</span><span class="p">,</span><span class="n">tlen</span><span class="p">))</span>
<span class="n">hidden1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mb</span><span class="p">,</span><span class="n">tlen</span><span class="p">,</span><span class="n">nh1</span><span class="p">))</span>
<span class="n">hidden2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mb</span><span class="p">,</span><span class="n">tlen</span><span class="p">,</span><span class="n">nh2</span><span class="p">))</span>

<span class="n">rnn1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rnn2</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">#dense = model.layers[-1]</span>
<span class="c1">#sign = K.sign(dense.layer.kernel)[None,None,:,0]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">:</span>
    <span class="n">intermediate</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">rnn1</span><span class="o">.</span><span class="n">input</span><span class="p">],</span> <span class="p">[</span><span class="n">rnn1</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">rnn2</span><span class="o">.</span><span class="n">output</span> <span class="p">])</span>
<span class="k">else</span> <span class="p">:</span>
    <span class="n">intermediate</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">rnn1</span><span class="o">.</span><span class="n">input</span><span class="p">],</span> <span class="p">[</span><span class="n">rnn1</span><span class="o">.</span><span class="n">output</span><span class="p">])</span>

<span class="k">for</span> <span class="n">tstep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntsteps</span><span class="p">):</span>
    <span class="n">t1</span><span class="p">,</span><span class="n">t2</span> <span class="o">=</span> <span class="n">tstep</span><span class="o">*</span><span class="n">batchlen</span><span class="p">,(</span><span class="n">tstep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">batchlen</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">xshow</span><span class="p">[:,</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">:</span>
        <span class="n">hi</span><span class="p">,</span><span class="n">hi2</span> <span class="o">=</span> <span class="n">intermediate</span><span class="p">([</span><span class="n">inp</span><span class="p">])</span>
        <span class="n">hidden2</span><span class="p">[:,</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">hi2</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">hi</span><span class="p">,</span> <span class="o">=</span> <span class="n">intermediate</span><span class="p">([</span><span class="n">inp</span><span class="p">])</span>
    <span class="n">hidden1</span><span class="p">[:,</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">hi</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xshow</span><span class="p">[:,</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
    <span class="n">yout</span><span class="p">[:,</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">]</span> <span class="o">=</span> <span class="n">yi</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tlen</span><span class="p">)</span>

<span class="c1"># Selection of test sequnce. i=0 is rather easy, i=1 is a difficult one</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">xshow</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Training, input sequence&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">yshow</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">yout</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Test, target sequnce&#39;</span><span class="p">,</span> <span class="s1">&#39;Test, predicted sequence&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">hidden1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hidden 1 node outputs&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">hidden2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hidden 2 node outputs&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                    tensorflow | WARNING  (line 113) | 5 out of the last 33 calls to &lt;function Model.make_predict_function.&lt;locals&gt;.predict_function at 0x7faae825be50&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_71_1.png" src="../../_images/STUDENTSPROJECTS_Proj_2021_SW_Carlos_Gómez-Ortiz_GeocomputationProject_71_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Alexandra_Pongr%C3%A1cz_project_idea.html" class="btn btn-neutral float-left" title="1.4. Statistical comparison global gridded climate datasets and their influence on LPJ-GUESS model outputs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Felicity_Alice_Holmes_Geocomp_project.html" class="btn btn-neutral float-right" title="1.6. Processing Elmer/Ice output" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Giuseppe Amatulli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>